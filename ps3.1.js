<<<<<<< HEAD
var PS;(function(){var _OUTER_ID="outer";var _MAIN_ID="main";var _DEBUG_ID="debug";var _STATUS_ID="status";var _GRID_ID="grid";var _FOOTER_ID="footer";var _MONITOR_ID="monitor";var _LOGIN_ID="login";var _LOGIN_EMAIL_ID="login_em";var _LOGIN_PW1_ID="login_pw1";var _LOGIN_PW2_ID="login_pw2";var _LOGIN_BUT_ID="login_but";var _LOGIN_SIGNUP_ID="login_su";var _LOGIN_RECOVER_ID="login_re";var _IMAGE_PREFIX="image_";var _SPRITE_PREFIX="sprite_";var _PATHMAP_PREFIX="pathmap_";var _TIMER_PREFIX="timer_";var _CLIENT_SIZE=512;var _ALPHOID=1/255;var _RSHIFT=256*256;var _GSHIFT=256;var _MAX_BEADS=1024;var _EMPTY={};var _DEFAULT_KEY_DELAY=6;var _KEY_SHIFT=16;var _KEY_CTRL=17;var _CLEAR=-1;var _FADER_FPS=4;var _DIAGONAL_COST=1.4142;var _PIANO_FILES=["a0","bb0","b0","c1","db1","d1","eb1","e1","f1","gb1","g1","ab1","a1","bb1","b1","c2","db2","d2","eb2","e2","f2","gb2","g2","ab2","a2","bb2","b2","c3","db3","d3","eb3","e3","f3","gb3","g3","ab3","a3","bb3","b3","c4","db4","d4","eb4","e4","f4","gb4","g4","ab4","a4","bb4","b4","c5","db5","d5","eb5","e5","f5","gb5","g5","ab5","a5","bb5","b5","c6","db6","d6","eb6","e6","f6","gb6","g6","ab6","a6","bb6","b6","c7","db7","d7","eb7","e7","f7","gb7","g7","ab7","a7","bb7","b7","c8"];var _HCHORD_FILES=["a2","bb2","b2","c3","db3","d3","eb3","e3","f3","gb3","g3","ab3","a3","bb3","b3","c4","db4","d4","eb4","e4","f4","gb4","g4","ab4","a4","bb4","b4","c5","db5","d5","eb5","e5","f5","gb5","g5","ab5","a5","bb5","b5","c6","db6","d6","eb6","e6","f6","gb6","g6","ab6","a6","bb6","b6","c7","db7","d7","eb7","e7","f7"];var _XYLO_FILES=["a4","bb4","b4","c5","db5","d5","eb5","e5","f5","gb5","g5","ab5","a5","bb5","b5","c6","db6","d6","eb6","e6","f6","gb6","g6","ab6","a6","bb6","b6","c7","db7","d7","eb7","e7","f7","gb7","g7","ab7","a7","bb7","b7"];var _DEFAULTS={grid:{x:8,y:8,max:32,plane:0,color:{r:255,g:255,b:255,a:255,rgb:16777215,str:"rgba(255,255,255,1)"},padLeft:0,padRight:0,ready:false},status:{text:"",color:{r:0,g:0,b:0,a:255,rgb:0,str:"rgba(0,0,0,1)"}},fader:{rate:0,rgb:null,onEnd:null,params:null},bead:{dirty:true,active:true,visible:true,planes:null,color:{r:255,g:255,b:255,a:255,rgb:16777215,str:"rgba(255,255,255,1)"},radius:0,scale:100,data:0,exec:null,border:{width:1,equal:true,top:1,left:1,bottom:1,right:1,color:{r:128,g:128,b:128,a:255,rgb:8421504,str:"rgba(128,128,128,1)"}},glyph:{str:"",code:0,scale:100,size:0,x:0,y:0,font:null,color:{r:0,g:0,b:0,a:255,rgb:0,str:"rgba(0,0,0,1)"}}},audio:{volume:0.5,max_volume:1,path:"http://users.wpi.edu/~bmoriarty/ps/audio/",loop:false,error_sound:"fx_uhoh"}};var _system={engine:"Perlenspiel",major:3,minor:1,revision:1,host:{app:"Unknown App",version:"?",os:"Unknown OS"},inputs:{touch:false}};var _RSTR,_GBSTR,_BASTR,_ASTR;var _main;var _grid;var _beads;var _status;var _anyDirty=false;var _imageCanvas;var _imageList;var _imageCnt;var _sprites;var _spriteCnt;var _clockActive;var _timers;var _timerCnt;var _faders;var _faderTick;var _transKeys;var _shiftedKeys;var _unshiftedKeys;var _pressed;var _holding;var _holdShift;var _holdCtrl;var _keyRepeat;var _keyDelay;var _keyDelayRate;var _keyInitRate;var _touchScreen;var _deviceScaling;var _currentFinger;var _underBead;var _overGrid;var _lastBead=-1;var _debugging;var _debugFocus;var _footer;var _errorSound;var _pathmaps;var _pathmapCnt;function _typeOf(value){var type;type=typeof value;if(type==="number"){if(isNaN(value)){type="NaN";}}else{if(type==="object"){if(value){if(value instanceof Array){type="array";}}else{type="null";}}}return type;}function _isBoolean(valP,currentVal,defaultVal,undefinedVal){var val,type;val=valP;if((val!==true)&&(val!==false)){if(val===null){val=false;}else{if(val===PS.CURRENT){val=currentVal;}else{if(val===PS.DEFAULT){val=defaultVal;}else{type=_typeOf(val);if(type==="undefined"){val=undefinedVal;}else{if(type==="number"){val=(val!==0);}else{val=PS.ERROR;}}}}}}return val;}function _copy(src,dest){var prop,item,obj,type;for(prop in src){if(src.hasOwnProperty(prop)){item=src[prop];type=_typeOf(item);if(type==="object"){obj={};_copy(item,obj);item=obj;}dest[prop]=item;}}}function _endEvent(event){if(event.stopPropagation){event.stopPropagation();}else{event.cancelBubble=true;}event.preventDefault();return false;}function _newCodePoint(){var chars,i,point,offset,units;chars=[];for(i=0;i<arguments.length;i+=1){point=arguments[i];offset=point-65536;units=point>65535?[55296+(offset>>10),56320+(offset&1023)]:[point];chars.push(String.fromCharCode.apply(null,units));}return chars.join("");}function _drawBead(bead,borderColor,beadColor,glyphColor,gridColor){var ctx,size,left,top,width,height,border,radius,curve;ctx=_grid.context;size=_grid.bead_size;left=bead.left;top=bead.top;width=size;height=size;border=bead.border;radius=bead.radius;if((bead.size<size)||(radius>0)||((border.width>0)&&(border.color.a<255))||!bead.visible){ctx.fillStyle=gridColor;ctx.fillRect(left,top,width,height);if(!bead.visible){return;}left+=bead.margin;top+=bead.margin;width=bead.size;height=bead.size;}if(border.width>0){ctx.fillStyle=borderColor;if(!radius){ctx.fillRect(left,top,width,height);}else{curve=Math.floor((width*radius)/100);curve=ctx.fillRoundedRect(left,top,width,height,curve);}left+=border.left;top+=border.top;width-=(border.left+border.right);height-=(border.top+border.bottom);}ctx.fillStyle=beadColor;if(!radius){ctx.fillRect(left,top,width,height);}else{curve=Math.floor((width*radius)/100);ctx.fillRoundedRect(left,top,width,height,curve);}if(bead.glyph.code>0){_grid.context.font=bead.glyph.font;ctx.fillStyle=glyphColor;ctx.fillText(bead.glyph.str,bead.left+bead.glyph.x,bead.top+bead.glyph.y);}}function _colorBlendAlpha(c0,c1){var alphaCover,result;alphaCover=c0.a*(1-c1.a);result={r:Math.floor((c1.r*c1.a)+(c0.r*alphaCover)),g:Math.floor((c1.g*c1.a)+(c0.g*alphaCover)),b:Math.floor((c1.b*c1.a)+(c0.b*alphaCover))};return result;}function _calcColor(bead,backColor,target){var pr,pg,pb,planes,len,i,color,level,r,g,b,a,beadAlpha,c0,c1,colorResult;pr=backColor.r;pg=backColor.g;pb=backColor.b;planes=bead.planes;len=planes.length;for(i=0;i<len;i+=1){level=planes[i];color=level.color;r=color.r;g=color.g;b=color.b;a=color.a;if(a>0){if(a<255){beadAlpha=Math.max(0,Math.min((a/255),1));c0={r:pr,g:pg,b:pb,a:1};c1={r:r,g:g,b:b,a:beadAlpha};colorResult=_colorBlendAlpha(c0,c1);pr=colorResult.r;pg=colorResult.g;pb=colorResult.b;}else{pr=r;pg=g;pb=b;}}}r=pr;g=pg;b=pb;target.rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;target.r=r;target.g=g;target.b=b;target.str=_RSTR[r]+_GBSTR[g]+_BASTR[b];}var _bcolor={rgb:0,r:0,g:0,b:0,str:""};function _gridRGB(data){var str,canvas,context,i,bead,level,color,beadColor,borderColor;str=data.str;canvas=_grid.canvas;context=_grid.context;canvas.backgroundColor=str;if(_grid.left>0){context.clearRect(0,_grid.top,_grid.left,canvas.height);}if(_grid.right<canvas.width){context.clearRect(_grid.right,_grid.top,canvas.width-_grid.right,canvas.height);}if(_grid.bottom<canvas.height){context.clearRect(0,_grid.bottom,canvas.width,canvas.height-_grid.bottom);}document.body.style.backgroundColor=str;_status.div.style.backgroundColor=str;_footer.style.backgroundColor=str;for(i=0;i<_grid.count;i+=1){bead=_beads[i];level=bead.planes[0];color=level.color;if(color.a<255){_calcColor(bead,data,_bcolor);beadColor=_bcolor.str;}else{beadColor=bead.color.str;}borderColor=bead.border.color;if(!bead.visible||(bead.size<_grid.bead_size)||(bead.radius>0)||(color.a<255)||(borderColor.a<255)){_drawBead(bead,borderColor.str,beadColor,bead.glyph.color.str,str);}}}function _gridRGBEnd(data){var r,g,b;if(data.r>127){r=0;}else{r=255;}if(data.g>127){g=0;}else{g=255;}if(data.b>127){b=0;}else{b=255;}_footer.style.color=_RSTR[r]+_GBSTR[g]+_BASTR[b];}function _statusRGB(data){_status.div.style.color=data.str;}function _beadRGBA(data,element){var bead;bead=_beads[element];_drawBead(bead,bead.border.color.str,data.str,bead.glyph.color.str,_grid.color.str);}function _borderRGBA(data,element){var bead;bead=_beads[element];_drawBead(bead,data.str,bead.color.str,bead.glyph.color.str,_grid.color.str);}function _glyphRGBA(data,element){var bead;bead=_beads[element];_drawBead(bead,bead.border.color.str,bead.color.str,data.str,_grid.color.str);}function _makeDirty(bead){bead.dirty=true;_anyDirty=true;}function _gridDraw(){var len,i,bead;if(_anyDirty){len=_grid.count;for(i=0;i<len;i+=1){bead=_beads[i];if(bead.dirty){bead.dirty=false;_drawBead(bead,bead.border.color.str,bead.color.str,bead.glyph.color.str,_grid.color.str);}}_anyDirty=false;}}function _debugOpen(){var e;if(!_debugging){e=document.getElementById(_DEBUG_ID);e.style.display="inline";e=document.getElementById(_MONITOR_ID);e.value="";_debugging=true;_debugFocus=false;}}function _warning(str){if((typeof str!=="string")||(str.length<1)){str="???";}PS.debug("WARNING: "+str+"\n");}var _DEBUG_STACK=true;var _DEBUG_HTML=false;function _decodeStackLine(str){var text,index,name;text="";if(str.search(".js")!==-1){index=str.lastIndexOf("/")+1;name=str.substr(index).replace(/^[\s\(\)]+|[\s\(\)]+$/g,"");if(name.split(":").length===3){name=name.substr(0,name.lastIndexOf(":"));}if(name!==""){text+=("    "+name+"\n");}}else{if(_DEBUG_HTML&&(str.search(".htm")!==-1)){text+=("\n"+str);}}return text;}function _decodeCallstack(str){var lines,len,i,text;if(console&&console.log){console.log(str);}if(!str.split){return str;}lines=str.split("\n");text="";len=lines.length;for(i=0;i<len;i+=1){text+=_decodeStackLine(lines[i]);}return text;}function _errorCatch(message,err){var str;_clockActive=false;if((typeof message!=="string")||(message.length<1)){message="???";}str="ERROR: "+message+"\n";_footer.innerHTML=str;if(_DEBUG_STACK&&err){str+=(_decodeCallstack(err.stack)+"\n");}PS.debug(str);if(_errorSound){PS.audioPlay(_DEFAULTS.audio.error_sound,{path:_DEFAULTS.audio.path});}return PS.ERROR;}function _error(message){try{throw (new Error("!"));}catch(err){return _errorCatch(message,err);}}function _scrollDown(){var e;e=document.getElementById(_MAIN_ID);e.scrollTop=e.scrollHeight;}function _initFaders(){_faders=[];_faderTick=0;}function _resetFader(fader){var def;def=_DEFAULTS.fader;fader.active=false;fader.kill=false;fader.rate=def.rate;fader.rgb=def.rgb;fader.onEnd=def.onEnd;fader.params=def.params;fader.r=0;fader.g=0;fader.b=0;fader.step=0;fader.frames.length=0;}function _newFader(element,exec,execEnd){var fader;fader={element:element,exec:exec,execEnd:execEnd,frames:[]};_resetFader(fader);return fader;}function _calcFader(fader,r,g,b,a,tr,tg,tb,ta){var cr,cg,cb,ca,cnt,step,percent,frame,r_delta,g_delta,b_delta,a_delta,any,delta;fader.step=0;fader.frames.length=0;if((r===tr)&&(g===tg)&&(b===tb)&&(a===ta)){return;}cr=r;cg=g;cb=b;ca=a;if(r>tr){r_delta=-(r-tr);}else{r_delta=tr-r;}if(g>tg){g_delta=-(g-tg);}else{g_delta=tg-g;}if(b>tb){b_delta=-(b-tb);}else{b_delta=tb-b;}if(a>ta){a_delta=-(a-ta);}else{a_delta=ta-a;}if(fader.rate<_FADER_FPS){cnt=1;}else{cnt=Math.ceil(fader.rate/_FADER_FPS);}step=100/cnt;percent=0;do{any=false;frame={};percent+=step;if(percent>=100){frame.r=tr;frame.g=tg;frame.b=tb;frame.a=ta;}else{if(cr!==tr){delta=(percent*r_delta)/100;cr=r+delta;cr=Math.round(cr);any=true;}frame.r=cr;if(cg!==tg){delta=(percent*g_delta)/100;cg=g+delta;cg=Math.round(cg);any=true;}frame.g=cg;if(cb!==tb){delta=(percent*b_delta)/100;cb=b+delta;cb=Math.round(cb);any=true;}frame.b=cb;if(ca!==ta){delta=(percent*a_delta)/100;ca=a+delta;ca=Math.round(ca);any=true;}frame.a=ca;}frame.rgb=(frame.r*_RSHIFT)+(frame.g*_GSHIFT)+frame.b;frame.str=_RSTR[frame.r]+_GBSTR[frame.g]+_GBSTR[frame.b]+_ASTR[frame.a];fader.frames.push(frame);if(!any){return;}}while(percent<100);}function _startFader(fader,r,g,b,a,tr,tg,tb,ta){_calcFader(fader,r,g,b,a,tr,tg,tb,ta);if(fader.frames.length>0){fader.kill=false;fader.active=true;_faders.push(fader);}}function _recalcFader(fader,tr,tg,tb,ta){var restart,len,step,frame;restart=fader.active;fader.active=false;len=fader.frames.length;if(len>0){step=fader.step;if(step>=len){step=len-1;}frame=fader.frames[step];_calcFader(fader,frame.r,frame.g,frame.b,frame.a,tr,tg,tb,ta);}if(fader.frames.length>0){fader.active=restart;}}function _initTimers(){_timers=[];_timerCnt=0;}function _tick(){var fn,len,i,fader,frame,key,timer,result,exec,id,params;fn="[_tick] ";_faderTick+=1;if(_faderTick>=_FADER_FPS){_faderTick=0;len=_faders.length;i=0;while(i<len){fader=_faders[i];if(fader.kill){_faders.splice(i,1);len-=1;}else{if(fader.active){frame=fader.frames[fader.step];if(fader.exec){try{fader.exec(frame,fader.element);}catch(e3){_errorCatch(fn+"fader .exec failed ["+e3.message+"]",e3);return;}}fader.step+=1;if(fader.step>=fader.frames.length){fader.active=false;fader.step=0;fader.frames.length=0;if(fader.execEnd){try{fader.execEnd(frame,fader.element);}catch(e4){_errorCatch(fn+"fader .execEnd failed ["+e4.message+"]",e4);return;}}exec=fader.onEnd;if(exec){params=fader.params;if(!params){params=[];}try{exec.apply(_EMPTY,params);}catch(e5){_errorCatch(fn+"fader .onEnd failed ["+e5.message+"]",e5);return;}}_faders.splice(i,1);len-=1;}else{i+=1;}}else{i+=1;}}}}len=_holding.length;if(_keyRepeat&&(len>0)){if(_keyDelay>0){_keyDelay-=1;}else{_keyDelay=_keyDelayRate;for(i=0;i<len;i+=1){key=_holding[i];if(key){try{PS.keyDown(key,_holdShift,_holdCtrl);}catch(e6){_errorCatch(fn+"Key repeat failed ["+e6.message+"]",e6);return;}}}}}len=_timers.length;if(len>0){i=0;while(i<len){timer=_timers[i];id=timer.id;timer.count-=1;if(timer.count<1){timer.count=timer.delay;try{result=timer.exec.apply(_EMPTY,timer.arglist);}catch(e7){result=_errorCatch(fn+"Timed function failed ["+e7.message+"]",e7);}if(result===PS.ERROR){PS.timerStop(id);}len=_timers.length;}timer=_timers[i];if(timer&&(timer.id===id)){i+=1;}}_gridDraw();}}var _target={rgb:0,r:0,g:0,b:0,str:""};function _recolor(bead){var rgb,current,r,g,b,pr,pg,pb,fader;_calcColor(bead,_grid.color,_target);rgb=_target.rgb;current=bead.color;r=_target.r;g=_target.g;b=_target.b;pr=current.r;pg=current.g;pb=current.b;current.rgb=rgb;current.r=r;current.g=g;current.b=b;current.str=_target.str;if(bead.visible){fader=bead.fader;if(fader.rate>0){if(fader.rgb!==null){_startFader(fader,fader.r,fader.g,fader.b,255,r,g,b,255);}else{if(!fader.active){_startFader(fader,pr,pg,pb,255,r,g,b,255);}else{_recalcFader(fader,r,g,b,255);}}}else{_makeDirty(bead);}}}function _validColors(fn,colors,redP,greenP,blueP){var red,green,blue,type;red=redP;if((red!==PS.CURRENT)&&(red!==PS.DEFAULT)){type=_typeOf(red);if(type==="undefined"){red=PS.CURRENT;}else{if(type==="number"){red=Math.floor(red);if(red<0){red=0;}else{if(red>255){red=255;}}}else{return _error(fn+"red value invalid");}}}green=greenP;if((green!==PS.CURRENT)&&(green!==PS.DEFAULT)){type=_typeOf(green);if(type==="undefined"){green=PS.CURRENT;}else{if(type==="number"){green=Math.floor(green);if(green<0){green=0;}else{if(green>255){green=255;}}}else{return _error(fn+"green value invalid");}}}blue=blueP;if((blue!==PS.CURRENT)&&(blue!==PS.DEFAULT)){type=_typeOf(blue);if(type==="undefined"){blue=PS.CURRENT;}else{if(type==="number"){blue=Math.floor(blue);if(blue<0){blue=0;}else{if(blue>255){blue=255;}}}else{return _error(fn+"blue value invalid");}}}colors.rgb=null;colors.r=red;colors.g=green;colors.b=blue;return PS.DONE;}function _extractRGB(colors,rgbP){var rgb,red,rval,green,gval,blue;rgb=Math.floor(rgbP);if(rgb<1){rgb=red=green=blue=0;}else{if(rgb>=16777215){rgb=16777215;red=green=blue=255;}else{red=rgb/_RSHIFT;red=Math.floor(red);rval=red*_RSHIFT;green=(rgb-rval)/_GSHIFT;green=Math.floor(green);gval=green*_GSHIFT;blue=rgb-rval-gval;}}colors.rgb=rgb;colors.r=red;colors.g=green;colors.b=blue;}var _decoded={rgb:0,r:null,g:null,b:null,str:""};function _decodeColors(fn,p1,p2,p3){var colors,type,result,rgb,len;colors=_decoded;colors.rgb=0;colors.r=null;colors.g=null;colors.b=null;colors.str="";type=_typeOf(p1);if((p2!==undefined)||(p3!==undefined)){if((type==="number")||(type==="undefined")||(p1===PS.CURRENT)||(p1===PS.DEFAULT)){result=_validColors(fn,colors,p1,p2,p3);if(result===PS.ERROR){return PS.ERROR;}}else{if(type==="array"){return _error(fn+"Extraneous arguments after color array");}if(type==="object"){return _error(fn+"Extraneous arguments after color object");}return _error(fn+"red argument invalid");}}else{if(type==="number"){_extractRGB(colors,p1);}else{if(type==="array"){len=p1.length;if(len<1){colors.rgb=PS.CURRENT;}else{result=_validColors(fn,colors,p1[0],p1[1],p1[2]);if(result===PS.ERROR){return PS.ERROR;}}}else{if(type==="object"){rgb=p1.rgb;type=_typeOf(rgb);if((type==="undefined")||(rgb===null)){result=_validColors(fn,colors,p1.r,p1.g,p1.b);if(result===PS.ERROR){return PS.ERROR;}}else{if(type==="number"){_extractRGB(colors,rgb);}else{if((rgb===PS.CURRENT)||(rgb===PS.DEFAULT)){colors.rgb=rgb;}else{return _error(fn+".rgb property invalid");}}}}else{if((type==="undefined")||(p1===PS.CURRENT)){colors.rgb=PS.CURRENT;}else{if(p1===PS.DEFAULT){colors.rgb=PS.DEFAULT;}else{return _error(fn+"color argument invalid");}}}}}}return colors;}function _rescaleGlyph(bead){var bsize,nsize,scale;bsize=_grid.bead_size;bead.glyph.x=Math.floor(bsize/2);scale=bead.glyph.scale;if(scale<100){nsize=Math.floor((bsize*scale)/100);}else{nsize=bsize;}bead.glyph.size=Math.floor(nsize/2);bead.glyph.font=bead.glyph.size+"pt sans-serif";bead.glyph.y=Math.floor((bsize-nsize)/2)+Math.floor((nsize/7)*4);}function _resetBead(bead){var color;_copy(_DEFAULTS.bead,bead);color={};_copy(_DEFAULTS.bead.color,color);bead.planes=[{height:0,color:color}];_rescaleGlyph(bead);_resetFader(bead.fader);_resetFader(bead.borderFader);_resetFader(bead.glyphFader);}function _colorPlane(bead,plane){var planes,level,len,i,color,def;planes=bead.planes;if(plane<1){level=planes[0];return level.color;}len=planes.length;for(i=1;i<len;i+=1){level=planes[i];if(level.height===plane){return level.color;}}def=_DEFAULTS.bead.color;color={rgb:def.rgb,r:def.r,g:def.g,b:def.b,a:0};if(bead.active){i=0;while(i<len){level=planes[i];if(level.height>plane){break;}i+=1;}planes.splice(i,0,{height:plane,color:color});}return color;}function _borderMax(bead){if(bead.glyph.code>0){return bead.border.gmax;}return bead.border.max;}function _equalBorder(bead,w){bead.border.equal=true;bead.border.width=w;bead.border.top=w;bead.border.left=w;bead.border.bottom=w;bead.border.right=w;}function _rescale(bead){var bsize,size,diff,margin,max,val,border;bsize=_grid.bead_size;if(bead.scale<100){size=Math.floor((bsize*bead.scale)/100);diff=bsize-size;if((diff>0)&&(diff%2)){size+=1;}}else{size=bsize;bead.margin=0;bead.senseLeft=bead.left;bead.senseRight=bead.right;bead.senseTop=bead.top;bead.senseBottom=bead.bottom;}bead.size=size;if(size!==bsize){bead.margin=margin=Math.floor((bsize-size)/2);bead.senseLeft=bead.left+margin;bead.senseRight=bead.right-margin;bead.senseTop=bead.top+margin;bead.senseBottom=bead.bottom-margin;}border=bead.border;border.max=Math.floor((size-8)/2);border.gmax=Math.floor((size-bead.glyph.size)/2);max=_borderMax(bead);if(border.equal){if(border.width>max){_equalBorder(bead,max);}}else{val=border.top;if(val>max){border.top=max;}val=border.left;if(val>max){border.left=max;}val=border.bottom;if(val>max){border.bottom=max;}val=border.right;if(val>max){border.right=max;}}}function _getData(bead){var data;data=bead.data;if(data===null){data=0;}return data;}function _touchBead(bead){var data,any;if(bead.active){any=false;data=_getData(bead);if(bead.exec){try{bead.exec(bead.x,bead.y,data,_EMPTY);any=true;}catch(e1){return _errorCatch("Bead "+bead.x+", "+bead.y+" function failed ["+e1.message+"]",e1);}}if(PS.touch){try{PS.touch(bead.x,bead.y,data,_EMPTY);any=true;}catch(e2){return _errorCatch("PS.touch() failed ["+e2.message+"]",e2);}}if(any){_gridDraw();}}return PS.DONE;}function _releaseBead(bead){var data;if(bead.active){if(PS.release){data=_getData(bead);try{PS.release(bead.x,bead.y,data,_EMPTY);_gridDraw();}catch(err){return _errorCatch("PS.release() failed ["+err.message+"]",err);}}}return PS.DONE;}function _enterBead(bead){var data;_overGrid=true;if(bead.active){if(PS.enter){data=_getData(bead);try{PS.enter(bead.x,bead.y,data,_EMPTY);_gridDraw();}catch(err){return _errorCatch("PS.enter() failed ["+err.message+"]",err);}}}return PS.DONE;}function _exitBead(bead){var data;if(bead.active){if(PS.exit){data=_getData(bead);try{PS.exit(bead.x,bead.y,data,_EMPTY);_gridDraw();}catch(err){return _errorCatch("PS.exit() failed ["+err.message+"]",err);}}}return PS.DONE;}function _exitGrid(){_overGrid=false;if(PS.exitGrid){try{PS.exitGrid(_EMPTY);_gridDraw();}catch(err){return _errorCatch("PS.exitGrid() failed ["+err.message+"]",err);}}return PS.DONE;}function _resetCursor(){_lastBead=-1;}function _getBead(x,y){var canvas,bead,i,j;canvas=_grid.canvas;x+=(document.body.scrollLeft+document.documentElement.scrollLeft-canvas.offsetLeft-_grid.padLeft);y+=(document.body.scrollTop+document.documentElement.scrollTop-canvas.offsetTop-_grid.padRight);if((x>=_grid.left)&&(x<_grid.right)&&(y>=_grid.top)&&(y<_grid.bottom)){i=0;while(i<_grid.count){bead=_beads[i];if((y>=bead.top)&&(y<bead.bottom)){for(j=0;j<_grid.x;j+=1){if((x>=bead.senseLeft)&&(x<bead.senseRight)&&(y>=bead.senseTop)&&(y<bead.senseBottom)){return bead;}i+=1;bead=_beads[i];}return null;}i+=_grid.x;}}return null;}function _mouseDown(event){var x,y,bead;if(event.x&&event.y){x=event.x;y=event.y;}else{x=event.clientX;y=event.clientY;}bead=_getBead(x,y);if(bead){_touchBead(bead);}return _endEvent(event);}function _mouseUp(event){var x,y,bead;if(event.x&&event.y){x=event.x;y=event.y;}else{x=event.clientX;y=event.clientY;}bead=_getBead(x,y);if(bead){_releaseBead(bead);}return _endEvent(event);}function _mouseMove(event){var x,y,bead,obead;if(event.x&&event.y){x=event.x;y=event.y;}else{x=event.clientX;y=event.clientY;}bead=_getBead(x,y);if(bead){if(bead.index!==_lastBead){if(_lastBead>=0){obead=_beads[_lastBead];_exitBead(obead);}_enterBead(bead);_lastBead=bead.index;}}else{if(_lastBead>=0){obead=_beads[_lastBead];_exitBead(obead);_lastBead=-1;}}return _endEvent(event);}function _gridOut(event){var bead,target;if(_lastBead>=0){bead=_beads[_lastBead];_exitBead(bead);_lastBead=-1;}target=event.relatedTarget;if(target){target=target.id;if(target&&((target===_OUTER_ID)||(target===_MAIN_ID)||(target.length<1))){_exitGrid();}}return _endEvent(event);}function _touchStart(event){var xpos,ypos,touch,bead;if(_currentFinger!==_CLEAR){return _endEvent(event);}touch=event.changedTouches[0];_currentFinger=touch.identifier;xpos=touch.pageX;ypos=touch.pageY;bead=_getBead(xpos,ypos);if(bead){_overGrid=true;_underBead=bead.index;_touchBead(bead);}else{_underBead=_CLEAR;_overGrid=false;}return _endEvent(event);}function _touchEnd(event){var len,i,touch,finger,xpos,ypos,bead;len=event.changedTouches.length;for(i=0;i<len;i+=1){touch=event.changedTouches[i];finger=touch.identifier;if(finger===_currentFinger){_currentFinger=_CLEAR;_underBead=_CLEAR;_overGrid=false;xpos=touch.pageX;ypos=touch.pageY;bead=_getBead(xpos,ypos);if(bead){_releaseBead(bead);}break;}}return _endEvent(event);}function _touchMove(event){var len,i,touch,finger,xpos,ypos,bead,obead;len=event.changedTouches.length;for(i=0;i<len;i+=1){touch=event.changedTouches[i];finger=touch.identifier;if(finger===_currentFinger){xpos=touch.pageX;ypos=touch.pageY;bead=_getBead(xpos,ypos);if(bead){_overGrid=true;if(_underBead!==bead.index){if(_underBead!==_CLEAR){obead=_beads[_underBead];_exitBead(obead);}_underBead=bead.index;_enterBead(bead);}}else{if(_underBead!==_CLEAR){obead=_beads[_underBead];_exitBead(obead);}_underBead=_CLEAR;if(_overGrid){_exitGrid();}}break;}}return _endEvent(event);}function _keyFilter(key,shift){var val;val=key;if((val>=65)&&(val<=90)){if(!shift){val+=32;}}else{val=_transKeys[val];if(shift&&(val<256)){val=_shiftedKeys[val];}}return val;}function _legalKey(key){return((key>=32)||(key===13)||(key===8)||(key===9)||(key===27));}function _keyDown(event){var fn,any,hardkey,key,len,i;fn="[_keyDown] ";any=false;if(_debugFocus){return true;}if(PS.keyDown){_holdShift=event.shiftKey;_holdCtrl=event.ctrlKey;if(!event.which){hardkey=event.keyCode;}else{hardkey=event.which;}key=_keyFilter(hardkey,_holdShift);if(_legalKey(key)){if(!_pressed[key]){_pressed[key]=1;if((key!==hardkey)&&_pressed[hardkey]){_pressed[hardkey]=0;i=_holding.indexOf(hardkey);if(i>=0){_holding.splice(i,1);}}if(_holding.length<1){_keyDelay=_keyInitRate;}if(_holding.indexOf(key)<0){_holding.push(key);}try{PS.keyDown(key,_holdShift,_holdCtrl,_EMPTY);any=true;}catch(err){_errorCatch(fn+"PS.keyDown failed ["+err.message+"]",err);}}}else{if(key===_KEY_SHIFT){len=_holding.length;for(i=0;i<len;i+=1){key=hardkey=_holding[i];if((hardkey>=97)&&(hardkey<=122)){key-=32;}else{if(hardkey<256){key=_shiftedKeys[hardkey];}}if(key!==hardkey){_pressed[hardkey]=0;_pressed[key]=1;_holding[i]=key;try{PS.keyDown(key,true,_holdCtrl,_EMPTY);any=true;}catch(err2){_errorCatch(fn+"PS.keyDown failed ["+err2.message+"]",err2);}}}}}if(any){_gridDraw();}}return _endEvent(event);}function _keyUp(event){var fn,any,shift,ctrl,hardkey,key,i,len;fn="[_keyUp] ";any=false;if(_debugFocus){return true;}if(PS.keyUp){shift=_holdShift=event.shiftKey;ctrl=_holdCtrl=event.ctrlKey;if(!event.which){hardkey=event.keyCode;}else{hardkey=event.which;}key=_keyFilter(hardkey,_holdShift);if(_legalKey(key)){_pressed[key]=0;i=_holding.indexOf(key);if(i>=0){_holding.splice(i,1);}if(_holding.length<1){_keyDelay=0;_holdShift=false;_holdCtrl=false;}try{PS.keyUp(key,shift,ctrl,_EMPTY);any=true;}catch(err){_errorCatch(fn+"PS.keyUp failed ["+err.message+"]",err);}}else{if(key===_KEY_SHIFT){len=_holding.length;for(i=0;i<len;i+=1){key=hardkey=_holding[i];if(hardkey<256){key=_unshiftedKeys[hardkey];}if(key!==hardkey){_pressed[hardkey]=0;_pressed[key]=1;_holding[i]=key;try{PS.keyDown(key,false,ctrl,_EMPTY);any=true;}catch(err2){_errorCatch(fn+"PS.keyDown failed ["+err2.message+"]",err2);}}}}}if(any){_gridDraw();}}return _endEvent(event);}function _wheel(event){var delta;if(!_overGrid){return true;}if(PS.input){if(!event){event=window.event;}delta=Math.max(-1,Math.min(1,(event.wheelDelta||-event.detail)));if(delta>=1){delta=PS.WHEEL_FORWARD;}else{delta=PS.WHEEL_BACKWARD;}try{PS.input({wheel:delta},_EMPTY);_gridDraw();}catch(err){_errorCatch("PS.input() failed ["+err.message+"]",err);}}return _endEvent(event);}function _gridActivate(){var grid;grid=_grid.canvas;grid.style.display="block";grid.addEventListener("mousedown",_mouseDown,false);grid.addEventListener("mouseup",_mouseUp,false);grid.addEventListener("mousemove",_mouseMove,false);grid.addEventListener("mouseout",_gridOut,false);document.addEventListener("keydown",_keyDown,false);document.addEventListener("keyup",_keyUp,false);window.addEventListener("DOMMouseScroll",_wheel,false);window.addEventListener("mousewheel",_wheel,false);if(_touchScreen){_currentFinger=_CLEAR;_underBead=_CLEAR;document.addEventListener("touchmove",_touchMove,false);document.addEventListener("touchstart",_touchStart,false);document.addEventListener("touchend",_touchEnd,false);document.addEventListener("touchcancel",_touchEnd,false);}}function _gridColor(colors){var current,fader,rgb,r,g,b;current=_grid.color;fader=_grid.fader;rgb=colors.rgb;if(rgb===PS.CURRENT){return current.rgb;}if(rgb===null){r=colors.r;if(r===PS.CURRENT){colors.r=r=current.r;}else{if(r===PS.DEFAULT){colors.r=r=_DEFAULTS.grid.color.r;}}g=colors.g;if(g===PS.CURRENT){colors.g=g=current.g;}else{if(g===PS.DEFAULT){colors.g=g=_DEFAULTS.grid.color.g;}}b=colors.b;if(b===PS.CURRENT){colors.b=b=current.b;}else{if(b===PS.DEFAULT){colors.b=b=_DEFAULTS.grid.color.b;}}colors.rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;}else{if(rgb===PS.DEFAULT){_copy(_DEFAULTS.grid.color,colors);}}if((current.rgb!==colors.rgb)||((fader.rate>0)&&(fader.rgb!==null)&&(fader.rgb!==colors.rgb))){current.rgb=colors.rgb;r=colors.r;g=colors.g;b=colors.b;current.str=colors.str=_RSTR[r]+_GBSTR[g]+_BASTR[b];if(fader.rate>0){if(fader.rgb!==null){_startFader(fader,fader.r,fader.g,fader.b,255,r,g,b,255);}else{if(!fader.active){_startFader(fader,current.r,current.g,current.b,255,r,g,b,255);}else{_recalcFader(fader,r,g,b,255);}}}else{_gridRGB(colors);_gridRGBEnd(colors);}current.r=r;current.g=g;current.b=b;}return current.rgb;}function _gridSize(x,y){var size,i,j,cnt,xpos,ypos,bead;_initFaders();_resetFader(_grid.fader);_resetFader(_status.fader);_grid.plane=0;if(!_grid.ready||(x!==_grid.x)||(y!==_grid.y)){_grid.x=x;_grid.y=y;_grid.count=x*y;if(x>=y){size=Math.floor(_CLIENT_SIZE/x);_grid.left=0;}else{size=Math.floor(_CLIENT_SIZE/y);_grid.left=Math.floor((_CLIENT_SIZE-(size*x))/2);}_grid.bead_size=size;_grid.width=size*x;_grid.height=size*y;_grid.right=_grid.left+_grid.width;_grid.top=0;_grid.bottom=_grid.height;if(y>=x){_grid.canvas.height=_CLIENT_SIZE;}else{_grid.canvas.height=_grid.height;}_grid.context.textAlign="center";_grid.context.textBaseline="middle";cnt=0;ypos=_grid.top;for(j=0;j<y;j+=1){xpos=_grid.left;for(i=0;i<x;i+=1){bead=_beads[cnt];bead.x=i;bead.y=j;bead.left=xpos;bead.right=xpos+size;bead.top=ypos;bead.bottom=ypos+size;_resetBead(bead);_rescale(bead);xpos+=size;cnt+=1;}ypos+=size;}while(cnt<_MAX_BEADS){bead=_beads[cnt];bead.visible=false;bead.active=false;cnt+=1;}}else{for(i=0;i<_grid.count;i+=1){bead=_beads[i];_resetBead(bead);_rescale(bead);}}_anyDirty=true;_gridColor({rgb:PS.DEFAULT});PS.statusColor(PS.DEFAULT);_gridDraw();_resetCursor();_grid.ready=true;}function _checkX(x,fn){if(_typeOf(x)!=="number"){return _error(fn+"x argument not a number");}x=Math.floor(x);if(x<0){return _error(fn+"x argument negative");}if(x>=_grid.x){return _error(fn+"x argument exceeds grid width");}return x;}function _checkY(y,fn){if(_typeOf(y)!=="number"){return _error(fn+"y argument not a number");}y=Math.floor(y);if(y<0){return _error(fn+"y argument negative");}if(y>=_grid.y){return _error(fn+"y argument exceeds grid height");}return y;}function _beadExec(fn,func,x,y,p1,p2,p3,p4){var i,j,result;if(x===PS.ALL){if(y===PS.ALL){for(j=0;j<_grid.y;j+=1){for(i=0;i<_grid.x;i+=1){result=func(i,j,p1,p2,p3,p4);if(result===PS.ERROR){break;}}}return result;}y=_checkY(y,fn);if(y===PS.ERROR){return PS.ERROR;}for(i=0;i<_grid.x;i+=1){result=func(i,y,p1,p2,p3,p4);if(result===PS.ERROR){break;}}return result;}if(y===PS.ALL){x=_checkX(x,fn);if(x===PS.ERROR){return PS.ERROR;}for(j=0;j<_grid.y;j+=1){result=func(x,j,p1,p2,p3,p4);if(result===PS.ERROR){break;}}return result;}x=_checkX(x,fn);if(x===PS.ERROR){return PS.ERROR;}y=_checkY(y,fn);if(y===PS.ERROR){return PS.ERROR;}result=func(x,y,p1,p2,p3,p4);return result;}function _color(x,y,colors){var id,bead,def,current,fader,rgb,r,g,b;id=(y*_grid.x)+x;bead=_beads[id];def=_DEFAULTS.bead.color;current=_colorPlane(bead,_grid.plane);fader=bead.fader;rgb=colors.rgb;if(!bead.active||(rgb===PS.CURRENT)){return current.rgb;}if(rgb===null){r=colors.r;if(r===PS.CURRENT){colors.r=r=current.r;}else{if(r===PS.DEFAULT){colors.r=r=def.r;}}g=colors.g;if(g===PS.CURRENT){colors.g=g=current.g;}else{if(g===PS.DEFAULT){colors.g=g=def.g;}}b=colors.b;if(b===PS.CURRENT){colors.b=b=current.b;}else{if(b===PS.DEFAULT){colors.b=b=def.b;}}colors.rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;}else{if(rgb===PS.DEFAULT){_copy(def,colors);}}if((current.rgb!==colors.rgb)||((fader.rate>0)&&(fader.rgb!==null)&&(fader.rgb!==colors.rgb))){current.rgb=colors.rgb;current.r=colors.r;current.g=colors.g;current.b=colors.b;_recolor(bead);}return current.rgb;}function _alpha(x,y,alpha){var id,bead,current;id=(y*_grid.x)+x;bead=_beads[id];current=_colorPlane(bead,_grid.plane);if(bead.active&&(alpha!==PS.CURRENT)&&(alpha!==current.a)){current.a=alpha;_recolor(bead);}return current.a;}function _validFadeOptions(fn,options){var type,val,red,blue,green,rval,gval;type=_typeOf(options);if((type==="undefined")||(options===PS.CURRENT)){return{rgb:PS.CURRENT,r:0,g:0,b:0,onEnd:PS.CURRENT,params:PS.CURRENT};}if(options===PS.DEFAULT){return{rgb:PS.DEFAULT,r:0,g:0,b:0,onEnd:PS.DEFAULT,params:PS.DEFAULT};}if(type!=="object"){return _error(fn+"options argument invalid");}val=options.rgb;if((val!==PS.CURRENT)&&(val!==PS.DEFAULT)){type=_typeOf(val);if((type==="undefined")||(val===null)){options.rgb=PS.CURRENT;}else{if(type==="number"){val=Math.floor(val);if(val<=PS.COLOR_BLACK){val=PS.COLOR_BLACK;red=0;green=0;blue=0;}else{if(val>=PS.COLOR_WHITE){val=PS.COLOR_WHITE;red=255;green=255;blue=255;}else{red=val/_RSHIFT;red=Math.floor(red);rval=red*_RSHIFT;green=(val-rval)/_GSHIFT;green=Math.floor(green);gval=green*_GSHIFT;blue=val-rval-gval;}}options.rgb=val;options.r=red;options.g=green;options.b=blue;}else{return _error(fn+"options.rgb property invalid");}}}else{options.r=0;options.g=0;options.b=0;}val=options.onEnd;if((val!==PS.CURRENT)&&(val!==PS.DEFAULT)){type=_typeOf(val);if((type==="undefined")||(val===null)){options.onEnd=PS.CURRENT;}else{if(type!=="function"){return _error(fn+"options.onEnd property invalid");}}}val=options.params;if((val!==PS.CURRENT)&&(val!==PS.DEFAULT)){type=_typeOf(val);if((type==="undefined")||(val===null)){options.params=PS.CURRENT;}else{if(type!=="array"){return _error(fn+"options.params property invalid");}}}return options;}function _fade(x,y,rate,options){var id,bead,fader,val;id=(y*_grid.x)+x;bead=_beads[id];fader=bead.fader;if(bead.active){if(rate!==PS.CURRENT){if(rate===PS.DEFAULT){fader.rate=_DEFAULTS.fader.rate;}else{fader.rate=rate;}}val=options.rgb;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.rgb=_DEFAULTS.fader.rgb;}else{fader.rgb=val;}fader.r=options.r;fader.g=options.g;fader.b=options.b;}val=options.onEnd;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.onEnd=_DEFAULTS.fader.onEnd;}else{fader.onEnd=val;}}val=options.params;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.params=_DEFAULTS.fader.params;}else{fader.params=val;}}}return{rate:fader.rate,rgb:fader.rgb,onEnd:fader.onEnd,params:fader.params};}function _scale(x,y,scale){var id,bead;id=(y*_grid.x)+x;bead=_beads[id];if(bead.active&&(scale!==PS.CURRENT)&&(bead.scale!==scale)){bead.scale=scale;_rescale(bead);_makeDirty(bead);}return bead.scale;}function _radius(x,y,radius){var id,bead,max;id=(y*_grid.x)+x;bead=_beads[id];if(bead.active&&(radius!==PS.CURRENT)&&(bead.radius!==radius)){bead.radius=radius;if(!bead.border.equal&&(radius>0)){max=Math.max(bead.border.top,bead.border.left,bead.border.bottom,bead.border.right);_equalBorder(bead,max);}_makeDirty(bead);}return bead.radius;}function _data(x,y,data){var id,bead;id=(y*_grid.x)+x;bead=_beads[id];if(bead.active&&(data!==PS.CURRENT)){if(data===null){bead.data=_DEFAULTS.bead.data;bead.fader.data=bead.data;bead.borderFader.data=bead.data;bead.glyphFader.data=bead.data;}else{bead.data=data;bead.fader.data=data;bead.borderFader.data=data;bead.glyphFader.data=data;}}return bead.data;}function _exec(x,y,exec){var id,bead;id=(y*_grid.x)+x;bead=_beads[id];if(bead.active&&(exec!==PS.CURRENT)){bead.exec=exec;}return bead.exec;}function _visible(x,y,show){var id,bead;id=(y*_grid.x)+x;bead=_beads[id];if(bead.active&&(show!==PS.CURRENT)&&(bead.visible!==show)){bead.visible=show;if(!show){bead.fader.kill=true;bead.borderFader.kill=true;bead.glyphFader.kill=true;}_makeDirty(bead);}return bead.visible;}function _active(x,y,active){var id,bead;id=(y*_grid.x)+x;bead=_beads[id];if(active!==PS.CURRENT){bead.active=active;}return bead.active;}function _border(x,y,width){var id,bead,max,val,any,top,left,bottom,right;id=(y*_grid.x)+x;bead=_beads[id];if(bead.active&&(width!==PS.CURRENT)){max=_borderMax(bead);if(_typeOf(width)==="number"){if(width>max){width=max;}if(width!==bead.border.width){_equalBorder(bead,width);_makeDirty(bead);}}else{any=false;top=width.top;if(top===PS.CURRENT){top=bead.border.top;}else{if(top>max){top=max;}if(top!==bead.border.top){bead.border.top=top;any=true;}}left=width.left;if(left===PS.CURRENT){left=bead.border.left;}else{if(left>max){left=max;}if(left!==bead.border.left){bead.border.left=left;any=true;}}bottom=width.bottom;if(bottom===PS.CURRENT){bottom=bead.border.bottom;}else{if(bottom>max){bottom=max;}if(bottom!==bead.border.bottom){bead.border.bottom=bottom;any=true;}}right=width.right;if(right===PS.CURRENT){right=bead.border.right;}else{if(right>max){right=max;}if(right!==bead.border.right){bead.border.right=right;any=true;}}if((top===left)&&(top===right)&&(top===bottom)){_equalBorder(bead,top);if(any){_makeDirty(bead);}}else{if((bead.radius>0)||(bead.glyph.code>0)){max=Math.max(top,left,bottom,right);_equalBorder(bead,max);_makeDirty(bead);}else{bead.border.equal=false;if(any){_makeDirty(bead);}}}}}val={top:bead.border.top,left:bead.border.left,bottom:bead.border.bottom,right:bead.border.right,equal:bead.border.equal};if(!bead.border.equal){bead.border.width=Math.max(val.top,val.left,val.bottom,val.right);}val.width=bead.border.width;return val;}function _borderColor(x,y,colors){var id,bead,current,fader,rgb,r,g,b,a;id=(y*_grid.x)+x;bead=_beads[id];current=bead.border.color;fader=bead.borderFader;rgb=colors.rgb;if(bead.active&&(rgb!==PS.CURRENT)){if(rgb===null){r=colors.r;if(r===PS.CURRENT){colors.r=r=current.r;}else{if(r===PS.DEFAULT){colors.r=r=_DEFAULTS.bead.border.color.r;}}g=colors.g;if(g===PS.CURRENT){colors.g=g=current.g;}else{if(g===PS.DEFAULT){colors.g=g=_DEFAULTS.bead.border.color.g;}}b=colors.b;if(b===PS.CURRENT){colors.b=b=current.b;}else{if(b===PS.DEFAULT){colors.b=b=_DEFAULTS.bead.border.color.b;}}colors.rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;}else{if(rgb===PS.DEFAULT){_copy(_DEFAULTS.bead.border.color,colors);}}if((current.rgb!==colors.rgb)||((fader.rate>0)&&(fader.rgb!==null)&&(fader.rgb!==colors.rgb))){current.rgb=colors.rgb;r=colors.r;g=colors.g;b=colors.b;colors.a=a=current.a;current.str=colors.str=_RSTR[r]+_GBSTR[g]+_GBSTR[b]+_ASTR[a];if(bead.visible){if(fader.rate>0){if(fader.rgb!==null){_startFader(fader,fader.r,fader.g,fader.b,a,r,g,b,a);}else{if(!fader.active){_startFader(fader,current.r,current.g,current.b,a,r,g,b,a);}else{_recalcFader(fader,r,g,b,a);}}}else{_makeDirty(bead);}}current.r=r;current.g=g;current.b=b;}}return current.rgb;}function _borderAlpha(x,y,alpha){var id,bead,current,r,g,b,fader;id=(y*_grid.x)+x;bead=_beads[id];current=bead.border.color;if(bead.active&&(alpha!==PS.CURRENT)&&(alpha!==current.a)){r=current.r;g=current.g;b=current.b;current.str=_RSTR[r]+_GBSTR[g]+_GBSTR[b]+_ASTR[alpha];PS.statusText("str = "+current.str);if(bead.visible){fader=bead.borderFader;if(fader.rate>0){if(!fader.active){if(fader.rgb!==null){_startFader(fader,fader.r,fader.g,fader.b,current.a,r,g,b,alpha);}else{_startFader(fader,r,g,b,current.a,r,g,b,alpha);}}else{_recalcFader(fader,r,g,b,alpha);}}else{_makeDirty(bead);}}current.a=alpha;}return current.a;}function _borderFade(x,y,rate,options){var id,bead,fader,val;id=(y*_grid.x)+x;bead=_beads[id];fader=bead.borderFader;if(bead.active){if(rate!==PS.CURRENT){if(rate===PS.DEFAULT){fader.rate=_DEFAULTS.fader.rate;}else{fader.rate=rate;}}val=options.rgb;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.rgb=_DEFAULTS.fader.rgb;}else{fader.rgb=val;}fader.r=options.r;fader.g=options.g;fader.b=options.b;}val=options.onEnd;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.onEnd=_DEFAULTS.fader.onEnd;}else{fader.onEnd=val;}}val=options.params;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.params=_DEFAULTS.fader.params;}else{fader.params=val;}}}return{rate:fader.rate,rgb:fader.rgb,onEnd:fader.onEnd,params:fader.params};}function _glyph(x,y,glyph){var id,bead,str,max,top,left,bottom,right;id=(y*_grid.x)+x;bead=_beads[id];if(bead.active&&(glyph!==PS.CURRENT)&&(bead.glyph.code!==glyph)){bead.glyph.code=glyph;if(glyph<1){str="";}else{str=String.fromCodePoint(glyph);}bead.glyph.str=str;max=_borderMax(bead);if(bead.border.equal){if(bead.border.width>max){_equalBorder(bead,max);}}else{top=bead.border.top;if(top>max){top=max;}left=bead.border.left;if(left>max){left=max;}bottom=bead.border.bottom;if(bottom>max){bottom=max;}right=bead.border.right;if(right>max){right=max;}max=Math.max(top,left,bottom,right);_equalBorder(bead,max);}_makeDirty(bead);}return bead.glyph.code;}function _glyphColor(x,y,colors){var id,bead,current,fader,rgb,r,g,b,a;id=(y*_grid.x)+x;bead=_beads[id];current=bead.glyph.color;fader=bead.glyphFader;rgb=colors.rgb;if(bead.active&&(rgb!==PS.CURRENT)){if(rgb===null){r=colors.r;if(r===PS.CURRENT){colors.r=r=current.r;}else{if(r===PS.DEFAULT){colors.r=r=_DEFAULTS.bead.glyph.color.r;}}g=colors.g;if(g===PS.CURRENT){colors.g=g=current.g;}else{if(g===PS.DEFAULT){colors.g=g=_DEFAULTS.bead.glyph.color.g;}}b=colors.b;if(b===PS.CURRENT){colors.b=b=current.b;}else{if(b===PS.DEFAULT){colors.b=b=_DEFAULTS.bead.glyph.color.b;}}colors.rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;}else{if(rgb===PS.DEFAULT){_copy(_DEFAULTS.bead.glyph.color,colors);}}if((current.rgb!==colors.rgb)||((fader.rate>0)&&(fader.rgb!==null)&&(fader.rgb!==colors.rgb))){current.rgb=colors.rgb;r=colors.r;g=colors.g;b=colors.b;colors.a=a=current.a;current.str=colors.str=_RSTR[r]+_GBSTR[g]+_GBSTR[b]+_ASTR[a];if(bead.visible){if(fader.rate>0){if(fader.rgb!==null){_startFader(fader,fader.r,fader.g,fader.b,a,r,g,b,a);}if(!fader.active){_startFader(fader,current.r,current.g,current.b,a,r,g,b,a);}else{_recalcFader(fader,r,g,b,a);}}else{_makeDirty(bead);}}current.r=r;current.g=g;current.b=b;}}return current.rgb;}function _glyphAlpha(x,y,alpha){var id,bead,current,r,g,b,fader;id=(y*_grid.x)+x;bead=_beads[id];current=bead.glyph.color;if(bead.active&&(alpha!==PS.CURRENT)&&(alpha!==current.a)){r=current.r;g=current.g;b=current.b;current.str=_RSTR[r]+_GBSTR[g]+_GBSTR[b]+_ASTR[alpha];if(bead.visible){fader=bead.glyphFader;if(fader.rate>0){if(!fader.active){_startFader(fader,r,g,b,current.a,r,g,b,alpha);}else{_recalcFader(fader,r,g,b,alpha);}}else{_makeDirty(bead);}}current.a=alpha;}return current.a;}function _glyphScale(x,y,scale){var id,bead,current;id=(y*_grid.x)+x;bead=_beads[id];current=bead.glyph.scale;if(bead.active&&(scale!==PS.CURRENT)&&(scale!==current)){bead.glyph.scale=scale;if(bead.visible){_rescaleGlyph(bead);_makeDirty(bead);}}return bead.glyph.scale;}function _glyphFade(x,y,rate,options){var id,bead,fader,val;id=(y*_grid.x)+x;bead=_beads[id];fader=bead.glyphFader;if(bead.active){if(rate!==PS.CURRENT){if(rate===PS.DEFAULT){fader.rate=_DEFAULTS.fader.rate;}else{fader.rate=rate;}}val=options.rgb;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.rgb=_DEFAULTS.fader.rgb;}else{fader.rgb=val;}fader.r=options.r;fader.g=options.g;fader.b=options.b;}val=options.onEnd;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.onEnd=_DEFAULTS.fader.onEnd;}else{fader.onEnd=val;}}val=options.params;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.params=_DEFAULTS.fader.params;}else{fader.params=val;}}}return{rate:fader.rate,rgb:fader.rgb,onEnd:fader.onEnd,params:fader.params};}function _imageError(image){var id,len,i,rec,exec;id=image.getAttribute("data-id");len=_imageList.length;for(i=0;i<len;i+=1){rec=_imageList[i];if(rec.id===id){exec=rec.exec;_imageList.splice(i,1);break;}}try{exec(PS.ERROR);}catch(err){_errorCatch("[PS.imageLoad] .exec function failed ["+err.message+"]",err);}_error("[PS.imageLoad] Error loading "+image.src);}function _imageExtract(imageData,format){var fn,w,h,ctx,srcImage,destImage,src,len,dest,i,j,r,g,b,a;fn="[_imageExtract] ";w=imageData.width;if((_typeOf(w)!=="number")||(w<1)){return _error(fn+"image width invalid");}w=Math.floor(w);h=imageData.height;if((_typeOf(h)!=="number")||(h<1)){return _error(fn+"image height invalid");}h=Math.floor(h);try{_imageCanvas.width=w;_imageCanvas.height=h;ctx=_imageCanvas.getContext("2d");ctx.drawImage(imageData,0,0,w,h,0,0,w,h);}catch(e1){return _errorCatch(fn+"image extraction failed @ 1 ["+e1.message+"]",e1);}try{srcImage=ctx.getImageData(0,0,w,h);}catch(e2){return _errorCatch(fn+"image extraction failed @ 2 ["+e2.message+"]",e2);}destImage={width:srcImage.width,height:srcImage.height};src=srcImage.data;len=src.length;dest=[];j=i=0;if(format===1){dest.length=len/4;while(i<len){r=src[i];g=src[i+1];b=src[i+2];dest[j]=(r*_RSHIFT)+(g*_GSHIFT)+b;i+=4;j+=1;}}else{if(format===2){dest.length=len/2;while(i<len){r=src[i];g=src[i+1];b=src[i+2];a=src[i+3];dest[j]=(r*_RSHIFT)+(g*_GSHIFT)+b;dest[j+1]=a;i+=4;j+=2;}}else{if(format===3){dest.length=(len/4)*3;while(i<len){r=src[i];g=src[i+1];b=src[i+2];dest[j]=r;dest[j+1]=g;dest[j+2]=b;i+=4;j+=3;}}else{dest.length=len;while(i<len){dest[i]=src[i];i+=1;dest[i]=src[i];i+=1;dest[i]=src[i];i+=1;dest[i]=src[i];i+=1;}}}}destImage.pixelSize=format;destImage.data=dest;return destImage;}function _imageLoad(image){var id,len,i,rec,exec,format,source,idata;id=image.getAttribute("data-id");len=_imageList.length;for(i=0;i<len;i+=1){rec=_imageList[i];if(rec.id===id){exec=rec.exec;format=rec.format;source=rec.source;_imageList.splice(i,1);break;}}idata=_imageExtract(image,format);if(idata!==PS.ERROR){try{idata.source=source;idata.id=id;exec(idata);}catch(err){_errorCatch("[PS.imageLoad] .exec function failed ["+err.message+"]",err);}}}function _validImage(fn,image){var w,h,format,total,data,len,i,val;if(_typeOf(image)!=="object"){return _error(fn+"image argument not an object");}w=image.width;if(_typeOf(w)!=="number"){return _error(fn+"image.width not a number");}w=Math.floor(w);if(w<1){return _error(fn+"image.width < 1");}image.width=w;h=image.height;if(_typeOf(h)!=="number"){return _error(fn+"image.height not a number");}h=Math.floor(h);if(h<1){return _error(fn+"image.height < 1");}image.height=h;format=image.pixelSize;if(_typeOf(format)!=="number"){return _error(fn+"image.pixelSize not a number");}format=Math.floor(format);if((format<1)&&(format>4)){return _error(fn+"image.pixelSize is not 1, 2, 3 or 4");}image.pixelSize=format;data=image.data;if(_typeOf(data)!=="array"){return _error(fn+"image.data is not an array");}len=data.length;total=w*h*format;if(len!==total){return _error(fn+"image.data length invalid");}for(i=0;i<len;i+=1){val=data[i];if(_typeOf(val)!=="number"){return _error(fn+"image.data["+i+"] not a number");}if(val<0){return _error(fn+"image.data["+i+"] negative");}if(format<3){if(val>16777215){return _error(fn+"image.data["+i+"] > 0xFFFFFF");}}else{if(val>255){return _error(fn+"image.data["+i+"] > 255");}}}return true;}function _hex(data,pad){var str,i;str=data.toString(16).toUpperCase();if(pad){i=str.length;while(i<pad){str="0"+str;i+=1;}}return("0x"+str);}function _outputPixel(format,hex,rgb,r,g,b,a){var str;if(format<3){str="";if(hex){str+=_hex(rgb,6);}else{str+=rgb;}if(format===2){if(hex){str+=(", "+_hex(a,2));}else{str+=(", "+a);}}}else{if(hex){str=_hex(r,2)+", "+_hex(g,2)+", "+_hex(b,2);}else{str=r+", "+g+", "+b;}if(format===4){if(hex){str+=(", "+_hex(a,2));}else{str+=(", "+a);}}}return str;}function _newSprite(){var s;s={id:_SPRITE_PREFIX+_spriteCnt,placed:false,visible:true,x:0,y:0,ax:0,ay:0,image:null,color:null,collide:null,width:0,height:0,plane:-1};_spriteCnt+=1;_sprites.push(s);return s;}function _getSprite(sprite,fn){var len,i,s;if((typeof sprite!=="string")||(sprite.length<1)){return _error(fn+"sprite argument invalid");}len=_sprites.length;for(i=0;i<len;i+=1){s=_sprites[i];if(s.id===sprite){return s;}}return _error(fn+"sprite id '"+sprite+"' does not exist");}function _eraseSprite(s,left,top,width,height){var xmax,ymax,right,bottom,x,y,bead,i,color;if(left===undefined){left=s.x;top=s.y;width=s.width;height=s.height;}xmax=_grid.x;left-=s.ax;if(left>=xmax){return;}if(left<0){width+=left;if(width<1){return;}left=0;}if((left+width)>xmax){width=xmax-left;}right=left+width;ymax=_grid.y;top-=s.ay;if(top>=ymax){return;}if(top<0){height+=top;if(height<1){return;}top=0;}if((top+height)>ymax){height=ymax-top;}bottom=top+height;for(y=top;y<bottom;y+=1){for(x=left;x<right;x+=1){i=x+(y*xmax);bead=_beads[i];if(bead.active){color=_colorPlane(bead,s.plane);color.r=255;color.g=255;color.b=255;color.a=0;color.rgb=16777215;_recolor(bead);}}}}function _drawSprite(s){var width,height,xmax,ymax,left,top,right,bottom,srcLeft,srcTop,scolor,x,y,bead,i,bcolor,data,ptr,r,g,b,a;width=s.width;height=s.height;if((width<1)||(height<1)){return;}xmax=_grid.x;srcLeft=0;left=s.x-s.ax;if(left>=xmax){return;}if(left<0){width+=left;if(width<1){return;}left=0;srcLeft=s.width-width;}if((left+width)>xmax){width=xmax-left;}right=left+width;ymax=_grid.y;srcTop=0;top=s.y-s.ay;if(top>=ymax){return;}if(top<0){height+=top;if(height<1){return;}top=0;srcTop=s.height-height;}if((top+height)>ymax){height=ymax-top;}bottom=top+height;scolor=s.color;if(scolor){for(y=top;y<bottom;y+=1){for(x=left;x<right;x+=1){i=x+(y*xmax);bead=_beads[i];if(bead.active){bcolor=_colorPlane(bead,s.plane);bcolor.rgb=scolor.rgb;bcolor.r=scolor.r;bcolor.g=scolor.g;bcolor.b=scolor.b;bcolor.a=scolor.a;_recolor(bead);}}}}else{data=s.image.data;for(y=top;y<bottom;y+=1){ptr=((srcTop*s.width)+srcLeft)*4;for(x=left;x<right;x+=1){i=x+(y*xmax);bead=_beads[i];if(bead.active){r=data[ptr];g=data[ptr+1];b=data[ptr+2];a=data[ptr+3];bcolor=_colorPlane(bead,s.plane);bcolor.rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;bcolor.r=r;bcolor.g=g;bcolor.b=b;bcolor.a=a;_recolor(bead);}ptr+=4;}srcTop+=1;}}}function _collisionCheck(s,id){var fn,len,i,x,y,w,h,exec,s2,id2,x2,y2,w2,h2,exec2,dx,dy,evt;fn="[_collisionCheck] ";x=s.x-s.ax;y=s.y-s.ay;w=s.width;h=s.height;exec=s.collide;len=_sprites.length;for(i=0;i<len;i+=1){s2=_sprites[i];id2=s2.id;if((id2!==id)&&s2.visible&&s2.placed){x2=s2.x-s2.ax;y2=s2.y-s2.ay;w2=s2.width;h2=s2.height;exec2=s2.collide;if(x2>x){dx=x2-x;}else{dx=x-x2;}if(y2>y){dy=y2-y;}else{dy=y-y2;}evt=null;if((x===(x2-w))||(x===(x2+w2))){if(((y<=y2)&&(dy<=h))||((y>=y2)&&(dy<=h2))){evt=PS.SPRITE_TOUCH;}}else{if((y===(y2-h))||(y===(y2+h2))){if(((x<=x2)&&(dx<=w))||((x>=x2)&&(dx<=w2))){evt=PS.SPRITE_TOUCH;}}else{if((x>=x2)&&(x<(x2+w2))){if(((y<=y2)&&(dy<h))||((y>=y2)&&(dy<h2))){evt=PS.SPRITE_OVERLAP;}}else{if((x2>=x)&&(x2<(x+w))){if(((y2<=y)&&(dy<h2))||((y2>=y)&&(dy<h))){evt=PS.SPRITE_OVERLAP;}}}}}if(evt){if(exec){try{exec(id,s.plane,id2,s2.plane,evt);}catch(e1){_errorCatch(fn+id+" collide function failed ["+e1.message+"]",e1);return;}}if(exec2){try{exec2(id2,s2.plane,id,s.plane,evt);}catch(e2){_errorCatch(fn+id2+" collide function failed ["+e2.message+"]",e2);return;}}}}}}function BinaryHeap(scoreFunction){this.content=[];this.scoreFunction=scoreFunction;}BinaryHeap.prototype={push:function(element){this.content.push(element);this.bubbleUp(this.content.length-1);},pop:function(){var result,end;result=this.content[0];end=this.content.pop();if(this.content.length>0){this.content[0]=end;this.sinkDown(0);}return result;},remove:function(node){var len,i,end;len=this.content.length;for(i=0;i<len;i+=1){if(this.content[i]===node){end=this.content.pop();if(i!==(len-1)){this.content[i]=end;this.bubbleUp(i);this.sinkDown(i);}break;}}},size:function(){var len;len=this.content.length;return len;},bubbleUp:function(n){var element,score,parentN,parent;element=this.content[n];score=this.scoreFunction(element);while(n>0){parentN=Math.floor((n+1)/2)-1;parent=this.content[parentN];if(score>=this.scoreFunction(parent)){break;}this.content[parentN]=element;this.content[n]=parent;n=parentN;}},sinkDown:function(n){var len,element,elemScore,child1N,child2N,swap,child1,child1Score,child2,child2Score;len=this.content.length;element=this.content[n];elemScore=this.scoreFunction(element);while(true){child2N=(n+1)*2;child1N=child2N-1;swap=null;if(child1N<len){child1=this.content[child1N];child1Score=this.scoreFunction(child1);if(child1Score<elemScore){swap=child1N;}}if(child2N<len){child2=this.content[child2N];child2Score=this.scoreFunction(child2);if(child2Score<(swap===null?elemScore:child1Score)){swap=child2N;}}if(swap===null){break;}this.content[n]=this.content[swap];this.content[swap]=element;n=swap;}},rescore:function(e){this.sinkDown(this.content.indexOf(e));}};function _line(x1,y1,x2,y2){var dx,dy,sx,sy,err,e2,line;if(x2>x1){dx=x2-x1;}else{dx=x1-x2;}if(y2>y1){dy=y2-y1;}else{dy=y1-y2;}if(x1<x2){sx=1;}else{sx=-1;}if(y1<y2){sy=1;}else{sy=-1;}err=dx-dy;line=[];while((x1!==x2)||(y1!==y2)){e2=err*2;if(e2>-dy){err-=dy;x1+=sx;}if((x1===x2)&&(y1===y2)){line.push([x1,y1]);break;}if(e2<dx){err+=dx;y1+=sy;}line.push([x1,y1]);}return line;}function _lineWall(nodes,width,x1,y1,x2,y2){var dx,dy,sx,sy,err,e2,line,node,ptr;if(x2>x1){dx=x2-x1;}else{dx=x1-x2;}if(y2>y1){dy=y2-y1;}else{dy=y1-y2;}if(x1<x2){sx=1;}else{sx=-1;}if(y1<y2){sy=1;}else{sy=-1;}err=dx-dy;line=[];while((x1!==x2)||(y1!==y2)){e2=err*2;if(e2>-dy){err-=dy;x1+=sx;}if((x1===x2)&&(y1===y2)){line.push([x1,y1]);return line;}if(e2<dx){err+=dx;y1+=sy;}ptr=(y1*width)+x1;node=nodes[ptr];if(!node.value){return null;}line.push([x1,y1]);}return line;}function _heuristic(x1,y1,x2,y2){var dx,dy,h;if(x2>x1){dx=x2-x1;}else{dx=x1-x2;}if(y2>y1){dy=y2-y1;}else{dy=y1-y2;}if(dx>dy){h=(dy*_DIAGONAL_COST)+(dx-dy);}else{h=(dx*_DIAGONAL_COST)+(dy-dx);}return h;}function _neighbors(nodes,width,height,current,no_diagonals,cut_corners){var result,x,y,right,bottom,north,south,center,nx,ptr,node,nwall,swall,ewall,wwall;result=[];x=current.x;y=current.y;right=width-1;bottom=height-1;center=y*width;north=(y-1)*width;south=(y+1)*width;nwall=false;swall=false;ewall=false;wwall=false;if(x>0){nx=x-1;ptr=center+nx;node=nodes[ptr];if(!node.value){wwall=true;}else{if(!node.closed){node.cost=node.value;result.push(node);}}}if(x<right){nx=x+1;ptr=center+nx;node=nodes[ptr];if(!node.value){ewall=true;}else{if(!node.closed){node.cost=node.value;result.push(node);}}}if(y>0){ptr=north+x;node=nodes[ptr];if(!node.value){nwall=true;}else{if(!node.closed){node.cost=node.value;result.push(node);}}}if(y<bottom){ptr=south+x;node=nodes[ptr];if(!node.value){swall=true;}else{if(!node.closed){node.cost=node.value;result.push(node);}}}if(!no_diagonals){if(x>0){nx=x-1;if((y>0)&&(cut_corners||(!wwall&&!nwall))){ptr=north+nx;node=nodes[ptr];if(node.value&&!node.closed){node.cost=node.value*_DIAGONAL_COST;result.push(node);}}if((y<bottom)&&(cut_corners||(!wwall&&!swall))){ptr=south+nx;node=nodes[ptr];if(node.value&&!node.closed){node.cost=node.value*_DIAGONAL_COST;result.push(node);}}}if(x<right){nx=x+1;if((y>0)&&(cut_corners||(!nwall&&!ewall))){ptr=north+nx;node=nodes[ptr];if(node.value&&!node.closed){node.cost=node.value*_DIAGONAL_COST;result.push(node);}}if((y<bottom)&&(cut_corners||(!swall&&!ewall))){ptr=south+nx;node=nodes[ptr];if(node.value&&!node.closed){node.cost=node.value*_DIAGONAL_COST;result.push(node);}}}}return result;}function _score(node){return node.f;}function _findPath(pm,x1,y1,x2,y2,no_diagonals,cut_corners){var width,height,nodes,ptr,node,path,len,heap,current,neighbors,nlen,i,n,gScore,beenVisited,here;if((x1===x2)&&(y1===y2)){return[];}width=pm.width;height=pm.height;nodes=pm.nodes;ptr=(y1*width)+x1;node=nodes[ptr];if(!node.value){return[];}ptr=(y2*width)+x2;node=nodes[ptr];if(!node.value){return[];}if(!no_diagonals){path=_lineWall(nodes,width,x1,y1,x2,y2);if(path){return path;}}len=nodes.length;for(i=0;i<len;i+=1){node=nodes[i];node.f=0;node.g=0;node.h=0;node.cost=0;node.closed=false;node.visited=false;node.parent=null;}path=[];heap=new BinaryHeap(_score);ptr=(y1*width)+x1;node=nodes[ptr];heap.push(node);while(heap.size()>0){current=heap.pop();if((current.x===x2)&&(current.y===y2)){here=current;while(here.parent){path.push([here.x,here.y]);here=here.parent;}path.reverse();break;}current.closed=true;neighbors=_neighbors(nodes,width,height,current,no_diagonals,cut_corners);nlen=neighbors.length;for(i=0;i<nlen;i+=1){n=neighbors[i];gScore=current.g+n.cost;beenVisited=n.visited;if(!beenVisited||(gScore<n.g)){n.visited=true;n.parent=current;n.h=n.h||_heuristic(n.x,n.y,x2,y2);n.g=gScore;n.f=n.g+n.h;if(!beenVisited){heap.push(n);}else{heap.rescore(n);}}}}return path;}function _pathData(pm,left,top,width,height,data){var result,nodes,bottom,ptr,x,y,i,node;result=[];result.length=width*height;nodes=pm.nodes;bottom=top+height;i=0;for(y=top;y<bottom;y+=1){ptr=(y*pm.width)+left;for(x=0;x<width;x+=1){node=nodes[ptr];if(data!==PS.CURRENT){if(data===PS.DEFAULT){node.value=node.ovalue;}else{node.value=data;}}result[i]=node.value;i+=1;ptr+=1;}}return result;}function _newMap(width,height,data){var nodes,len,ptr,x,y,node,val,pm;len=data.length;nodes=[];nodes.length=len;ptr=0;for(y=0;y<height;y+=1){for(x=0;x<width;x+=1){val=data[ptr];node={x:x,y:y,value:val,ovalue:val,f:0,g:0,h:0,cost:0,parent:null,closed:false,visited:false};nodes[ptr]=node;ptr+=1;}}pm={id:_PATHMAP_PREFIX+_pathmapCnt,width:width,height:height,nodes:nodes};_pathmapCnt+=1;_pathmaps.push(pm);return pm;}function _getMap(pathmap){var len,i,pm;len=_pathmaps.length;for(i=0;i<len;i+=1){pm=_pathmaps[i];if(pm.id===pathmap){return pm;}}return null;}function _deleteMap(pathmap){var len,i,pm,nodes,j;len=_pathmaps.length;for(i=0;i<len;i+=1){pm=_pathmaps[i];if(pm.id===pathmap){nodes=pm.nodes;len=nodes.length;for(j=0;j<len;j+=1){nodes[j]=null;}pm.nodes=null;_pathmaps.splice(i,1);return true;}}return false;}function _pathNear(pm,x1,y1,x2,y2){var nodes,width,height,level,nlist,left,top,right,bottom,start,end,ptr,i,node,len,min,j,cnt,pos;nodes=pm.nodes;width=pm.width;height=pm.height;level=1;while(level<width){nlist=[];left=x2-level;right=x2+level;top=y2-level;bottom=y2+level;start=left;if(start<0){start=0;}end=right+1;if(end>=width){end=width;}if(top>=0){ptr=(top*width)+start;for(i=start;i<end;i+=1){node=nodes[ptr];if(node.value){nlist.push([node.x,node.y]);}ptr+=1;}}if(bottom<height){ptr=(bottom*width)+start;for(i=start;i<end;i+=1){node=nodes[ptr];if(node.value){nlist.push([node.x,node.y]);}ptr+=1;}}start=top+1;if(start<0){start=0;}end=bottom;if(end>=height){end=height;}if(left>=0){ptr=(start*width)+left;for(i=start;i<end;i+=1){node=nodes[ptr];if(node.value){nlist.push([node.x,node.y]);}ptr+=width;}}if(right<width){ptr=(start*width)+right;for(i=start;i<end;i+=1){node=nodes[ptr];if(node.value){nlist.push([node.x,node.y]);}ptr+=width;}}len=nlist.length;if(len){if(len===1){return nlist[0];}min=width+height;for(i=0;i<len;i+=1){pos=nlist[i];cnt=_heuristic(x1,y1,pos[0],pos[1]);if(cnt<min){min=cnt;j=i;}}return nlist[j];}level+=1;}return[x1,y1];}function _hasTouch(){try{document.createEvent("TouchEvent");return true;}catch(e){return false;}}function _systemDetect(){var ua,host,browser,os,version;ua=window.navigator.userAgent.toLowerCase();host=window.navigator.platform.toLowerCase();if(/firefox/.test(ua)){browser="Firefox";if(/fennec/.test(ua)){browser+=" Mobile";}version=/firefox\/[\.\d]+/.exec(ua)[0].split("/")[1];}else{if(/chrome/.test(ua)){browser="Chrome";version=/chrome\/[\d\.]+/.exec(ua)[0].split("/")[1];}else{if(/safari/.test(ua)){browser="Safari";if((/iphone/.test(ua))||(/ipad/.test(ua))||(/ipod/.test(ua))){os="iOS";}}else{if(/msie/.test(ua)){browser="Internet Explorer";if(/iemobile/.test(ua)){browser+=" Mobile";}version=/msie \d+[.]\d+/.exec(ua)[0].split(" ")[1];}else{if(/trident/.test(ua)){browser="Internet Explorer";version=/rv\:\d+[.]\d+/.exec(ua)[0].split(":")[1];}else{if(/opera/.test(ua)){browser="Opera";if(/mini/.test(ua)){browser+=" Mini";}else{if(/mobile/.test(ua)){browser+=" Mobile";}}}else{if(/android/.test(ua)){browser="Android";os=/android\s[\.\d]+/.exec(ua);}}}}}}}if(!version){try{version=/version\/[\.\d]+/.exec(ua);if(version){version=version[0].split("/")[1];}else{version=/opera\/[\.\d]+/.exec(ua)[0].split("/")[1];}}catch(err){console.error("Problem detecting browser: "+err.message);version="???";}}if((host==="win32")||(host==="win64")){os="Windows";}else{if((host==="macintel")||(host==="macppc")){os="Mac OS X ";os+=/10[\.\_\d]+/.exec(ua)[0];if(/[\_]/.test(os)){os=os.split("_").join(".");}}}if(!os){if(/linux/.test(host)){os="Linux";}else{if(/windows/.test(ua)){os="Windows";}}}_system.host.app=browser;if(version){_system.host.version=version;}_system.host.os=os;}PS={ALL:"PS.ALL",CURRENT:"PS.CURRENT",DONE:"PS.DONE",DEFAULT:"PS.DEFAULT",ERROR:"PS.ERROR",EMPTY:"PS.EMPTY",UNEQUAL:"PS.UNEQUAL",GRID:"PS.GRID",STATUS:"PS.STATUS",HTML5_AUDIO:"PS.HTML5_AUDIO",WEB_AUDIO:"PS.WEB_AUDIO",SPRITE_TOUCH:"PS.SPRITE_TOUCH",SPRITE_OVERLAP:"PS.SPRITE_OVERLAP",COLOR_BLACK:0,COLOR_WHITE:16777215,COLOR_GRAY_LIGHT:12632256,COLOR_GRAY:8421504,COLOR_GRAY_DARK:4210752,COLOR_RED:16711680,COLOR_ORANGE:16744448,COLOR_YELLOW:16776960,COLOR_GREEN:65280,COLOR_BLUE:255,COLOR_INDIGO:4194559,COLOR_VIOLET:8388863,COLOR_MAGENTA:16711935,COLOR_CYAN:65535,ALPHA_OPAQUE:255,ALPHA_TRANSPARENT:0,KEY_ENTER:13,KEY_TAB:9,KEY_ESCAPE:27,KEY_PAGE_UP:1001,KEY_PAGE_DOWN:1002,KEY_END:1003,KEY_HOME:1004,KEY_ARROW_LEFT:1005,KEY_ARROW_UP:1006,KEY_ARROW_RIGHT:1007,KEY_ARROW_DOWN:1008,KEY_INSERT:1009,KEY_DELETE:1010,KEY_PAD_0:96,KEY_PAD_1:97,KEY_PAD_2:98,KEY_PAD_3:99,KEY_PAD_4:100,KEY_PAD_5:101,KEY_PAD_6:102,KEY_PAD_7:103,KEY_PAD_8:104,KEY_PAD_9:105,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,WHEEL_FORWARD:"PS.WHEEL_FORWARD",WHEEL_BACKWARD:"PS.WHEEL_BACKWARD",FINDER_ASTAR:"PS.FINDER_ASTAR",FINDER_BREADTH_FIRST:"PS.FINDER_BREADTH_FIRST",FINDER_BEST_FIRST:"PS.FINDER_BEST_FIRST",FINDER_DIJKSTRA:"PS.FINDER_DIJKSTRA",FINDER_BI_ASTAR:"PS.FINDER_BI_ASTAR",FINDER_BI_BEST_FIRST:"PS.FINDER_BI_BEST_FIRST",FINDER_BI_DIJKSTRA:"PS.FINDER_BI_DIJKSTRA",FINDER_BI_BREADTH_FIRST:"PS.FINDER_BI_BREADTH_FIRST",FINDER_JUMP_POINT:"PS.FINDER_JUMP_POINT",_lastTick:0,_clock:function(){if(_clockActive){window.requestAnimationFrame(PS._clock);_tick();}},_sys:function(){var fn,errm,i,outer,debug,status,grid,footer,monitor,ctx,cnt,bead,result,str;fn="[PS.sys] ";errm=fn+"Invalid element";if(!String.fromCodePoint){String.fromCodePoint=_newCodePoint;}_RSTR=[];_RSTR.length=256;_GBSTR=[];_GBSTR.length=256;_BASTR=[];_BASTR.length=256;_ASTR=[];_ASTR.length=256;for(i=0;i<256;i+=1){_RSTR[i]="rgba("+i+",";_GBSTR[i]=i+",";_BASTR[i]=i+",1)";cnt=Math.floor((_ALPHOID*i)*1000)/1000;_ASTR[i]=cnt+")";}_systemDetect();_deviceScaling=screen.width/document.documentElement.clientWidth;_touchScreen=_hasTouch();_system.inputs.touch=_touchScreen;document.body.id="body";document.body.style.backgroundColor=_DEFAULTS.grid.color.str;outer=document.createElement("div");if(!outer){window.alert(errm);return;}outer.id=_OUTER_ID;document.body.appendChild(outer);_main=document.createElement("div");if(!_main){window.alert(errm);return;}_main.id=_MAIN_ID;outer.appendChild(_main);PS._mainLeft=_main.offsetLeft;PS._mainTop=_main.offsetTop;status=document.createElement("input");if(!status){window.alert(errm);return;}status.type="text";status.readonly="readonly";status.onfocus=function(){this.blur();};status.tabindex=-1;status.value="Perlenspiel 3.1";status.wrap="soft";status.id=_STATUS_ID;_main.appendChild(status);grid=document.createElement("canvas");if(!grid){window.alert(fn+"HTML5 canvas not supported.");return;}grid.id=_GRID_ID;grid.width=_CLIENT_SIZE;grid.backgroundColor=_DEFAULTS.grid.color.str;_overGrid=false;_resetCursor();_main.appendChild(grid);footer=document.createElement("p");if(!footer){window.alert(errm);return;}footer.id=_FOOTER_ID;footer.innerHTML="Loading Perlenspiel";_main.appendChild(footer);_footer=footer;debug=document.createElement("div");if(!debug){window.alert(errm);return;}debug.id=_DEBUG_ID;_main.appendChild(debug);monitor=document.createElement("textarea");if(!monitor){window.alert(errm);return;}monitor.id=_MONITOR_ID;monitor.rows=8;monitor.wrap="soft";monitor.readonly="readonly";monitor.onfocus=function(){_debugFocus=true;};monitor.onblur=function(){_debugFocus=false;};debug.appendChild(monitor);_debugging=false;_debugFocus=false;_pressed=[];_transKeys=[];_shiftedKeys=[];_unshiftedKeys=[];for(i=0;i<256;i+=1){_pressed[i]=0;_transKeys[i]=i;_shiftedKeys[i]=i;_unshiftedKeys[i]=i;}_holding=[];_holdShift=false;_holdCtrl=false;_keyRepeat=true;_keyDelayRate=_DEFAULT_KEY_DELAY;_keyInitRate=_DEFAULT_KEY_DELAY*5;_transKeys[33]=PS.KEY_PAGE_UP;_transKeys[34]=PS.KEY_PAGE_DOWN;_transKeys[35]=PS.KEY_END;_transKeys[36]=PS.KEY_HOME;_transKeys[37]=PS.KEY_ARROW_LEFT;_transKeys[38]=PS.KEY_ARROW_UP;_transKeys[39]=PS.KEY_ARROW_RIGHT;_transKeys[40]=PS.KEY_ARROW_DOWN;_transKeys[45]=PS.KEY_INSERT;_transKeys[46]=PS.KEY_DELETE;_transKeys[188]=44;_transKeys[190]=46;_transKeys[191]=47;_transKeys[192]=96;_transKeys[219]=91;_transKeys[220]=92;_transKeys[221]=93;_transKeys[222]=39;_shiftedKeys[96]=126;_shiftedKeys[49]=33;_shiftedKeys[50]=64;_shiftedKeys[51]=35;_shiftedKeys[52]=36;_shiftedKeys[53]=37;_shiftedKeys[54]=94;_shiftedKeys[55]=38;_shiftedKeys[56]=42;_shiftedKeys[57]=40;_shiftedKeys[48]=41;_shiftedKeys[45]=95;_shiftedKeys[61]=43;_shiftedKeys[91]=123;_shiftedKeys[93]=125;_shiftedKeys[92]=124;_shiftedKeys[59]=58;_shiftedKeys[39]=34;_shiftedKeys[44]=60;_shiftedKeys[46]=62;_shiftedKeys[47]=63;for(i=65;i<91;i+=1){_unshiftedKeys[i]=i+32;}_unshiftedKeys[126]=96;_unshiftedKeys[33]=49;_unshiftedKeys[64]=50;_unshiftedKeys[35]=51;_unshiftedKeys[36]=52;_unshiftedKeys[37]=53;_unshiftedKeys[94]=54;_unshiftedKeys[38]=55;_unshiftedKeys[42]=56;_unshiftedKeys[40]=57;_unshiftedKeys[41]=48;_unshiftedKeys[95]=45;_unshiftedKeys[43]=51;_unshiftedKeys[123]=91;_unshiftedKeys[125]=93;_unshiftedKeys[124]=92;_unshiftedKeys[58]=59;_unshiftedKeys[34]=39;_unshiftedKeys[60]=44;_unshiftedKeys[62]=46;_unshiftedKeys[63]=47;window.onblur=function(){var x;_holding.length=0;_holdShift=false;_holdCtrl=false;for(x=0;x<256;x+=1){_pressed[x]=0;}};ctx=grid.getContext("2d");if(!ctx.constructor.prototype.fillRoundedRect){ctx.constructor.prototype.fillRoundedRect=function(xx,yy,ww,hh,rad,fill,stroke){if(rad===undefined){rad=5;}this.beginPath();if(_system.host.app==="Opera"){this.moveTo(xx+ww-rad,yy);this.arcTo(xx+rad,yy,xx,yy+rad,rad);this.arcTo(xx,yy+hh-rad,xx+rad,yy+hh,rad);this.arcTo(xx+ww-rad,yy+hh,xx+ww,yy+hh-rad,rad);this.arcTo(xx+ww,yy+rad,xx+ww-rad,yy,rad);}else{this.moveTo(xx+rad,yy);this.arcTo(xx+ww,yy,xx+ww,yy+hh,rad);this.arcTo(xx+ww,yy+hh,xx,yy+hh,rad);this.arcTo(xx,yy+hh,xx,yy,rad);this.arcTo(xx,yy,xx+ww,yy,rad);}this.closePath();if(stroke){this.stroke();}if(fill||(fill===undefined)){this.fill();}};}_grid={canvas:grid,context:ctx,fader:_newFader(_GRID_ID,_gridRGB,_gridRGBEnd)};_copy(_DEFAULTS.grid,_grid);var canvasStyle=window.getComputedStyle(_grid.canvas,null);_grid.padLeft=parseInt(canvasStyle.getPropertyValue("padding-top").replace("px",""),10);_grid.padRight=parseInt(canvasStyle.getPropertyValue("padding-left").replace("px",""),10);_beads=[];_beads.length=cnt=_MAX_BEADS;for(i=0;i<cnt;i+=1){bead={index:i,fader:_newFader(i,_beadRGBA,null),borderFader:_newFader(i,_borderRGBA,null),glyphFader:_newFader(i,_glyphRGBA,null)};_resetBead(bead);_beads[i]=bead;}_status={div:status,fader:_newFader(_STATUS_ID,_statusRGB,null)};_copy(_DEFAULTS.status,_status);_sprites=[];_spriteCnt=0;_pathmaps=[];_pathmapCnt=0;result=AQ.init({defaultPath:_DEFAULTS.audio.path,defaultFileTypes:["ogg","mp3","wav"],onAlert:PS.debug,stack:true,forceHTML5:true});if(result.status===AQ.ERROR){return;}_errorSound=null;result=PS.audioLoad(_DEFAULTS.audio.error_sound,{path:_DEFAULTS.audio.path,lock:true});if(result===PS.ERROR){_warning("Error sound '"+_DEFAULTS.audio.error_sound+"' not loaded");}else{_errorSound=_DEFAULTS.audio.error_sound;}_imageCanvas=document.createElement("canvas");ctx=_imageCanvas.getContext("2d");ctx.imageSmoothingEnabled=false;ctx.mozImageSmoothingEnabled=false;ctx.webkitImageSmoothingEnabled=false;_imageList=[];_imageCnt=0;str="() event function undefined";if(typeof PS.init!=="function"){PS.init=null;_warning("PS.init"+str);}if(typeof PS.touch!=="function"){PS.touch=null;_warning("PS.touch"+str);}if(typeof PS.release!=="function"){PS.release=null;_warning("PS.release"+str);}if(typeof PS.enter!=="function"){PS.enter=null;_warning("PS.enter"+str);}if(typeof PS.exit!=="function"){PS.exit=null;_warning("PS.exit()"+str);}if(typeof PS.exitGrid!=="function"){PS.exitGrid=null;_warning("PS.exitGrid"+str);}if(typeof PS.keyDown!=="function"){PS.keyDown=null;_warning("PS.keyDown"+str);}if(typeof PS.keyUp!=="function"){PS.keyUp=null;_warning("PS.keyUp"+str);}if(typeof PS.input!=="function"){PS.input=null;_warning("PS.input"+str);}str=_system.engine+" "+_system.major+"."+_system.minor+"."+_system.revision+" | "+_system.host.os+" "+_system.host.app+" "+_system.host.version;if(_touchScreen){str+=(" | Touch ");}footer.innerHTML=str;_gridSize(_DEFAULTS.grid.x,_DEFAULTS.grid.y);_initFaders();_initTimers();_clockActive=true;PS._clock();_gridActivate();if(PS.init){try{PS.init(_system,_EMPTY);_gridDraw();}catch(err){_errorCatch("PS.init() failed ["+err.message+"]",err);}}},gridSize:function(xP,yP){var fn,x,y,max;fn="[PS.gridSize] ";if(arguments.length>2){return _error(fn+"Too many arguments");}x=xP;y=yP;max=_DEFAULTS.grid.max;if(x===PS.DEFAULT){x=_DEFAULTS.grid.x;}else{if(x===PS.CURRENT){x=_grid.x;}else{if(_typeOf(x)==="number"){x=Math.floor(x);if(x<1){x=1;}else{if(x>max){x=max;}}}else{return _error(fn+"x argument invalid");}}}if(y===PS.DEFAULT){y=_DEFAULTS.grid.y;}else{if(y===PS.CURRENT){y=_grid.y;}else{if(_typeOf(y)==="number"){y=Math.floor(y);if(y<1){y=1;}else{if(y>max){y=max;}}}else{return _error(fn+"y argument invalid");}}}_gridSize(x,y);return{width:_grid.x,height:_grid.y};},gridPlane:function(planeP){var fn,plane,type;fn="[PS.gridPlane] ";if(arguments.length>1){return _error(fn+"Too many arguments");}plane=planeP;type=_typeOf(plane);if((type!=="undefined")&&(plane!==PS.CURRENT)){if(plane===PS.DEFAULT){plane=0;}else{if(type==="number"){plane=Math.floor(plane);if(plane<1){plane=0;}}else{return _error(fn+"plane argument invalid");}}_grid.plane=plane;}return _grid.plane;},gridColor:function(p1,p2,p3){var fn,colors;fn="[PS.gridColor] ";if(arguments.length>3){return _error(fn+"Too many arguments");}colors=_decodeColors(fn,p1,p2,p3);if(colors===PS.ERROR){return PS.ERROR;}return _gridColor(colors);},gridFade:function(rate,optionsP){var fn,fader,options,type,val;fn="[PS.gridFade] ";if(arguments.length>2){return _error(fn+"Too many arguments");}fader=_grid.fader;val=rate;if(val!==PS.CURRENT){type=_typeOf(val);if(type!=="undefined"){if(val===PS.DEFAULT){fader.rate=_DEFAULTS.fader.rate;}else{if(type==="number"){val=Math.floor(val);if(val<0){val=0;}fader.rate=val;}else{return _error(fn+"rate argument invalid");}}}}options=_validFadeOptions(fn,optionsP);if(options===PS.ERROR){return PS.ERROR;}val=options.rgb;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.rgb=_DEFAULTS.fader.rgb;}else{fader.rgb=val;}fader.r=options.r;fader.g=options.g;fader.b=options.b;}val=options.onEnd;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.onEnd=_DEFAULTS.fader.onEnd;}else{fader.onEnd=val;}}val=options.params;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.params=_DEFAULTS.fader.params;}else{fader.params=val;}}return{rate:fader.rate,rgb:fader.rgb,onEnd:fader.onEnd,params:fader.params};},color:function(x,y,p1,p2,p3){var fn,args,colors;fn="[PS.color] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>5){return _error(fn+"Too many arguments");}colors=_decodeColors(fn,p1,p2,p3);if(colors===PS.ERROR){return PS.ERROR;}return _beadExec(fn,_color,x,y,colors);},alpha:function(x,y,alpha_p){var fn,args,alpha,type;fn="[PS.alpha] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}alpha=alpha_p;if(alpha!==PS.CURRENT){type=_typeOf(alpha);if(type==="undefined"){alpha=PS.CURRENT;}else{if(type==="number"){alpha=Math.floor(alpha);if(alpha<0){alpha=0;}else{if(alpha>255){alpha=255;}}}else{if(alpha===PS.DEFAULT){alpha=_DEFAULTS.bead.color.a;}else{return _error(fn+"alpha argument invalid");}}}}return _beadExec(fn,_alpha,x,y,alpha);},fade:function(x,y,rate_p,options_p){var fn,args,rate,type,options;fn="[PS.fade] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>4){return _error(fn+"Too many arguments");}rate=rate_p;if((rate!==PS.CURRENT)&&(rate!==PS.DEFAULT)){type=_typeOf(rate);if(type==="undefined"){rate=PS.CURRENT;}else{if(type==="number"){rate=Math.floor(rate);if(rate<0){rate=0;}}else{return _error(fn+"rate argument invalid");}}}options=_validFadeOptions(fn,options_p);if(options===PS.ERROR){return PS.ERROR;}return _beadExec(fn,_fade,x,y,rate,options);},scale:function(x,y,scale_p){var fn,args,scale,type;fn="[PS.scale] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}scale=scale_p;if(scale!==PS.CURRENT){type=_typeOf(scale);if(type==="undefined"){scale=PS.CURRENT;}else{if(scale===PS.DEFAULT){scale=100;}else{if(type==="number"){scale=Math.floor(scale);if(scale<50){scale=50;}else{if(scale>100){scale=100;}}}else{return _error(fn+"scale parameter invalid");}}}}return _beadExec(fn,_scale,x,y,scale);},radius:function(x,y,radius_p){var fn,args,radius,type;fn="[PS.radius] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}radius=radius_p;if(radius!==PS.CURRENT){type=_typeOf(radius);if(type==="undefined"){radius=PS.CURRENT;}else{if(radius===PS.DEFAULT){radius=0;}else{if(type==="number"){radius=Math.floor(radius);if(radius<0){radius=0;}else{if(radius>50){radius=50;}}}else{return _error(fn+"radius parameter invalid");}}}}return _beadExec(fn,_radius,x,y,radius);},data:function(x,y,data_p){var fn,args,data;fn="[PS.data] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}data=data_p;if(data===undefined){data=PS.CURRENT;}else{if(data===PS.DEFAULT){data=null;}}return _beadExec(fn,_data,x,y,data);},exec:function(x,y,exec_p){var fn,args,exec,type;fn="[PS.exec] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}exec=exec_p;if(exec!==PS.CURRENT){type=_typeOf(exec);if(type==="undefined"){exec=PS.CURRENT;}else{if(exec===PS.DEFAULT){exec=_DEFAULTS.bead.exec;}else{if(type!=="function"){return _error(fn+"exec argument invalid");}}}}return _beadExec(fn,_exec,x,y,exec);},visible:function(x,y,show_p){var fn,args,show;fn="[PS.visible] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}show=_isBoolean(show_p,PS.CURRENT,true,PS.CURRENT);if(show===PS.ERROR){return _error(fn+"show argument invalid");}return _beadExec(fn,_visible,x,y,show);},active:function(x,y,active_p){var fn,args,active;fn="[PS.active] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}active=_isBoolean(active_p,PS.CURRENT,true,PS.CURRENT);if(active===PS.ERROR){return _error(fn+"active argument invalid");}return _beadExec(fn,_active,x,y,active);},border:function(x,y,width_p){var fn,args,def,width,type,val;fn="[PS.border] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}def=_DEFAULTS.bead.border;width=width_p;if(width!==PS.CURRENT){type=_typeOf(width);if(type==="undefined"){width=PS.CURRENT;}else{if(width===PS.DEFAULT){width=def.width;}else{if(type==="number"){width=Math.floor(width);if(width<0){width=0;}}else{if(type==="object"){val=width.top;if(val!==PS.CURRENT){type=_typeOf(val);if(type==="undefined"){width.top=PS.CURRENT;}else{if(type==="number"){val=Math.floor(val);if(val<0){val=0;}width.top=val;}else{if(val===PS.DEFAULT){width.top=def.top;}else{return _error(fn+".top property invalid");}}}}val=width.left;if(val!==PS.CURRENT){type=_typeOf(val);if(type==="undefined"){width.left=PS.CURRENT;}else{if(type==="number"){val=Math.floor(val);if(val<0){val=0;}width.left=val;}else{if(val===PS.DEFAULT){width.left=def.left;}else{return _error(fn+".left property invalid");}}}}val=width.bottom;if(val!==PS.CURRENT){type=_typeOf(val);if(type==="undefined"){width.bottom=PS.CURRENT;}else{if(type==="number"){val=Math.floor(val);if(val<0){val=0;}width.bottom=val;}else{if(val===PS.DEFAULT){width.bottom=def.bottom;}else{return _error(fn+".bottom property invalid");}}}}val=width.right;if(val!==PS.CURRENT){type=_typeOf(val);if(type==="undefined"){width.right=PS.CURRENT;}else{if(type==="number"){val=Math.floor(val);if(val<0){val=0;}width.right=val;}else{if(val===PS.DEFAULT){width.right=def.right;}else{return _error(fn+".right property invalid");}}}}}else{return _error(fn+"width argument invalid");}}}}}return _beadExec(fn,_border,x,y,width);},borderColor:function(x,y,p1,p2,p3){var fn,colors;fn="[PS.borderColor] ";if(arguments.length<2){return _error(fn+"Missing argument(s)");}if(arguments.length>5){return _error(fn+"Too many arguments");}colors=_decodeColors(fn,p1,p2,p3);if(colors===PS.ERROR){return PS.ERROR;}return _beadExec(fn,_borderColor,x,y,colors);},borderAlpha:function(x,y,alpha_p){var fn,args,alpha,type;fn="[PS.borderAlpha] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}alpha=alpha_p;if(alpha!==PS.CURRENT){type=_typeOf(alpha);if(type==="undefined"){alpha=PS.CURRENT;}else{if(type==="number"){alpha=Math.floor(alpha);if(alpha<0){alpha=0;}else{if(alpha>255){alpha=255;}}}else{if(alpha===PS.DEFAULT){alpha=_DEFAULTS.bead.border.color.a;}else{return _error(fn+"alpha argument invalid");}}}}return _beadExec(fn,_borderAlpha,x,y,alpha);},borderFade:function(x,y,rate_p,options_p){var fn,args,rate,type,options;fn="[PS.borderFade] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>4){return _error(fn+"Too many arguments");}rate=rate_p;if((rate!==PS.CURRENT)&&(rate!==PS.DEFAULT)){type=_typeOf(rate);if(type==="undefined"){rate=PS.CURRENT;}else{if(type==="number"){rate=Math.floor(rate);if(rate<0){rate=0;}}else{return _error(fn+"rate argument not a number");}}}options=_validFadeOptions(fn,options_p);if(options===PS.ERROR){return PS.ERROR;}return _beadExec(fn,_borderFade,x,y,rate,options);},glyph:function(x,y,glyph_p){var fn,args,glyph,type;fn="[PS.glyph] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}glyph=glyph_p;if(glyph!==PS.CURRENT){type=_typeOf(glyph);if(type==="undefined"){glyph=PS.CURRENT;}else{if(glyph===PS.DEFAULT){glyph=0;}else{if(type==="string"){if(glyph.length>0){glyph=glyph.charCodeAt(0);}else{glyph=0;}}else{if(type==="number"){glyph=Math.floor(glyph);if(glyph<1){glyph=0;}}else{return _error(fn+"glyph argument invalid");}}}}}return _beadExec(fn,_glyph,x,y,glyph);},glyphColor:function(x,y,p1,p2,p3){var fn,colors;fn="[PS.glyphColor] ";if(arguments.length<2){return _error(fn+"Missing argument(s)");}if(arguments.length>5){return _error(fn+"Too many arguments");}colors=_decodeColors(fn,p1,p2,p3);if(colors===PS.ERROR){return PS.ERROR;}return _beadExec(fn,_glyphColor,x,y,colors);},glyphAlpha:function(x,y,alpha_p){var fn,args,alpha,type;fn="[PS.glyphAlpha] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}alpha=alpha_p;if(alpha!==PS.CURRENT){type=_typeOf(alpha);if(type==="undefined"){alpha=PS.CURRENT;}else{if(type==="number"){alpha=Math.floor(alpha);if(alpha<0){alpha=0;}else{if(alpha>255){alpha=255;}}}else{if(alpha===PS.DEFAULT){alpha=_DEFAULTS.bead.glyph.color.a;}else{return _error(fn+"alpha argument invalid");}}}}return _beadExec(fn,_glyphAlpha,x,y,alpha);},glyphScale:function(x,y,scale_p){var fn,args,scale,type;fn="[PS.glyphScale] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many arguments");}scale=scale_p;if(scale!==PS.CURRENT){type=_typeOf(scale);if(type==="undefined"){scale=PS.CURRENT;}else{if(type==="number"){scale=Math.floor(scale);if(scale<50){scale=50;}else{if(scale>100){scale=100;}}}else{if(scale===PS.DEFAULT){scale=_DEFAULTS.bead.glyph.scale;}else{return _error(fn+"scale argument invalid");}}}}return _beadExec(fn,_glyphScale,x,y,scale);},glyphFade:function(x,y,rate_p,options_p){var fn,args,rate,type,options;fn="[PS.glyphFade] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>4){return _error(fn+"Too many arguments");}rate=rate_p;if((rate!==PS.CURRENT)&&(rate!==PS.DEFAULT)){type=_typeOf(rate);if(type==="undefined"){rate=PS.CURRENT;}else{if(type==="number"){rate=Math.floor(rate);if(rate<0){rate=0;}}else{return _error(fn+"rate argument not a number");}}}options=_validFadeOptions(fn,options_p);if(options===PS.ERROR){return PS.ERROR;}return _beadExec(fn,_glyphFade,x,y,rate,options);},statusText:function(strP){var fn,str,type;fn="[PS.statusText] ";if(arguments.length>1){return _error(fn+"Too many arguments");}str=strP;type=_typeOf(str);if((str!==PS.CURRENT)&&(type!=="undefined")){if(str===PS.DEFAULT){str=_DEFAULTS.status.text;}else{if(type!=="string"){str=str.toString();}}_status.div.value=_status.text=str;}return _status.text;},statusColor:function(p1,p2,p3){var fn,colors,current,fader,rgb,r,g,b;fn="[PS.statusColor] ";if(arguments.length>3){return _error(fn+"Too many arguments");}colors=_decodeColors(fn,p1,p2,p3);if(colors===PS.ERROR){return PS.ERROR;}current=_status.color;fader=_status.fader;rgb=colors.rgb;if(rgb!==PS.CURRENT){if(rgb===null){r=colors.r;if(r===PS.CURRENT){colors.r=r=current.r;}else{if(r===PS.DEFAULT){colors.r=r=_DEFAULTS.status.color.r;}}g=colors.g;if(g===PS.CURRENT){colors.g=g=current.g;}else{if(g===PS.DEFAULT){colors.g=g=_DEFAULTS.status.color.g;}}b=colors.b;if(b===PS.CURRENT){colors.b=b=current.b;}else{if(b===PS.DEFAULT){colors.b=b=_DEFAULTS.status.color.b;}}colors.rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;}else{if(rgb===PS.DEFAULT){_copy(_DEFAULTS.status.color,colors);}}if((current.rgb!==colors.rgb)||((fader.rate>0)&&(fader.rgb!==null)&&(fader.rgb!==colors.rgb))){current.rgb=colors.rgb;r=colors.r;g=colors.g;b=colors.b;current.str=colors.str=_RSTR[r]+_GBSTR[g]+_BASTR[b];if(fader.rate>0){if(fader.rgb!==null){_startFader(fader,fader.r,fader.g,fader.b,255,r,g,b,255);}if(!fader.active){_startFader(fader,current.r,current.g,current.b,255,r,g,b,255);}else{_recalcFader(fader,r,g,b,255);}}else{_statusRGB(current);}current.r=r;current.g=g;current.b=b;}}return current.rgb;},statusFade:function(rate,options_p){var fn,fader,val,type,options;fn="[PS.statusFade] ";if(arguments.length>2){return _error(fn+"Too many arguments");}fader=_status.fader;val=rate;if(val!==PS.CURRENT){type=_typeOf(val);if(type!=="undefined"){if(val===PS.DEFAULT){fader.rate=_DEFAULTS.fader.rate;}else{if(type==="number"){val=Math.floor(val);if(val<0){val=0;}fader.rate=val;}else{return _error(fn+"rate argument invalid");}}}}options=_validFadeOptions(fn,options_p);if(options===PS.ERROR){return PS.ERROR;}val=options.rgb;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.rgb=_DEFAULTS.fader.rgb;}else{fader.rgb=val;}fader.r=options.r;fader.g=options.g;fader.b=options.b;}val=options.onEnd;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.onEnd=_DEFAULTS.fader.onEnd;}else{fader.onEnd=val;}}val=options.params;if(val!==PS.CURRENT){if(val===PS.DEFAULT){fader.params=_DEFAULTS.fader.params;}else{fader.params=val;}}return{rate:fader.rate,rgb:fader.rgb,onEnd:fader.onEnd,params:fader.params};},timerStart:function(ticks_p,exec_p){var fn,args,ticks,exec,type,obj,arglist,i,len,id;fn="[PS.timerStart] ";args=arguments.length;if(args<2){return _error(fn+"Argument(s) missing");}ticks=ticks_p;exec=exec_p;if(ticks===PS.DEFAULT){ticks=60;}else{type=_typeOf(ticks);if(type!=="number"){return _error(fn+"ticks argument invalid");}ticks=Math.floor(ticks);if(ticks<1){return _error(fn+"ticks argument less than one (1)");}}if(typeof exec!=="function"){return _error(fn+"exec argument not a function");}arglist=[];if(args>2){len=args-2;arglist.length=len;for(i=0;i<len;i+=1){arglist[i]=arguments[i+2];}}id=_TIMER_PREFIX+_timerCnt;_timerCnt+=1;obj={id:id,delay:ticks,count:ticks,exec:exec,arglist:arglist};_timers.push(obj);return id;},timerStop:function(id){var fn,args,i,len,timer;fn="[PS.timerStop] ";args=arguments.length;if(args<1){return _error(fn+"Argument missing");}if((typeof id!=="string")||(id.length<1)){return _error(fn+"id argument invalid");}len=_timers.length;for(i=0;i<len;i+=1){timer=_timers[i];if(timer.id===id){_timers.splice(i,1);return id;}}return _error(fn+"timer id '"+id+"' not found");},random:function(val_p){var fn,val;fn="[PS.random] ";if(arguments.length<1){return _error(fn+"Argument missing");}val=val_p;if(_typeOf(val)!=="number"){return _error(fn+"Argument not a number");}val=Math.floor(val);if(val<2){return 1;}val=Math.random()*val;val=Math.floor(val)+1;return val;},makeRGB:function(r_p,g_p,b_p){var fn,args,r,g,b;fn="[PS.makeRGB] ";args=arguments.length;if(args<3){return _error(fn+"Argument(s) missing");}if(args>3){return _error(fn+"Too many arguments");}r=r_p;g=g_p;b=b_p;if(_typeOf(r)!=="number"){return _error(fn+"r argument not a number");}r=Math.floor(r);if(r<0){r=0;}else{if(r>255){r=255;}}if(_typeOf(g)!=="number"){return _error(fn+"g argument not a number");}g=Math.floor(g);if(g<0){g=0;}else{if(g>255){g=255;}}if(_typeOf(b)!=="number"){return _error(fn+"b argument not a number");}b=Math.floor(b);if(b<0){b=0;}else{if(b>255){b=255;}}return((r*_RSHIFT)+(g*_GSHIFT)+b);},unmakeRGB:function(rgb_p,result_p){var fn,args,rgb,result,red,green,blue,rval,gval,type;fn="[PS.unmakeRGB] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>2){return _error(fn+"Too many arguments");}rgb=rgb_p;result=result_p;if(_typeOf(rgb)!=="number"){return _error(fn+"rgb argument not a number");}rgb=Math.floor(rgb);if(rgb<1){rgb=0;red=0;green=0;blue=0;}else{if(rgb>=16777215){rgb=16777215;red=255;green=255;blue=255;}else{red=rgb/_RSHIFT;red=Math.floor(red);rval=red*_RSHIFT;green=(rgb-rval)/_GSHIFT;green=Math.floor(green);gval=green*_GSHIFT;blue=rgb-rval-gval;}}type=_typeOf(result);if(type==="object"){result.rgb=rgb;result.r=red;result.g=green;result.b=blue;}else{if(type==="array"){if(result.length<3){result.length=3;}result[0]=red;result[1]=green;result[2]=blue;}else{return _error(fn+"result argument not an array or object reference");}}return result;},applyRect:function(left_p,top_p,width_p,height_p,exec_p){var fn,args,xmax,ymax,left,top,width,height,exec,right,bottom,x,y,result,arglist,len,i;fn="[PS.applyRect] ";args=arguments.length;if(args<5){return _error(fn+"Argument(s) missing");}xmax=_grid.x;ymax=_grid.y;left=left_p;top=top_p;width=width_p;height=height_p;exec=exec_p;if(left===PS.DEFAULT){left=0;}else{if(_typeOf(left)==="number"){left=Math.floor(left);if(left>=xmax){return PS.DONE;}if(left<0){left=0;}}else{return _error(fn+"left argument invalid");}}if(top===PS.DEFAULT){top=0;}else{if(_typeOf(top)==="number"){top=Math.floor(top);if(top>=ymax){return PS.DONE;}if(top<0){top=0;}}else{return _error(fn+"top argument invalid");}}if(width===PS.DEFAULT){width=xmax-left;}else{if(_typeOf(width)==="number"){width=Math.floor(width);if(width<1){return PS.DONE;}if((left+width)>xmax){width=xmax-left;}}else{return _error(fn+"width argument invalid");}}right=left+width;if(height===PS.DEFAULT){height=ymax-top;}else{if(_typeOf(height)==="number"){height=Math.floor(height);if(height<1){return PS.DONE;}if((top+height)>ymax){height=ymax-top;}}else{return _error(fn+"height argument invalid");}}bottom=top+height;if(!exec||(typeof exec!=="function")){return _error(fn+"exec argument not a function");}arglist=[0,0];if(args>5){len=args-5;for(i=0;i<len;i+=1){arglist.push(arguments[i+5]);}}for(y=top;y<bottom;y+=1){arglist[1]=y;for(x=left;x<right;x+=1){arglist[0]=x;try{result=exec.apply(_EMPTY,arglist);}catch(err){result=_errorCatch(fn+"exec failed @"+x+", "+y+" ["+err.message+"]",err);}if(result===PS.ERROR){return PS.ERROR;}}}return result;},hex:function(val_p,padding_p){var fn,val,type,padding,hex;fn="[PS.hex] ";val=val_p;type=_typeOf(val);if(type!=="number"){return _error(fn+"value argument invalid");}val=Math.floor(val);val=Math.abs(val);padding=padding_p;type=_typeOf(padding);if((type==="undefined")||(padding===PS.DEFAULT)){padding=2;}else{if(type==="number"){padding=Math.floor(padding);if(padding<1){padding=1;}}else{return _error(fn+"padding argument invalid");}}hex=Number(val).toString(16);while(hex.length<padding){hex="0"+hex;}return("0x"+hex);},keyRepeat:function(repeat_p,init_p,delay_p){var fn,type,repeat,delay,init;fn="[PS.keyRepeat] ";repeat=_isBoolean(repeat_p,_keyRepeat,true,true);if(repeat===PS.ERROR){return _error(fn+"repeat argument invalid");}init=init_p;type=_typeOf(init);if((type==="undefined")||(init===PS.DEFAULT)){init=_DEFAULT_KEY_DELAY*5;}else{if(init===PS.CURRENT){init=_keyInitRate;}else{if(type==="number"){init=Math.floor(init);if(init<1){init=1;}}else{return _error(fn+"init argument invalid");}}}delay=delay_p;type=_typeOf(delay);if((type==="undefined")||(delay===PS.DEFAULT)){delay=_DEFAULT_KEY_DELAY;}else{if(delay===PS.CURRENT){delay=_keyDelayRate;}else{if(type==="number"){delay=Math.floor(delay);if(delay<1){delay=1;}}else{return _error(fn+"delay argument invalid");}}}_keyRepeat=repeat;_keyInitRate=init;_keyDelayRate=delay;return{repeat:_keyRepeat,init:_keyInitRate,delay:_keyDelayRate};},imageLoad:function(filenameP,execP,formatP){var fn,args,filename,exec,format,ext,image,id,type;fn="[PS.imageLoad] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many argument(s)");}filename=filenameP;exec=execP;format=formatP;if((typeof filename!=="string")||(filename.length<1)){return _error(fn+"filename argument invalid");}ext=filename.substr(filename.lastIndexOf(".")+1);ext=ext.toLowerCase();if((ext!=="png")&&(ext!=="jpg")&&(ext!=="jpeg")&&(ext!=="bmp")){return _error(fn+"filename extension invalid");}if(typeof exec!=="function"){return _error(fn+"exec argument invalid");}type=_typeOf(format);if((type==="undefined")||(format===PS.DEFAULT)){format=4;}else{if(type!=="number"){return _error(fn+"format argument invalid");}format=Math.floor(format);if((format<1)&&(format>4)){return _error(fn+"format argument is not 1, 2, 3 or 4");}}id=_IMAGE_PREFIX+_imageCnt;_imageCnt+=1;_imageList.push({source:filename,id:id,exec:exec,format:format});try{image=new Image();image.setAttribute("data-id",id);image.onload=function(){_imageLoad(image);};image.onerror=function(){_imageError(image);};image.src=filename;}catch(err){return _errorCatch(fn+"Error loading "+filename+" ["+err.message+"]",err);}return id;},imageBlit:function(imageP,xposP,yposP,regionP){var fn,args,xmax,ymax,image,xpos,ypos,region,w,h,format,data,type,top,left,width,height,plane,val,wsize,rowptr,ptr,drawx,drawy,y,x,r,g,b,a,rgb,rval,gval,i,bead,color,any;fn="[PS.imageBlit] ";args=arguments.length;if(args<3){return _error(fn+"Missing argument(s)");}if(args>4){return _error(fn+"Too many arguments");}xmax=_grid.x;ymax=_grid.y;image=imageP;xpos=xposP;ypos=yposP;region=regionP;if(_validImage(fn,image)===PS.ERROR){return PS.ERROR;}w=image.width;h=image.height;format=image.pixelSize;data=image.data;type=_typeOf(xpos);if((type==="undefined")||(xpos===PS.DEFAULT)){xpos=0;}else{if(type==="number"){xpos=Math.floor(xpos);}else{return _error(fn+"xpos argument invalid");}}type=_typeOf(ypos);if((type==="undefined")||(ypos===PS.DEFAULT)){ypos=0;}else{if(type==="number"){ypos=Math.floor(ypos);}else{return _error(fn+"ypos argument invalid");}}if((xpos>=xmax)||(ypos>=ymax)||((xpos+w)<1)||((ypos+h)<1)){return false;}type=_typeOf(region);if((type==="undefined")||(region===PS.DEFAULT)){top=0;left=0;width=w;height=h;}else{if(type==="object"){left=region.left;type=_typeOf(left);if((type==="undefined")||(left===PS.DEFAULT)){left=0;}else{if(type!=="number"){return _error(fn+"region.left invalid");}left=Math.floor(left);if(left<0){left=0;}else{if(left>=w){return _error(fn+"region.left outside image");}}}top=region.top;type=_typeOf(top);if((type==="undefined")||(top===PS.DEFAULT)){top=0;}else{if(type!=="number"){return _error(fn+"region.top invalid");}top=Math.floor(top);if(top<0){top=0;}else{if(top>=h){return _error(fn+"region.top outside image");}}}width=region.width;type=_typeOf(width);if((type==="undefined")||(width===PS.DEFAULT)){width=w-left;}else{if(type!=="number"){return _error(fn+"region.width invalid");}width=Math.floor(width);if(width<1){return false;}if((left+width)>w){width=w-left;}}if((xpos+width)<1){return false;}height=region.height;type=_typeOf(height);if((type==="undefined")||(height===PS.DEFAULT)){height=h-top;}else{if(type!=="number"){return _error(fn+"region.height invalid");}height=Math.floor(height);if(height<1){return false;}if((top+height)>h){height=h-top;}}if((ypos+height)<1){return false;}}else{return _error(fn+"region argument invalid");}}if(xpos<0){width+=xpos;if(width<1){return false;}left-=xpos;xpos=0;}val=xpos+width;if(val>xmax){width=xmax-xpos;}if(width<1){return false;}if(ypos<0){height+=ypos;if(height<1){return false;}top-=ypos;ypos=0;}val=ypos+height;if(val>ymax){height=ymax-ypos;}if(height<1){return false;}wsize=(w*format);any=false;a=255;plane=_grid.plane;rowptr=(top*wsize)+(left*format);drawy=ypos;for(y=0;y<height;y+=1){ptr=rowptr;drawx=xpos;for(x=0;x<width;x+=1){i=drawx+(drawy*xmax);bead=_beads[i];if(bead.active){any=true;if(format<3){rgb=data[ptr];r=rgb/_RSHIFT;r=Math.floor(r);rval=r*_RSHIFT;g=(rgb-rval)/_GSHIFT;g=Math.floor(g);gval=g*_GSHIFT;b=rgb-rval-gval;if(format===2){a=data[ptr+1];}}else{r=data[ptr];g=data[ptr+1];b=data[ptr+2];rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;if(format===4){a=data[ptr+3];}}color=_colorPlane(bead,plane);color.r=r;color.g=g;color.b=b;color.a=a;color.rgb=rgb;_recolor(bead);}drawx+=1;ptr+=format;}drawy+=1;rowptr+=wsize;}if(any){_gridDraw();}return true;},imageCapture:function(formatP,regionP){var fn,args,format,region,type,w,h,data,top,left,width,height,total,output,right,bottom,id,cnt,x,y,i,bead,color;fn="[PS.imageCapture] ";args=arguments.length;if(args>2){return _error(fn+"Too many arguments");}format=formatP;region=regionP;type=_typeOf(format);if((type==="undefined")||(format===PS.DEFAULT)){format=3;}else{if(type!=="number"){return _error(fn+"format argument invalid");}format=Math.floor(format);if((format<1)&&(format>4)){return _error(fn+"format argument is not 1, 2, 3 or 4");}}w=_grid.x;h=_grid.y;type=_typeOf(region);if((type==="undefined")||(region===PS.DEFAULT)){top=0;left=0;width=w;height=h;}else{if(type==="object"){left=region.left;type=_typeOf(left);if((type==="undefined")||(left===PS.DEFAULT)){left=0;}else{if(type!=="number"){return _error(fn+"region.left not a number");}left=Math.floor(left);if(left<0){left=0;}else{if(left>=w){return _error(fn+"region.left outside grid");}}}top=region.top;type=_typeOf(top);if((type==="undefined")||(top===PS.DEFAULT)){top=0;}else{if(type!=="number"){return _error(fn+"region.top not a number");}top=Math.floor(top);if(top<0){top=0;}else{if(top>=h){return _error(fn+"region.top outside grid");}}}width=region.width;type=_typeOf(width);if((type==="undefined")||(width===PS.DEFAULT)){width=w-left;}else{if(type!=="number"){return _error(fn+"region.width not a number");}width=Math.floor(width);if((width<1)||((left+width)>w)){width=w-left;}}height=region.height;type=_typeOf(height);if((type==="undefined")||(height===PS.DEFAULT)){height=h-top;}else{if(type!=="number"){return _error(fn+"region.height not a number");}height=Math.floor(height);if((height<1)||((top+height)>h)){height=h-top;}}}else{return _error(fn+"region argument invalid");}}id=_IMAGE_PREFIX+_imageCnt;_imageCnt+=1;output={source:PS.GRID,id:id,width:width,height:height,pixelSize:format,valid:true,data:[]};total=width*height;if(total<1){return output;}data=output.data;data.length=total*format;right=left+width;bottom=top+height;cnt=0;for(y=top;y<bottom;y+=1){for(x=left;x<right;x+=1){i=x+(y*w);bead=_beads[i];color=bead.color;if(format<3){data[cnt]=color.rgb;if(format===2){data[cnt+1]=color.a;}}else{data[cnt]=color.r;data[cnt+1]=color.g;data[cnt+2]=color.b;if(format===4){data[cnt+3]=color.a;}}cnt+=format;}}return output;},imageDump:function(imageP,regionP,formatP,linelenP,hexP){var fn,args,image,region,format,linelen,hex,w,h,psize,data,type,top,left,width,height,total,str,wsize,pcnt,done,a,rowptr,ptr,y,x,r,g,b,rgb,rval,gval;fn="[PS.imageDump] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>5){return _error(fn+"Too many arguments");}image=imageP;region=regionP;format=formatP;linelen=linelenP;if(_validImage(fn,image)===PS.ERROR){return PS.ERROR;}w=image.width;h=image.height;psize=image.pixelSize;data=image.data;type=_typeOf(region);if((type==="undefined")||(region===PS.DEFAULT)){top=0;left=0;width=w;height=h;}else{if(type==="object"){left=region.left;type=_typeOf(left);if((type==="undefined")||(left===PS.DEFAULT)){left=0;}else{if(type!=="number"){return _error(fn+"region.left invalid");}left=Math.floor(left);if(left<0){left=0;}else{if(left>=w){return _error(fn+"region.left outside grid");}}}top=region.top;type=_typeOf(top);if((type==="undefined")||(top===PS.DEFAULT)){top=0;}else{if(type!=="number"){return _error(fn+"region.top invalid");}top=Math.floor(top);if(top<0){top=0;}else{if(top>=h){return _error(fn+"region.top outside grid");}}}width=region.width;type=_typeOf(width);if((type==="undefined")||(width===PS.DEFAULT)){width=w-left;}else{if(type!=="number"){return _error(fn+"region.width invalid");}width=Math.floor(width);if((width<1)||((left+width)>w)){width=w-left;}}height=region.height;type=_typeOf(height);if((type==="undefined")||(height===PS.DEFAULT)){height=h-top;}else{if(type!=="number"){return _error(fn+"region.height invalid");}height=Math.floor(height);if((height<1)||((top+height)>h)){height=h-top;}}}else{return _error(fn+"region argument invalid");}}total=width*height;type=_typeOf(format);if((type==="undefined")||(format===PS.DEFAULT)){format=psize;}else{if(type!=="number"){return _error(fn+"format argument invalid");}format=Math.floor(format);if((format<1)||(format>4)){return _error(fn+"format argument is not 1, 2, 3 or 4");}}type=_typeOf(linelen);if((type==="undefined")||(linelen===PS.DEFAULT)){linelen=width;}else{if(type!=="number"){return _error(fn+"length argument invalid");}linelen=Math.floor(linelen);if(linelen<1){linelen=1;}if(linelen>total){linelen=total;}}hex=_isBoolean(hexP,PS.ERROR,true,true);if(hex===PS.ERROR){return _error(fn+"hex argument invalid");}str="\nvar myImage = {\n\twidth : "+width+", height : "+height+", pixelSize : "+format+",\n\tdata : [";if(total<1){str+="]\n};\n";PS.debug(str);return PS.DONE;}str+="\n\t";a=255;done=pcnt=0;wsize=(w*psize);rowptr=(top*wsize)+(left*psize);for(y=0;y<height;y+=1){ptr=rowptr;for(x=0;x<width;x+=1){if(psize<3){rgb=data[ptr];if(rgb<1){r=g=b=0;}else{if(rgb>=16777215){r=g=b=255;}else{r=rgb/_RSHIFT;r=Math.floor(r);rval=r*_RSHIFT;g=(rgb-rval)/_GSHIFT;g=Math.floor(g);gval=g*_GSHIFT;b=rgb-rval-gval;}}if(psize===2){a=data[ptr+1];}}else{r=data[ptr];g=data[ptr+1];b=data[ptr+2];rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;if(psize===4){a=data[ptr+3];}}str+=_outputPixel(format,hex,rgb,r,g,b,a);done+=1;if(done<total){str+=",";pcnt+=1;if(pcnt<linelen){str+=" ";}else{pcnt=0;str+="\n\t";}}ptr+=psize;}rowptr+=wsize;}str+="\n\t]\n};\n";PS.debug(str);return PS.DONE;},spriteSolid:function(widthP,heightP){var fn,args,width,height,s;fn="[PS.spriteSolid] ";args=arguments.length;if(args<2){return _error(fn+"Missing argument(s)");}if(args>2){return _error(fn+"Too many argument(s)");}width=widthP;height=heightP;if(width===PS.DEFAULT){width=1;}else{if(_typeOf(width)==="number"){width=Math.floor(width);if(width<1){width=1;}}else{return _error(fn+"width argument invalid");}}if(height===PS.DEFAULT){height=1;}else{if(_typeOf(height)==="number"){height=Math.floor(height);if(height<1){height=1;}}else{return _error(fn+"height argument invalid");}}s=_newSprite();s.width=width;s.height=height;s.color={rgb:0,r:0,g:0,b:0,a:255};return s.id;},spriteSolidColor:function(sprite,p1,p2,p3){var fn,args,s,colors,current,rgb,r,g,b;fn="[PS.spriteSolidColor] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>4){return _error(fn+"Too many argument(s)");}s=_getSprite(sprite,fn);if(s===PS.ERROR){return PS.ERROR;}current=s.color;if(!current){return _error(fn+"Cannot set color of image sprite "+s.id);}colors=_decodeColors(fn,p1,p2,p3);if(colors===PS.ERROR){return PS.ERROR;}rgb=colors.rgb;if(rgb!==PS.CURRENT){if(rgb===null){r=colors.r;if(r===PS.CURRENT){colors.r=r=current.r;}else{if(r===PS.DEFAULT){colors.r=r=0;}}g=colors.g;if(g===PS.CURRENT){colors.g=g=current.g;}else{if(g===PS.DEFAULT){colors.g=g=0;}}b=colors.b;if(b===PS.CURRENT){colors.b=b=current.b;}else{if(b===PS.DEFAULT){colors.b=b=0;}}colors.rgb=rgb=(r*_RSHIFT)+(g*_GSHIFT)+b;}else{if(rgb===PS.DEFAULT){colors.rgb=rgb=0;colors.r=0;colors.g=0;colors.b=0;}}if(current.rgb!==rgb){current.rgb=rgb;current.r=colors.r;current.g=colors.g;current.b=colors.b;if(s.visible&&s.placed){_drawSprite(s);_gridDraw();}}}return current.rgb;},spriteSolidAlpha:function(spriteP,alphaP){var fn,args,sprite,alpha,s,current,type;fn="[PS.spriteSolidAlpha] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>2){return _error(fn+"Too many argument(s)");}sprite=spriteP;alpha=alphaP;s=_getSprite(sprite,fn);if(s===PS.ERROR){return PS.ERROR;}current=s.color;if(!current){return _error(fn+"Cannot set alpha of image sprite "+s.id);}type=_typeOf(alpha);if((type!=="undefined")&&(alpha!==PS.CURRENT)){if(alpha===PS.DEFAULT){alpha=255;}else{if(type==="number"){alpha=Math.floor(alpha);if(alpha<0){alpha=0;}else{if(alpha>255){alpha=255;}}}else{return _error(fn+"alpha argument invalid");}}if(current.a!==alpha){current.a=alpha;if(s.visible&&s.placed){_drawSprite(s);_gridDraw();}}}return current.a;},spriteImage:function(image,region){var fn,args,w,h,format,data,type,top,left,width,height,ndata,wsize,rowptr,ptr,x,y,i,rgb,r,g,b,a,rval,gval,s;fn="[PS.spriteImage] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>2){return _error(fn+"Too many argument(s)");}if(_validImage(fn,image)===PS.ERROR){return PS.ERROR;}left=top=0;width=w=image.width;height=h=image.height;format=image.pixelSize;data=image.data;type=_typeOf(region);if((type!=="undefined")&&(region!==PS.DEFAULT)){if(type!=="object"){return _error(fn+"region argument invalid");}left=region.left;type=_typeOf(left);if((type==="undefined")||(left===PS.DEFAULT)){left=0;}else{if(type!=="number"){return _error(fn+"region.left invalid");}left=Math.floor(left);if(left<0){left=0;}else{if(left>=w){return _error(fn+"region.left outside image");}}}top=region.top;type=_typeOf(top);if((type==="undefined")||(top===PS.DEFAULT)){top=0;}else{if(type!=="number"){return _error(fn+"region.top invalid");}top=Math.floor(top);if(top<0){top=0;}else{if(top>=h){return _error(fn+"region.top outside image");}}}width=region.width;type=_typeOf(width);if((type==="undefined")||(width===PS.DEFAULT)){width=w-left;}else{if(type!=="number"){return _error(fn+"region.width invalid");}width=Math.floor(width);if((width<1)||((left+width)>w)){width=w-left;}}height=region.height;type=_typeOf(height);if((type==="undefined")||(height===PS.DEFAULT)){height=h-top;}else{if(type!=="number"){return _error(fn+"region.height invalid");}height=Math.floor(height);if((height<1)||((top+height)>h)){height=h-top;}}}ndata=[];ndata.length=width*height*4;a=255;wsize=(w*format);rowptr=(top*wsize)+(left*format);i=0;for(y=0;y<height;y+=1){ptr=rowptr;for(x=0;x<width;x+=1){if(format<3){rgb=data[ptr];if(rgb<1){rgb=r=g=b=0;}else{if(rgb>=16777215){rgb=16777215;r=g=b=255;}else{r=rgb/_RSHIFT;r=Math.floor(r);rval=r*_RSHIFT;g=(rgb-rval)/_GSHIFT;g=Math.floor(g);gval=g*_GSHIFT;b=rgb-rval-gval;}}if(format===2){a=data[ptr+1];}}else{r=data[ptr];g=data[ptr+1];b=data[ptr+2];if(format===4){a=data[ptr+3];}}ndata[i]=r;ndata[i+1]=g;ndata[i+2]=b;ndata[i+3]=a;ptr+=format;i+=4;}rowptr+=wsize;}s=_newSprite();s.width=width;s.height=height;s.image={id:_IMAGE_PREFIX+_imageCnt,width:width,height:height,pixelSize:4,data:ndata};_imageCnt+=1;return s.id;},spriteShow:function(spriteP,showP){var fn,args,sprite,show,s;fn="[PS.spriteShow] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>2){return _error(fn+"Too many argument(s)");}sprite=spriteP;s=_getSprite(sprite,fn);if(s===PS.ERROR){return PS.ERROR;}show=_isBoolean(showP,PS.CURRENT,true,PS.CURRENT);if(show===PS.ERROR){return _error(fn+"show argument invalid");}if(show!==PS.CURRENT){if(s.visible!==show){s.visible=show;if(s.placed){if(show){_drawSprite(s);_collisionCheck(s,sprite);}else{_eraseSprite(s);}_gridDraw();}}}return s.visible;},spriteAxis:function(spriteP,xP,yP){var fn,args,sprite,x,y,s,type;fn="[PS.spriteAxis] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many argument(s)");}sprite=spriteP;x=xP;y=yP;s=_getSprite(sprite,fn);if(s===PS.ERROR){return PS.ERROR;}type=_typeOf(x);if((type==="undefined")||(x===PS.CURRENT)){x=s.ax;}else{if(x===PS.DEFAULT){x=0;}else{if(type==="number"){x=Math.floor(x);}else{return _error(fn+"x argument invalid");}}}type=_typeOf(y);if((type==="undefined")||(y===PS.CURRENT)){y=s.ay;}else{if(y===PS.DEFAULT){y=0;}else{if(type==="number"){y=Math.floor(y);}else{return _error(fn+"y argument invalid");}}}if((x!==s.ax)||(y!==s.ay)){s.ax=x;s.ay=y;if(s.visible&&s.placed){_drawSprite(s);_collisionCheck(s,sprite);_gridDraw();}}return{x:s.ax,y:s.ay};},spritePlane:function(spriteP,planeP){var fn,args,sprite,plane,s,type;fn="[PS.spritePlane] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>2){return _error(fn+"Too many arguments");}sprite=spriteP;plane=planeP;s=_getSprite(sprite,fn);if(s===PS.ERROR){return PS.ERROR;}type=_typeOf(plane);if((type!=="undefined")&&(plane!==PS.CURRENT)){if(plane===PS.DEFAULT){plane=0;}else{if(type==="number"){plane=Math.floor(plane);if(plane<1){plane=0;}}else{return _error(fn+"plane argument invalid");}}if(s.plane!==plane){if(s.visible&&s.placed){_eraseSprite(s);}s.plane=plane;if(s.visible&&s.placed){_drawSprite(s);_gridDraw();}}}if(s.plane<0){return 0;}return s.plane;},spriteMove:function(spriteP,xP,yP){var fn,args,sprite,x,y,s,type,h_left,h_top,h_width,h_height,v_left,v_top,v_width,v_height,any;fn="[PS.spriteMove] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>3){return _error(fn+"Too many argument(s)");}sprite=spriteP;x=xP;y=yP;s=_getSprite(sprite,fn);if(s===PS.ERROR){return PS.ERROR;}type=_typeOf(x);if((type==="undefined")||(x===PS.CURRENT)){x=s.x;}else{if(x===PS.DEFAULT){x=0;}else{if(type==="number"){x=Math.floor(x);}else{return _error(fn+"x argument invalid");}}}type=_typeOf(y);if((type==="undefined")||(y===PS.CURRENT)){y=s.y;}else{if(y===PS.DEFAULT){y=0;}else{if(type==="number"){y=Math.floor(y);}else{return _error(fn+"y argument invalid");}}}if(!s.placed||(x!==s.x)||(y!==s.y)){any=false;if(s.plane<0){s.plane=_grid.plane;}if(s.visible&&s.placed){h_top=s.y;h_height=s.height;if(x>s.x){h_width=x-s.x;h_left=s.x;}else{if(s.x>x){h_width=s.x-x;h_left=s.x+s.width-h_width;}else{h_width=0;}}if(h_width>=s.width){any=true;_eraseSprite(s);}else{v_left=s.x;v_width=s.width;if(y>s.y){v_height=y-s.y;v_top=s.y;}else{if(s.y>y){v_height=s.y-y;v_top=s.y+s.height-v_height;}else{v_height=0;}}if(v_height>=s.height){any=true;_eraseSprite(s);}else{if(v_height<1){any=true;_eraseSprite(s,h_left,h_top,h_width,h_height);}else{if(v_width<1){any=true;_eraseSprite(s,v_left,v_top,v_width,v_height);}else{any=true;v_width-=h_width;if(x>s.x){v_left+=h_width;}_eraseSprite(s,h_left,h_top,h_width,h_height);_eraseSprite(s,v_left,v_top,v_width,v_height);}}}}}s.x=x;s.y=y;s.placed=true;if(s.visible){any=true;_drawSprite(s);_collisionCheck(s,sprite);}if(any){_gridDraw();}}return{x:s.x,y:s.y};},spriteCollide:function(sprite,execP){var fn,args,s,exec,type;fn="[PS.spriteCollide] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>2){return _error(fn+"Too many arguments");}s=_getSprite(sprite,fn);if(s===PS.ERROR){return PS.ERROR;}exec=execP;type=_typeOf(exec);if((type!=="undefined")&&(exec!==PS.CURRENT)){if(exec===PS.DEFAULT){exec=null;}else{if(type!=="function"){return _error(fn+"exec argument not a function");}}if(s.collide!==exec){s.collide=exec;if(exec&&s.visible&&s.placed){_collisionCheck(s,sprite);}}}return s.collide;},spriteDelete:function(sprite){var fn,args,len,i,s;fn="[PS.spriteDelete] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument");}if(args>1){return _error(fn+"Too many arguments");}if((typeof sprite!=="string")||(sprite.length<1)){return _error(fn+"sprite argument invalid");}len=_sprites.length;for(i=0;i<len;i+=1){s=_sprites[i];if(s.id===sprite){_eraseSprite(s);_sprites.splice(i,1);_gridDraw();return PS.DONE;}}return _error(fn+"sprite id '"+sprite+"' not found");},audioLoad:function(filename,params){var fn,result;fn="[PS.audioLoad] ";if(arguments.length<1){return _error(fn+"Missing argument(s)");}if(arguments.length>2){return _error(fn+"Too many arguments");}result=AQ.load(filename,params);if(result===AQ.ERROR){return PS.ERROR;}return result.channel;},audioPlay:function(filename_p,params_p){var fn,args,filename,params,type,result;fn="[PS.audioPlay] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>2){return _error(fn+"Too many arguments");}filename=filename_p;params=params_p;type=_typeOf(params);if(type==="undefined"){params={};}else{if(type!=="object"){return _error(fn+"params argument invalid");}}params.autoplay=true;result=AQ.load(filename,params);if(result===AQ.ERROR){return PS.ERROR;}return result.channel;},audioPause:function(channel_id){var fn,args,result;fn="[PS.audioPause] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>1){return _error(fn+"Too many arguments");}result=AQ.pause(channel_id);if(result===AQ.ERROR){return PS.ERROR;}return result;},audioStop:function(channel_id){var fn,args,result;fn="[PS.audioStop] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>1){return _error(fn+"Too many arguments");}result=AQ.stop(channel_id);if(result===AQ.ERROR){return PS.ERROR;}if(result===AQ.DONE){return PS.DONE;}return result;},piano:function(val_p,flag_p){var fn,len,type,val,flag,str;fn="[PS.piano] ";len=_PIANO_FILES.length;val=val_p;type=_typeOf(val);if(type!=="number"){return _error(fn+"index argument invalid");}val=Math.floor(val);if(val<1){val=1;}else{if(val>len){val=len;}}flag=flag_p;if((flag!==true)&&(flag!==false)){type=_typeOf(flag);if(type==="undefined"){flag=false;}else{if(type!=="number"){return _error(fn+"flag argument invalid");}}}str="piano_"+_PIANO_FILES[val-1];if(flag){str="l_"+str;}return str;},harpsichord:function(val_p,flag_p){var fn,len,type,val,flag,str;fn="[PS.harpsichord] ";len=_HCHORD_FILES.length;val=val_p;type=_typeOf(val);if(type!=="number"){return _error(fn+"index argument invalid");}val=Math.floor(val);if(val<1){val=1;}else{if(val>len){val=len;}}flag=flag_p;if((flag!==true)&&(flag!==false)){type=_typeOf(flag);if(type==="undefined"){flag=false;}else{if(type!=="number"){return _error(fn+"flag argument invalid");}}}str="hchord_"+_HCHORD_FILES[val-1];if(flag){str="l_"+str;}return str;},xylophone:function(val_p){var fn,len,type,val,str;fn="[PS.xylophone] ";len=_XYLO_FILES.length;val=val_p;type=_typeOf(val);if(type!=="number"){return _error(fn+"index argument invalid");}val=Math.floor(val);if(val<1){val=1;}else{if(val>len){val=len;}}str="xylo_"+_XYLO_FILES[val-1];return str;},debug:function(textP){var fn,text,type,e;fn="[PS.debug] ";if(arguments.length>1){return _error(fn+"Too many arguments");}text=textP;type=_typeOf(text);if(type==="undefined"){text="";}else{if(type!=="string"){text=text.toString();}}_debugOpen();if(text.length>0){e=document.getElementById(_MONITOR_ID);e.value+=text;e.scrollTop=e.scrollHeight;}_scrollDown();return PS.DONE;},debugClose:function(){var fn,e;fn="[PS.debugClose] ";if(arguments.length>0){return _error(fn+"Too many arguments");}e=document.getElementById(_DEBUG_ID);e.style.display="none";_debugging=false;return PS.DONE;},debugClear:function(){var fn,e;fn="[PS.debugClear] ";if(arguments.length>0){return _error(fn+"Too many arguments");}e=document.getElementById(_MONITOR_ID);e.value="";return PS.DONE;},line:function(x1_p,y1_p,x2_p,y2_p){var fn,args,x1,y1,x2,y2,path;fn="[PS.line] ";args=arguments.length;if(args<4){return _error(fn+"Missing argument(s)");}if(args>4){return _error(fn+"Too many arguments");}x1=x1_p;y1=y1_p;x2=x2_p;y2=y2_p;if(_typeOf(x1)==="number"){x1=Math.floor(x1);}else{return _error(fn+"x1 argument not a number");}if(_typeOf(y1)==="number"){y1=Math.floor(y1);}else{return _error(fn+"y1 argument not a number");}if(_typeOf(x2)==="number"){x2=Math.floor(x2);}else{return _error(fn+"x2 argument not a number");}if(_typeOf(y2)==="number"){y2=Math.floor(y2);}else{return _error(fn+"y2 argument not a number");}path=_line(x1,y1,x2,y2);return path;},pathMap:function(image){var fn,args,pm;fn="[PS.pathMap] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument(s)");}if(args>1){return _error(fn+"Too many arguments");}if(_validImage(fn,image)===PS.ERROR){return PS.ERROR;}if(image.pixelSize!==1){return _error(fn+"image is not format 1");}pm=_newMap(image.width,image.height,image.data);return pm.id;},pathFind:function(pathmap_p,x1_p,y1_p,x2_p,y2_p,options_p){var fn,args,pathmap,x1,y1,x2,y2,options,pm,type,path,val,no_diagonals,cut_corners;fn="[PS.pathFind] ";args=arguments.length;if(args<5){return _error(fn+"Missing argument(s)");}if(args>6){return _error(fn+"Too many arguments");}pathmap=pathmap_p;x1=x1_p;y1=y1_p;x2=x2_p;y2=y2_p;options=options_p;if((typeof pathmap!=="string")||(pathmap.length<1)){return _error(fn+"pathmap argument invalid");}pm=_getMap(pathmap);if(!pm){return _error(fn+pathmap+" not found");}if(_typeOf(x1)==="number"){x1=Math.floor(x1);if((x1<0)||(x1>=pm.width)){return _error(fn+"x1 argument is outside "+pathmap);}}else{return _error(fn+"x1 argument not a number");}if(_typeOf(y1)==="number"){y1=Math.floor(y1);if((y1<0)||(y1>=pm.height)){return _error(fn+"y1 argument is outside "+pathmap);}}else{return _error(fn+"y1 argument not a number");}if(_typeOf(x2)==="number"){x2=Math.floor(x2);if((x2<0)||(x2>=pm.width)){return _error(fn+"x2 argument is outside "+pathmap);}}else{return _error(fn+"x2 argument not a number");}if(_typeOf(y2)==="number"){y2=Math.floor(y2);if((y2<0)||(y2>=pm.height)){return _error(fn+"y2 argument is outside "+pathmap);}}else{return _error(fn+"y2 argument not a number");}no_diagonals=false;cut_corners=false;type=_typeOf(options);if((type!=="undefined")&&(options!==PS.DEFAULT)){if(type!=="object"){return _error(fn+"options argument invalid");}val=options.no_diagonals;if((val===true)||(val===false)){no_diagonals=val;}else{type=_typeOf(val);if((type==="undefined")||(val===PS.DEFAULT)){no_diagonals=false;}else{if(type==="number"){no_diagonals=(val!==0);}else{return _error(fn+"options.no_diagonals invalid");}}}val=options.cut_corners;if((val===true)||(val===false)){cut_corners=val;}else{type=_typeOf(val);if((type==="undefined")||(val===PS.DEFAULT)){cut_corners=false;}else{if(type==="number"){cut_corners=(val!==0);}else{return _error(fn+"options.cut_corners invalid");}}}}path=_findPath(pm,x1,y1,x2,y2,no_diagonals,cut_corners);return path;},pathData:function(pathmap_p,left_p,top_p,width_p,height_p,data_p){var fn,args,pathmap,left,top,width,height,data,pm,max,type,result;fn="[PS.pathData] ";args=arguments.length;if(args<5){return _error(fn+"Missing argument(s)");}if(args>6){return _error(fn+"Too many arguments");}pathmap=pathmap_p;left=left_p;top=top_p;width=width_p;height=height_p;data=data_p;if((typeof pathmap!=="string")||(pathmap.length<1)){return _error(fn+"pathmap argument invalid");}pm=_getMap(pathmap);if(!pm){return _error(fn+pathmap+" not found");}if(_typeOf(left)==="number"){left=Math.floor(left);if((left<0)||(left>=pm.width)){return _error(fn+"left argument is outside "+pathmap);}}else{return _error(fn+"left argument not a number");}if(_typeOf(top)==="number"){top=Math.floor(top);if((top<0)||(top>=pm.height)){return _error(fn+"top argument is outside "+pathmap);}}else{return _error(fn+"top argument not a number");}if(width===PS.DEFAULT){width=1;}else{if(_typeOf(width)==="number"){width=Math.floor(width);if(width<1){width=1;}else{max=pm.width-left;if(width>max){width=max;}}}else{return _error(fn+"width argument not a number");}}if(height===PS.DEFAULT){height=1;}else{if(_typeOf(height)==="number"){height=Math.floor(height);if(height<1){height=1;}else{max=pm.height-top;if(height>max){height=max;}}}else{return _error(fn+"height argument not a number");}}if((data!==PS.DEFAULT)&&(data!==PS.CURRENT)){type=_typeOf(data);if(type==="undefined"){data=PS.CURRENT;}else{if(type==="number"){if(data<0){return _error(fn+"data argument < 0");}}else{return _error(fn+"data argument not a number");}}}result=_pathData(pm,left,top,width,height,data);return result;},pathDelete:function(pathmap){var fn,args;fn="[PS.pathDelete] ";args=arguments.length;if(args<1){return _error(fn+"Missing argument");}if((typeof pathmap!=="string")||(pathmap.length<1)){return _error(fn+"pathmap argument invalid");}if(!_deleteMap(pathmap)){return _error(fn+pathmap+" not found");}return PS.DONE;},pathNear:function(pathmap,x1,y1,x2,y2){var fn,args,pm,result;fn="[PS.pathNear] ";args=arguments.length;if(args<5){return _error(fn+"Missing argument(s)");}if(args>5){return _error(fn+"Too many arguments");}if((typeof pathmap!=="string")||(pathmap.length<1)){return _error(fn+"pathmap argument invalid");}pm=_getMap(pathmap);if(!pm){return _error(fn+pathmap+" not found");}result=_pathNear(pm,x1,y1,x2,y2);return result;}};}());(function(){var lt,v,i,prefix;lt=0;v=["webkit","moz","ms","o"];for(i=0;(i<v.length)&&!window.requestAnimationFrame;i+=1){prefix=v[i];window.requestAnimationFrame=window[prefix+"RequestAnimationFrame"];window.cancelAnimationFrame=window[prefix+"CancelAnimationFrame"]||window[prefix+"CancelRequestAnimationFrame"];}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(cb,e){var ct,ttc,id;ct=new Date().getTime();ttc=Math.max(0,16-(ct-lt));id=window.setTimeout(function(){cb(ct+ttc);},ttc);lt=ct+ttc;return id;};}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(id){window.clearTimeout(id);};}}());
=======
var PS;(function(){"use strict";function _t(){if(Ot>=0){Ot-=1}else{Mt-=.05;if(Mt<=0){PS.timerStop(At);At=null;Mt=0}Nt.style.opacity=Mt}}function Dt(e){var t;t=typeof e;if(t==="number"){if(isNaN(e)){t="NaN"}}else if(t==="object"){if(e){if(e instanceof Array){t="array"}}else{t="null"}}return t}function Pt(e,t,n,r){var i,s;i=e;if(i!==true&&i!==false){if(i===null){i=false}else if(i===PS.CURRENT){i=t}else if(i===PS.DEFAULT){i=n}else{s=Dt(i);if(s==="undefined"){i=r}else if(s==="number"){i=i!==0}else{i=PS.ERROR}}}return i}function Ht(e,t){var n,r,i,s;for(n in e){if(e.hasOwnProperty(n)){r=e[n];s=Dt(r);if(s==="object"){i={};Ht(r,i);r=i}t[n]=r}}}function Bt(e){if(e.stopPropagation){e.stopPropagation()}else{e.cancelBubble=true}e.preventDefault();return false}function jt(){var e,t,n,r,i;e=[];for(t=0;t<arguments.length;t+=1){n=arguments[t];r=n-65536;i=n>65535?[55296+(r>>10),56320+(r&1023)]:[n];e.push(String.fromCharCode.apply(null,i))}return e.join("")}function Ft(e,t,n,r,i){var s,o,u,a,f,l,c,h,p;s=X.context;o=X.bead_size;u=e.left;a=e.top;f=o;l=o;c=e.border;h=e.radius;if(e.size<o||h>0||c.color.a<255&&c.width>0||!e.visible){s.fillStyle=i;s.fillRect(u,a,f,l);if(!e.visible){return}u+=e.margin;a+=e.margin;f=e.size;l=e.size}if(c.width>0){s.fillStyle=t;if(!h){s.fillRect(u,a,f,l)}else{p=Math.floor(f*h/100);p=s.fillRoundedRect(u,a,f,l,p)}u+=c.left;a+=c.top;f-=c.left+c.right;l-=c.top+c.bottom}s.fillStyle=n;if(!h){s.fillRect(u,a,f,l)}else{p=Math.floor(f*h/100);s.fillRoundedRect(u,a,f,l,p)}if(e.glyph.code>0){X.context.font=e.glyph.font;s.fillStyle=r;s.fillText(e.glyph.str,e.left+e.glyph.x,e.top+e.glyph.y)}}function It(e,t){var n,r;n=e.a*(1-t.a);r={r:Math.floor(t.r*t.a+e.r*n),g:Math.floor(t.g*t.a+e.g*n),b:Math.floor(t.b*t.a+e.b*n)};return r}function qt(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;r=t.r;i=t.g;s=t.b;o=e.planes;u=o.length;for(a=0;a<u;a+=1){l=o[a];f=l.color;c=f.r;h=f.g;p=f.b;d=f.a;if(d>0){if(d<255){v=Math.max(0,Math.min(d/255,1));m={r:r,g:i,b:s,a:1};g={r:c,g:h,b:p,a:v};y=It(m,g);r=y.r;i=y.g;s=y.b}else{r=c;i=h;s=p}}}c=r;h=i;p=s;n.rgb=c*T+h*N+p;n.r=c;n.g=h;n.b=p;n.str=q[c]+R[h]+U[p]}function Ut(e){var t,n,r,i,s,o,u,a,f;t=e.str;n=X.canvas;r=X.context;n.style.backgroundColor=t;if(X.left>0){r.clearRect(0,X.top,X.left,n.height)}if(X.right<n.width){r.clearRect(X.right,X.top,n.width-X.right,n.height)}if(X.bottom<n.height){r.clearRect(0,X.bottom,n.width,n.height-X.bottom)}document.body.style.backgroundColor=t;$.statusP.style.backgroundColor=t;$.inputP.style.backgroundColor=t;Nt.style.backgroundColor=t;for(i=0;i<X.count;i+=1){s=V[i];o=s.planes[0];u=o.color;if(u.a<255){qt(s,e,Rt);a=Rt.str}else{a=s.color.str}f=s.border.color;if(!s.visible||s.size<X.bead_size||s.radius>0||u.a<255||f.a<255){Ft(s,f.str,a,s.glyph.color.str,t)}}}function zt(e){var t,n,r;if(e.r>127){t=0}else{t=255}if(e.g>127){n=0}else{n=255}if(e.b>127){r=0}else{r=255}Nt.style.color=q[t]+R[n]+U[r]}function Wt(e){X.canvas.style.boxShadow=X.shadow.params+e.str}function Xt(e){$.statusP.style.color=e.str;$.inputP.style.color=e.str}function Vt(e,t){var n;n=V[t];Ft(n,n.border.color.str,e.str,n.glyph.color.str,X.color.str)}function $t(e,t){var n;n=V[t];Ft(n,e.str,n.color.str,n.glyph.color.str,X.color.str)}function Jt(e,t){var n;n=V[t];Ft(n,n.border.color.str,n.color.str,e.str,X.color.str)}function Kt(e){e.dirty=true;J=true}function Qt(){var e,t,n;if(J){e=X.count;for(t=0;t<e;t+=1){n=V[t];if(n.dirty){n.dirty=false;Ft(n,n.border.color.str,n.color.str,n.glyph.color.str,X.color.str)}}J=false}}function Gt(){var e;if(!xt){e=document.getElementById(n);e.style.display="inline";e=document.getElementById(l);e.value="";xt=true;Tt=false}}function Yt(e){if(typeof e!=="string"||e.length<1){e="???"}PS.debug("WARNING: "+e+"\n")}function tn(e){var t,n,r;t="";if(e.search(".js")!==-1){n=e.lastIndexOf("/")+1;r=e.substr(n).replace(/^[\s\(\)]+|[\s\(\)]+$/g,"");if(r.split(":").length===3){r=r.substr(0,r.lastIndexOf(":"))}if(r!==""){t+="    "+r+"\n"}}else if(en&&e.search(".htm")!==-1){t+="\n"+e}return t}function nn(e){var t,n,r,i;if(console&&console.log){console.log(e)}if(!e.split){return e}t=e.split("\n");i="";n=t.length;for(r=0;r<n;r+=1){i+=tn(t[r])}return i}function rn(e,t){var n;et=false;if(At){PS.timerStop(At)}if(typeof e!=="string"||e.length<1){e="???"}n="ERROR: "+e+"\n";Nt.style.opacity=1;Nt.innerHTML=n;if(Zt&&t){n+=nn(t.stack)+"\n"}PS.debug(n);if(Ct){PS.audioPlay(F.audio.error_sound,{path:F.audio.path})}return PS.ERROR}function sn(e){try{throw new Error("!")}catch(t){return rn(e,t)}}function on(){var e;e=document.getElementById(t);e.scrollTop=e.scrollHeight}function un(){rt=[];it=0}function an(e){Ht(F.fader,e);e.frames.length=0}function fn(e,t,n){var r;r={element:e,exec:t,execEnd:n,frames:[]};an(r);return r}function ln(e,t,n,r,i,s,o,u,a){var f,l,c,h,p,d,v,m,g,y,b,w,E,S;e.step=0;e.frames.length=0;if(t===s&&n===o&&r===u&&i===a){return}e.tr=s;e.tg=o;e.tb=u;e.ta=a;e.trgb=s*T+o*N+u;e.tstr=q[s]+R[o]+R[u]+z[a];f=t;l=n;c=r;h=i;if(t>s){g=-(t-s)}else{g=s-t}if(n>o){y=-(n-o)}else{y=o-n}if(r>u){b=-(r-u)}else{b=u-r}if(i>a){w=-(i-a)}else{w=a-i}if(e.rate<_){p=1}else{p=Math.ceil(e.rate/_)}d=100/p;v=0;do{E=false;m={};v+=d;if(v>=100){m.r=s;m.g=o;m.b=u;m.a=a}else{if(f!==s){S=v*g/100;f=t+S;f=Math.round(f);E=true}m.r=f;if(l!==o){S=v*y/100;l=n+S;l=Math.round(l);E=true}m.g=l;if(c!==u){S=v*b/100;c=r+S;c=Math.round(c);E=true}m.b=c;if(h!==a){S=v*w/100;h=i+S;h=Math.round(h);E=true}m.a=h}m.rgb=m.r*T+m.g*N+m.b;m.str=q[m.r]+R[m.g]+R[m.b]+z[m.a];e.frames.push(m);if(!E){return}}while(v<100)}function cn(e,t,n,r,i,s,o,u,a){ln(e,t,n,r,i,s,o,u,a);if(e.frames.length>0){e.kill=false;e.active=true;rt.push(e)}}function hn(e,t,n,r,i){var s,o,u,a;s=e.active;e.active=false;o=e.frames.length;if(o>0){u=e.step;if(u>=o){u=o-1}a=e.frames[u];ln(e,a.r,a.g,a.b,a.a,t,n,r,i)}if(e.frames.length>0){e.active=s}}function pn(){tt=[];nt=0}function dn(){var e,t,n,r,i,s,o,u,a,f,l,c,h;e="[_tick] ";t=false;it+=1;if(it>=_){it=0;n=rt.length;r=0;while(r<n){i=rt[r];o=i.frames.length;if(i.kill){rt.splice(r,1);n-=1}else if(i.active){s=i.frames[i.step];l=i.onStep;if(l){h=[o,i.step,s.rgb];if(i.params){h=h.concat(i.params)}try{f=l.apply(k,h);if(f===false||f===null){i.step=o-1;s=i.frames[i.step]}t=true}catch(p){rn(e+"fader .onStep failed ["+p.message+"]",p);return}}if(i.exec){try{i.exec(s,i.element)}catch(d){rn(e+"fader .exec failed ["+d.message+"]",d);return}}i.step+=1;if(i.step>=o){i.active=false;i.step=0;i.frames.length=0;if(i.execEnd){try{i.execEnd(s,i.element)}catch(v){rn(e+"fader .execEnd failed ["+v.message+"]",v);return}}l=i.onEnd;if(l){h=i.params;if(!h){h=[]}try{l.apply(k,h);t=true}catch(m){rn(e+"fader .onEnd failed ["+m.message+"]",m);return}}rt.splice(r,1);n-=1}else{r+=1}}else{r+=1}}}n=lt.length;if(pt&&n>0){if(dt>0){dt-=1}else{dt=vt;for(r=0;r<n;r+=1){u=lt[r];if(u){try{PS.keyDown(u,ct,ht);t=true}catch(g){rn(e+"Key repeat failed ["+g.message+"]",g);return}}}}}n=tt.length;if(n>0){r=0;while(r<n){a=tt[r];c=a.id;a.count-=1;if(a.count<1){a.count=a.delay;try{f=a.exec.apply(k,a.arglist);t=true}catch(y){f=rn(e+"Timed function failed ["+y.message+"]",y)}if(f===PS.ERROR){PS.timerStop(c)}n=tt.length}a=tt[r];if(a&&a.id===c){r+=1}}}if(t){Qt()}}function mn(e){var t,n,r,i,s,o,u,a,f;qt(e,X.color,vn);t=vn.rgb;n=e.color;r=vn.r;i=vn.g;s=vn.b;o=n.r;u=n.g;a=n.b;n.rgb=t;n.r=r;n.g=i;n.b=s;n.str=vn.str;if(e.visible){f=e.fader;if(f.rate>0){if(f.rgb!==null){cn(f,f.r,f.g,f.b,255,r,i,s,255)}else if(!f.active){cn(f,o,u,a,255,r,i,s,255)}else{hn(f,r,i,s,255)}}else{Kt(e)}}}function gn(e,t,n,r,i){var s,o,u,a;s=n;if(s!==PS.CURRENT&&s!==PS.DEFAULT){a=Dt(s);if(a==="undefined"){s=PS.CURRENT}else if(a==="number"){s=Math.floor(s);if(s<0){s=0}else if(s>255){s=255}}else{return sn(e+"red value invalid")}}o=r;if(o!==PS.CURRENT&&o!==PS.DEFAULT){a=Dt(o);if(a==="undefined"){o=PS.CURRENT}else if(a==="number"){o=Math.floor(o);if(o<0){o=0}else if(o>255){o=255}}else{return sn(e+"green value invalid")}}u=i;if(u!==PS.CURRENT&&u!==PS.DEFAULT){a=Dt(u);if(a==="undefined"){u=PS.CURRENT}else if(a==="number"){u=Math.floor(u);if(u<0){u=0}else if(u>255){u=255}}else{return sn(e+"blue value invalid")}}t.rgb=null;t.r=s;t.g=o;t.b=u;return PS.DONE}function yn(e,t){var n,r,i,s,o,u;n=Math.floor(t);if(n<1){n=r=s=u=0}else if(n>=16777215){n=16777215;r=s=u=255}else{r=n/T;r=Math.floor(r);i=r*T;s=(n-i)/N;s=Math.floor(s);o=s*N;u=n-i-o}e.rgb=n;e.r=r;e.g=s;e.b=u}function wn(e,t,n,r){var i,s,o,u,a;i=bn;i.rgb=0;i.r=null;i.g=null;i.b=null;i.str="";s=Dt(t);if(n!==undefined||r!==undefined){if(s==="number"||s==="undefined"||t===PS.CURRENT||t===PS.DEFAULT){o=gn(e,i,t,n,r);if(o===PS.ERROR){return PS.ERROR}}else{if(s==="array"){return sn(e+"Extraneous arguments after color array")}if(s==="object"){return sn(e+"Extraneous arguments after color object")}return sn(e+"red argument invalid")}}else if(s==="number"){yn(i,t)}else if(s==="array"){a=t.length;if(a<1){i.rgb=PS.CURRENT}else{o=gn(e,i,t[0],t[1],t[2]);if(o===PS.ERROR){return PS.ERROR}}}else if(s==="object"){u=t.rgb;s=Dt(u);if(s==="undefined"||u===null){o=gn(e,i,t.r,t.g,t.b);if(o===PS.ERROR){return PS.ERROR}}else if(s==="number"){yn(i,u)}else if(u===PS.CURRENT||u===PS.DEFAULT){i.rgb=u}else{return sn(e+".rgb property invalid")}}else if(s==="undefined"||t===PS.CURRENT){i.rgb=PS.CURRENT}else if(t===PS.DEFAULT){i.rgb=PS.DEFAULT}else{return sn(e+"color argument invalid")}return i}function En(e){var t,n,r;t=X.bead_size;e.glyph.x=Math.floor(t/2);r=e.glyph.scale;if(r<100){n=Math.floor(t*r/100)}else{n=t}e.glyph.size=Math.floor(n/2);e.glyph.font=e.glyph.size+"pt sans-serif";e.glyph.y=Math.floor((t-n)/2)+Math.floor(n/7*4)}function Sn(e){var t;Ht(F.bead,e);t={};Ht(F.bead.color,t);e.planes=[{height:0,color:t}];En(e);an(e.fader);an(e.borderFader);an(e.glyphFader)}function xn(e,t){var n,r,i,s,o,u;n=e.planes;if(t<1){r=n[0];return r.color}i=n.length;for(s=1;s<i;s+=1){r=n[s];if(r.height===t){return r.color}}u=F.bead.color;o={rgb:u.rgb,r:u.r,g:u.g,b:u.b,a:0};if(e.active){s=0;while(s<i){r=n[s];if(r.height>t){break}s+=1}n.splice(s,0,{height:t,color:o})}return o}function Tn(e){if(e.glyph.code>0){return e.border.gmax}return e.border.max}function Nn(e,t){e.border.equal=true;e.border.width=t;e.border.top=t;e.border.left=t;e.border.bottom=t;e.border.right=t}function Cn(e){var t,n,r,i,s,o,u;t=X.bead_size;if(e.scale<100){n=Math.floor(t*e.scale/100);r=t-n;if(r>0&&r%2){n+=1}}else{n=t;e.margin=0;e.senseLeft=e.left;e.senseRight=e.right;e.senseTop=e.top;e.senseBottom=e.bottom}e.size=n;if(n!==t){e.margin=i=Math.floor((t-n)/2);e.senseLeft=e.left+i;e.senseRight=e.right-i;e.senseTop=e.top+i;e.senseBottom=e.bottom-i}u=e.border;u.max=Math.floor((n-8)/2);u.gmax=Math.floor((n-e.glyph.size)/2);s=Tn(e);if(u.equal){if(u.width>s){Nn(e,s)}}else{o=u.top;if(o>s){u.top=s}o=u.left;if(o>s){u.left=s}o=u.bottom;if(o>s){u.bottom=s}o=u.right;if(o>s){u.right=s}}}function kn(e){var t;t=e.data;if(t===null){t=0}return t}function Ln(e){var t,n;if(e.active){n=false;t=kn(e);if(e.exec){try{e.exec(e.x,e.y,t,k);n=true}catch(r){return rn("Bead "+e.x+", "+e.y+" function failed ["+r.message+"]",r)}}if(PS.touch){try{PS.touch(e.x,e.y,t,k);n=true}catch(i){return rn("PS.touch() failed ["+i.message+"]",i)}}if(n){Qt()}}return PS.DONE}function An(e){var t;if(e.active){if(PS.release){t=kn(e);try{PS.release(e.x,e.y,t,k);Qt()}catch(n){return rn("PS.release() failed ["+n.message+"]",n)}}}return PS.DONE}function On(e){var t;Et=true;if(e.active){if(PS.enter){t=kn(e);try{PS.enter(e.x,e.y,t,k);Qt()}catch(n){return rn("PS.enter() failed ["+n.message+"]",n)}}}return PS.DONE}function Mn(e){var t;if(e.active){if(PS.exit){t=kn(e);try{PS.exit(e.x,e.y,t,k);Qt()}catch(n){return rn("PS.exit() failed ["+n.message+"]",n)}}}return PS.DONE}function _n(){Et=false;if(PS.exitGrid){try{PS.exitGrid(k);Qt()}catch(e){return rn("PS.exitGrid() failed ["+e.message+"]",e)}}return PS.DONE}function Dn(){St=-1}function Pn(e,t){var n,r,i,s;n=X.canvas;e+=document.body.scrollLeft+document.documentElement.scrollLeft-n.offsetLeft-X.padLeft;t+=document.body.scrollTop+document.documentElement.scrollTop-n.offsetTop-X.padRight;if(e>=X.left&&e<X.right&&t>=X.top&&t<X.bottom){i=0;while(i<X.count){r=V[i];if(t>=r.top&&t<r.bottom){for(s=0;s<X.x;s+=1){if(e>=r.senseLeft&&e<r.senseRight&&t>=r.senseTop&&t<r.senseBottom){return r}i+=1;r=V[i]}return null}i+=X.x}}return null}function Hn(e){var t,n,r;if(e.x&&e.y){t=e.x;n=e.y}else{t=e.clientX;n=e.clientY}r=Pn(t,n);if(r){Ln(r)}return Bt(e)}function Bn(e){var t,n,r;if(e.x&&e.y){t=e.x;n=e.y}else{t=e.clientX;n=e.clientY}r=Pn(t,n);if(r){An(r)}return Bt(e)}function jn(e){var t,n,r,i;if(e.x&&e.y){t=e.x;n=e.y}else{t=e.clientX;n=e.clientY}r=Pn(t,n);if(r){if(r.index!==St){if(St>=0){i=V[St];Mn(i)}On(r);St=r.index}}else if(St>=0){i=V[St];Mn(i);St=-1}return Bt(e)}function Fn(n){var r,i;if(St>=0){r=V[St];Mn(r);St=-1}i=n.relatedTarget;if(i){i=i.id;if(i&&(i===e||i===t||i.length<1)){_n()}}return Bt(n)}function In(e){var t,n,r,i;if(bt!==M){return Bt(e)}r=e.changedTouches[0];bt=r.identifier;t=r.pageX;n=r.pageY;i=Pn(t,n);if(i){Et=true;wt=i.index;Ln(i)}else{wt=M;Et=false}return Bt(e)}function qn(e){var t,n,r,i,s,o,u;t=e.changedTouches.length;for(n=0;n<t;n+=1){r=e.changedTouches[n];i=r.identifier;if(i===bt){bt=M;wt=M;Et=false;s=r.pageX;o=r.pageY;u=Pn(s,o);if(u){An(u)}break}}return Bt(e)}function Rn(e){var t,n,r,i,s,o,u,a;t=e.changedTouches.length;for(n=0;n<t;n+=1){r=e.changedTouches[n];i=r.identifier;if(i===bt){s=r.pageX;o=r.pageY;u=Pn(s,o);if(u){Et=true;if(wt!==u.index){if(wt!==M){a=V[wt];Mn(a)}wt=u.index;On(u)}}else{if(wt!==M){a=V[wt];Mn(a)}wt=M;if(Et){_n()}}break}}return Bt(e)}function Un(){var e;lt.length=0;ct=false;ht=false;for(e=0;e<256;e+=1){ft[e]=0}}function zn(e,t){var n;n=e;if(n>=65&&n<=90){if(!t){n+=32}}else{n=ot[n];if(t&&n<256){n=ut[n]}}return n}function Wn(e){return e>=32||e===13||e===8||e===9||e===27}function Xn(e){var t,n,r,i,s,o;t="[_keyDown] ";n=false;if(Tt){return true}if(PS.keyDown){ct=e.shiftKey;ht=e.ctrlKey;if(!e.which){r=e.keyCode}else{r=e.which}i=zn(r,ct);if(Wn(i)){if(!ft[i]){ft[i]=1;if(i!==r&&ft[r]){ft[r]=0;o=lt.indexOf(r);if(o>=0){lt.splice(o,1)}}if(lt.length<1){dt=mt}if(lt.indexOf(i)<0){lt.push(i)}try{PS.keyDown(i,ct,ht,k);n=true}catch(u){rn(t+"PS.keyDown failed ["+u.message+"]",u)}}}else if(i===A){s=lt.length;for(o=0;o<s;o+=1){i=r=lt[o];if(r>=97&&r<=122){i-=32}else if(r<256){i=ut[r]}if(i!==r){ft[r]=0;ft[i]=1;lt[o]=i;try{PS.keyDown(i,true,ht,k);n=true}catch(a){rn(t+"PS.keyDown failed ["+a.message+"]",a)}}}}if(n){Qt()}}return Bt(e)}function Vn(e){var t,n,r,i,s,o,u,a;t="[_keyUp] ";n=false;if(Tt){return true}if(PS.keyUp){r=ct=e.shiftKey;i=ht=e.ctrlKey;if(!e.which){s=e.keyCode}else{s=e.which}o=zn(s,ct);if(Wn(o)){ft[o]=0;u=lt.indexOf(o);if(u>=0){lt.splice(u,1)}if(lt.length<1){dt=0;ct=false;ht=false}try{PS.keyUp(o,r,i,k);n=true}catch(f){rn(t+"PS.keyUp failed ["+f.message+"]",f)}}else if(o===A){a=lt.length;for(u=0;u<a;u+=1){o=s=lt[u];if(s<256){o=at[s]}if(o!==s){ft[s]=0;ft[o]=1;lt[u]=o;try{PS.keyDown(o,false,i,k);n=true}catch(l){rn(t+"PS.keyDown failed ["+l.message+"]",l)}}}}if(n){Qt()}}return Bt(e)}function $n(e){var t;if(!Et){return true}if(PS.input){if(!e){e=window.event}t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));if(t>=1){t=PS.WHEEL_FORWARD}else{t=PS.WHEEL_BACKWARD}try{PS.input({wheel:t},k);Qt()}catch(n){rn("PS.input() failed ["+n.message+"]",n)}}return Bt(e)}function Jn(){if(!st){document.addEventListener("keydown",Xn,false);document.addEventListener("keyup",Vn,false);st=true}}function Kn(){Un();if(st){document.removeEventListener("keydown",Xn,false);document.removeEventListener("keyup",Vn,false);st=false}}function Qn(){var e;e=X.canvas;e.style.display="block";e.addEventListener("mousedown",Hn,false);e.addEventListener("mouseup",Bn,false);e.addEventListener("mousemove",jn,false);e.addEventListener("mouseout",Fn,false);Jn();window.addEventListener("DOMMouseScroll",$n,false);window.addEventListener("mousewheel",$n,false);if(gt){bt=M;wt=M;document.addEventListener("touchmove",Rn,false);document.addEventListener("touchstart",In,false);document.addEventListener("touchend",qn,false);document.addEventListener("touchcancel",qn,false)}}function Gn(e){var t,n,r,i,s,o;t=X.color;n=X.fader;r=e.rgb;if(r===PS.CURRENT){return t.rgb}if(r===null){i=e.r;if(i===PS.CURRENT){e.r=i=t.r}else if(i===PS.DEFAULT){e.r=i=F.grid.color.r}s=e.g;if(s===PS.CURRENT){e.g=s=t.g}else if(s===PS.DEFAULT){e.g=s=F.grid.color.g}o=e.b;if(o===PS.CURRENT){e.b=o=t.b}else if(o===PS.DEFAULT){e.b=o=F.grid.color.b}e.rgb=i*T+s*N+o}else if(r===PS.DEFAULT){Ht(F.grid.color,e)}if(t.rgb!==e.rgb||n.rate>0&&n.rgb!==null&&n.rgb!==e.rgb){t.rgb=e.rgb;i=e.r;s=e.g;o=e.b;t.str=e.str=q[i]+R[s]+U[o];if(n.rate>0){if(n.rgb!==null){cn(n,n.r,n.g,n.b,255,i,s,o,255)}else if(!n.active){cn(n,t.r,t.g,t.b,255,i,s,o,255)}else{hn(n,i,s,o,255)}}else{Ut(e);zt(e)}t.r=i;t.g=s;t.b=o}return t.rgb}function Yn(e,t){var n,r,i,s,o;n=X.shadow;r=t.rgb;if(r!==PS.CURRENT){if(r===null){i=t.r;if(i===PS.CURRENT){t.r=i=n.r}else if(i===PS.DEFAULT){t.r=i=F.grid.shadow.r}s=t.g;if(s===PS.CURRENT){t.g=s=n.g}else if(s===PS.DEFAULT){t.g=s=F.grid.shadow.g}o=t.b;if(o===PS.CURRENT){t.b=o=n.b}else if(o===PS.DEFAULT){t.b=o=F.grid.shadow.b}t.rgb=i*T+s*N+o}else if(r===PS.DEFAULT){Ht(F.grid.shadow,t)}if(n.rgb!==t.rgb){n.rgb=t.rgb;i=t.r;s=t.g;o=t.b;n.str=t.str=q[i]+R[s]+U[o];n.r=i;n.g=s;n.b=o}}if(e!==PS.CURRENT){X.shadow.show=e}if(X.shadow.show){Wt(n)}else{X.canvas.style.boxShadow="none"}return{show:X.shadow.show,rgb:n.rgb}}function Zn(e,t){var n,r,i,s,o,u,a;un();an(X.fader);an($.fader);X.plane=0;if(!X.ready||e!==X.x||t!==X.y){X.x=e;X.y=t;X.count=e*t;if(e>=t){n=Math.floor(S/e);X.left=0}else{n=Math.floor(S/t);X.left=Math.floor((S-n*e)/2)}X.bead_size=n;X.width=n*e;X.height=n*t;X.right=X.left+X.width;X.top=0;X.bottom=X.height;if(t>=e){X.canvas.height=S}else{X.canvas.height=X.height}X.context.textAlign="center";X.context.textBaseline="middle";s=0;u=X.top;for(i=0;i<t;i+=1){o=X.left;for(r=0;r<e;r+=1){a=V[s];a.x=r;a.y=i;a.left=o;a.right=o+n;a.top=u;a.bottom=u+n;Sn(a);Cn(a);o+=n;s+=1}u+=n}while(s<C){a=V[s];a.visible=false;a.active=false;s+=1}}else{for(r=0;r<X.count;r+=1){a=V[r];Sn(a);Cn(a)}}J=true;Gn({rgb:PS.DEFAULT});PS.statusColor(PS.DEFAULT);Qt();Dn();X.ready=true}function er(e,t){if(Dt(e)!=="number"){return sn(t+"x argument not a number")}e=Math.floor(e);if(e<0){return sn(t+"x argument negative")}if(e>=X.x){return sn(t+"x argument exceeds grid width")}return e}function tr(e,t){if(Dt(e)!=="number"){return sn(t+"y argument not a number")}e=Math.floor(e);if(e<0){return sn(t+"y argument negative")}if(e>=X.y){return sn(t+"y argument exceeds grid height")}return e}function nr(e,t,n,r,i,s,o,u){var a,f,l;if(n===PS.ALL){if(r===PS.ALL){for(f=0;f<X.y;f+=1){for(a=0;a<X.x;a+=1){l=t(a,f,i,s,o,u);if(l===PS.ERROR){break}}}return l}r=tr(r,e);if(r===PS.ERROR){return PS.ERROR}for(a=0;a<X.x;a+=1){l=t(a,r,i,s,o,u);if(l===PS.ERROR){break}}return l}if(r===PS.ALL){n=er(n,e);if(n===PS.ERROR){return PS.ERROR}for(f=0;f<X.y;f+=1){l=t(n,f,i,s,o,u);if(l===PS.ERROR){break}}return l}n=er(n,e);if(n===PS.ERROR){return PS.ERROR}r=tr(r,e);if(r===PS.ERROR){return PS.ERROR}l=t(n,r,i,s,o,u);return l}function rr(e,t,n){var r,i,s,o,u,a,f,l,c;r=t*X.x+e;i=V[r];s=F.bead.color;o=xn(i,X.plane);u=i.fader;a=n.rgb;if(!i.active||a===PS.CURRENT){return o.rgb}if(a===null){f=n.r;if(f===PS.CURRENT){n.r=f=o.r}else if(f===PS.DEFAULT){n.r=f=s.r}l=n.g;if(l===PS.CURRENT){n.g=l=o.g}else if(l===PS.DEFAULT){n.g=l=s.g}c=n.b;if(c===PS.CURRENT){n.b=c=o.b}else if(c===PS.DEFAULT){n.b=c=s.b}n.rgb=f*T+l*N+c}else if(a===PS.DEFAULT){Ht(s,n)}if(o.rgb!==n.rgb||u.rate>0&&u.rgb!==null&&u.rgb!==n.rgb){o.rgb=n.rgb;o.r=n.r;o.g=n.g;o.b=n.b;mn(i)}return o.rgb}function ir(e,t,n){var r,i,s;r=t*X.x+e;i=V[r];s=xn(i,X.plane);if(i.active&&n!==PS.CURRENT&&n!==s.a){s.a=n;mn(i)}return s.a}function sr(e,t){var n,r,i,s,o,u,a;n=Dt(t);if(n==="undefined"||t===PS.CURRENT){return{rgb:PS.CURRENT,r:0,g:0,b:0,onStep:PS.CURRENT,onEnd:PS.CURRENT,params:PS.CURRENT}}if(t===PS.DEFAULT){return{rgb:PS.DEFAULT,r:0,g:0,b:0,onStep:PS.DEFAULT,onEnd:PS.DEFAULT,params:PS.DEFAULT}}if(n!=="object"){return sn(e+"options argument invalid")}r=t.rgb;if(r!==PS.CURRENT&&r!==PS.DEFAULT){n=Dt(r);if(n==="undefined"||r===null){t.rgb=PS.CURRENT}else if(n==="number"){r=Math.floor(r);if(r<=PS.COLOR_BLACK){r=PS.COLOR_BLACK;i=0;o=0;s=0}else if(r>=PS.COLOR_WHITE){r=PS.COLOR_WHITE;i=255;o=255;s=255}else{i=r/T;i=Math.floor(i);u=i*T;o=(r-u)/N;o=Math.floor(o);a=o*N;s=r-u-a}t.rgb=r;t.r=i;t.g=o;t.b=s}else{return sn(e+"options.rgb property invalid")}}else{t.r=0;t.g=0;t.b=0}r=t.onStep;if(r!==PS.CURRENT&&r!==PS.DEFAULT){n=Dt(r);if(n==="undefined"||r===null){t.onStep=PS.CURRENT}else if(n!=="function"){return sn(e+"options.onStep property invalid")}}r=t.onEnd;if(r!==PS.CURRENT&&r!==PS.DEFAULT){n=Dt(r);if(n==="undefined"||r===null){t.onEnd=PS.CURRENT}else if(n!=="function"){return sn(e+"options.onEnd property invalid")}}r=t.params;if(r!==PS.CURRENT&&r!==PS.DEFAULT){n=Dt(r);if(n==="undefined"||r===null){t.params=PS.CURRENT}else if(n!=="array"){return sn(e+"options.params property invalid")}}return t}function or(e,t,n,r){var i,s,o,u,a,f,l;i=t*X.x+e;s=V[i];o=s.color;u=s.fader;a=u.rate;if(s.active){if(n===PS.CURRENT){f=a}else if(n===PS.DEFAULT){f=F.fader.rate}else{f=n}l=r.rgb;if(l!==PS.CURRENT){if(l===PS.DEFAULT){u.rgb=F.fader.rgb}else{u.rgb=l}u.r=r.r;u.g=r.g;u.b=r.b}l=r.onStep;if(l!==PS.CURRENT){if(l===PS.DEFAULT){u.onStep=F.fader.onStep}else{u.onStep=l}}l=r.onEnd;if(l!==PS.CURRENT){if(l===PS.DEFAULT){u.onEnd=F.fader.onEnd}else{u.onEnd=l}}l=r.params;if(l!==PS.CURRENT){if(l===PS.DEFAULT){u.params=F.fader.params}else{u.params=l}}if(a!==f){u.rate=f;if(f<1){u.active=false;u.kill=true}else if(u.active){hn(u,o.r,o.g,o.b,255)}}}return{rate:u.rate,rgb:u.rgb,onStep:u.onStep,onEnd:u.onEnd,params:u.params}}function ur(e,t,n){var r,i;r=t*X.x+e;i=V[r];if(i.active&&n!==PS.CURRENT&&i.scale!==n){i.scale=n;Cn(i);Kt(i)}return i.scale}function ar(e,t,n){var r,i,s;r=t*X.x+e;i=V[r];if(i.active&&n!==PS.CURRENT&&i.radius!==n){i.radius=n;if(!i.border.equal&&n>0){s=Math.max(i.border.top,i.border.left,i.border.bottom,i.border.right);Nn(i,s)}Kt(i)}return i.radius}function fr(e,t,n){var r,i;r=t*X.x+e;i=V[r];if(i.active&&n!==PS.CURRENT){if(n===null){i.data=F.bead.data;i.fader.data=i.data;i.borderFader.data=i.data;i.glyphFader.data=i.data}else{i.data=n;i.fader.data=n;i.borderFader.data=n;i.glyphFader.data=n}}return i.data}function lr(e,t,n){var r,i;r=t*X.x+e;i=V[r];if(i.active&&n!==PS.CURRENT){i.exec=n}return i.exec}function cr(e,t,n){var r,i;r=t*X.x+e;i=V[r];if(i.active&&n!==PS.CURRENT&&i.visible!==n){i.visible=n;if(!n){i.fader.kill=true;i.borderFader.kill=true;i.glyphFader.kill=true}Kt(i)}return i.visible}function hr(e,t,n){var r,i;r=t*X.x+e;i=V[r];if(n!==PS.CURRENT){i.active=n}return i.active}function pr(e,t,n){var r,i,s,o,u,a,f,l,c;r=t*X.x+e;i=V[r];if(i.active&&n!==PS.CURRENT){s=Tn(i);if(Dt(n)==="number"){if(n>s){n=s}if(n!==i.border.width){Nn(i,n);Kt(i)}}else{u=false;a=n.top;if(a===PS.CURRENT){a=i.border.top}else{if(a>s){a=s}if(a!==i.border.top){i.border.top=a;u=true}}f=n.left;if(f===PS.CURRENT){f=i.border.left}else{if(f>s){f=s}if(f!==i.border.left){i.border.left=f;u=true}}l=n.bottom;if(l===PS.CURRENT){l=i.border.bottom}else{if(l>s){l=s}if(l!==i.border.bottom){i.border.bottom=l;u=true}}c=n.right;if(c===PS.CURRENT){c=i.border.right}else{if(c>s){c=s}if(c!==i.border.right){i.border.right=c;u=true}}if(a===f&&a===c&&a===l){Nn(i,a);if(u){Kt(i)}}else if(i.radius>0){s=Math.max(a,f,l,c);Nn(i,s);Kt(i)}else{i.border.equal=false;if(u){Kt(i)}}}}o={top:i.border.top,left:i.border.left,bottom:i.border.bottom,right:i.border.right,equal:i.border.equal};if(!i.border.equal){i.border.width=Math.max(o.top,o.left,o.bottom,o.right)}o.width=i.border.width;return o}function dr(e,t,n){var r,i,s,o,u,a,f,l,c;r=t*X.x+e;i=V[r];s=i.border.color;o=i.borderFader;u=n.rgb;if(i.active&&u!==PS.CURRENT){if(u===null){a=n.r;if(a===PS.CURRENT){n.r=a=s.r}else if(a===PS.DEFAULT){n.r=a=F.bead.border.color.r}f=n.g;if(f===PS.CURRENT){n.g=f=s.g}else if(f===PS.DEFAULT){n.g=f=F.bead.border.color.g}l=n.b;if(l===PS.CURRENT){n.b=l=s.b}else if(l===PS.DEFAULT){n.b=l=F.bead.border.color.b}n.rgb=a*T+f*N+l}else if(u===PS.DEFAULT){Ht(F.bead.border.color,n)}if(s.rgb!==n.rgb||o.rate>0&&o.rgb!==null&&o.rgb!==n.rgb){s.rgb=n.rgb;a=n.r;f=n.g;l=n.b;n.a=c=s.a;s.str=n.str=q[a]+R[f]+R[l]+z[c];if(i.visible){if(o.rate>0){if(o.rgb!==null){cn(o,o.r,o.g,o.b,c,a,f,l,c)}else if(!o.active){cn(o,s.r,s.g,s.b,c,a,f,l,c)}else{hn(o,a,f,l,c)}}else{Kt(i)}}s.r=a;s.g=f;s.b=l}}return s.rgb}function vr(e,t,n){var r,i,s,o,u,a,f;r=t*X.x+e;i=V[r];s=i.border.color;if(i.active&&n!==PS.CURRENT&&n!==s.a){o=s.r;u=s.g;a=s.b;s.str=q[o]+R[u]+R[a]+z[n];if(i.visible){f=i.borderFader;if(f.rate>0){if(!f.active){if(f.rgb!==null){cn(f,f.r,f.g,f.b,s.a,o,u,a,n)}else{cn(f,o,u,a,s.a,o,u,a,n)}}else{hn(f,o,u,a,n)}}else{Kt(i)}}s.a=n}return s.a}function mr(e,t,n,r){var i,s,o,u,a,f,l;i=t*X.x+e;s=V[i];u=s.border.color;o=s.borderFader;a=o.rate;if(s.active){if(n===PS.CURRENT){f=a}else if(n===PS.DEFAULT){f=F.fader.rate}else{f=n}l=r.rgb;if(l!==PS.CURRENT){if(l===PS.DEFAULT){o.rgb=F.fader.rgb}else{o.rgb=l}o.r=r.r;o.g=r.g;o.b=r.b}l=r.onStep;if(l!==PS.CURRENT){if(l===PS.DEFAULT){o.onStep=F.fader.onStep}else{o.onStep=l}}l=r.onEnd;if(l!==PS.CURRENT){if(l===PS.DEFAULT){o.onEnd=F.fader.onEnd}else{o.onEnd=l}}l=r.params;if(l!==PS.CURRENT){if(l===PS.DEFAULT){o.params=F.fader.params}else{o.params=l}}if(a!==f){o.rate=f;if(f<1){o.active=false;o.kill=true}else if(o.active){hn(o,u.r,u.g,u.b,255)}}}return{rate:o.rate,rgb:o.rgb,onStep:o.onStep,onEnd:o.onEnd,params:o.params}}function gr(e,t,n){var r,i,s;r=t*X.x+e;i=V[r];if(i.active&&n!==PS.CURRENT&&i.glyph.code!==n){i.glyph.code=n;if(n<1){s=""}else{s=String.fromCodePoint(n)}i.glyph.str=s;Kt(i)}return i.glyph.code}function yr(e,t,n){var r,i,s,o,u,a,f,l,c;r=t*X.x+e;i=V[r];s=i.glyph.color;o=i.glyphFader;u=n.rgb;if(i.active&&u!==PS.CURRENT){if(u===null){a=n.r;if(a===PS.CURRENT){n.r=a=s.r}else if(a===PS.DEFAULT){n.r=a=F.bead.glyph.color.r}f=n.g;if(f===PS.CURRENT){n.g=f=s.g}else if(f===PS.DEFAULT){n.g=f=F.bead.glyph.color.g}l=n.b;if(l===PS.CURRENT){n.b=l=s.b}else if(l===PS.DEFAULT){n.b=l=F.bead.glyph.color.b}n.rgb=a*T+f*N+l}else if(u===PS.DEFAULT){Ht(F.bead.glyph.color,n)}if(s.rgb!==n.rgb||o.rate>0&&o.rgb!==null&&o.rgb!==n.rgb){s.rgb=n.rgb;a=n.r;f=n.g;l=n.b;n.a=c=s.a;s.str=n.str=q[a]+R[f]+R[l]+z[c];if(i.visible){if(o.rate>0){if(o.rgb!==null){cn(o,o.r,o.g,o.b,c,a,f,l,c)}if(!o.active){cn(o,s.r,s.g,s.b,c,a,f,l,c)}else{hn(o,a,f,l,c)}}else{Kt(i)}}s.r=a;s.g=f;s.b=l}}return s.rgb}function br(e,t,n){var r,i,s,o,u,a,f;r=t*X.x+e;i=V[r];s=i.glyph.color;if(i.active&&n!==PS.CURRENT&&n!==s.a){o=s.r;u=s.g;a=s.b;s.str=q[o]+R[u]+R[a]+z[n];if(i.visible){f=i.glyphFader;if(f.rate>0){if(!f.active){cn(f,o,u,a,s.a,o,u,a,n)}else{hn(f,o,u,a,n)}}else{Kt(i)}}s.a=n}return s.a}function wr(e,t,n){var r,i,s;r=t*X.x+e;i=V[r];s=i.glyph.scale;if(i.active&&n!==PS.CURRENT&&n!==s){i.glyph.scale=n;if(i.visible){En(i);Kt(i)}}return i.glyph.scale}function Er(e,t,n,r){var i,s,o,u,a,f,l;i=t*X.x+e;s=V[i];o=s.glyph.color;u=s.glyphFader;a=u.rate;if(s.active){if(n===PS.CURRENT){f=a}else if(n===PS.DEFAULT){f=F.fader.rate}else{f=n}l=r.rgb;if(l!==PS.CURRENT){if(l===PS.DEFAULT){u.rgb=F.fader.rgb}else{u.rgb=l}u.r=r.r;u.g=r.g;u.b=r.b}l=r.onStep;if(l!==PS.CURRENT){if(l===PS.DEFAULT){u.onStep=F.fader.onStep}else{u.onStep=l}}l=r.onEnd;if(l!==PS.CURRENT){if(l===PS.DEFAULT){u.onEnd=F.fader.onEnd}else{u.onEnd=l}}l=r.params;if(l!==PS.CURRENT){if(l===PS.DEFAULT){u.params=F.fader.params}else{u.params=l}}if(a!==f){u.rate=f;if(f<1){u.active=false;u.kill=true}else if(u.active){hn(u,o.r,o.g,o.b,255)}}}return{rate:u.rate,rgb:u.rgb,onStep:u.onStep,onEnd:u.onEnd,params:u.params}}function Sr(e){var t,n,r,i,s;t=e.getAttribute("data-id");n=Q.length;for(r=0;r<n;r+=1){i=Q[r];if(i.id===t){s=i.exec;Q.splice(r,1);break}}try{s(PS.ERROR)}catch(o){rn("[PS.imageLoad] .exec function failed ["+o.message+"]",o)}sn("[PS.imageLoad] Error loading "+e.src)}function xr(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;n="[_imageExtract] ";r=e.width;if(Dt(r)!=="number"||r<1){return sn(n+"image width invalid")}r=Math.floor(r);i=e.height;if(Dt(i)!=="number"||i<1){return sn(n+"image height invalid")}i=Math.floor(i);try{K.width=r;K.height=i;s=K.getContext("2d");s.drawImage(e,0,0,r,i,0,0,r,i)}catch(g){return rn(n+"image extraction failed @ 1 ["+g.message+"]",g)}try{o=s.getImageData(0,0,r,i)}catch(y){return rn(n+"image extraction failed @ 2 ["+y.message+"]",y)}u={width:o.width,height:o.height};a=o.data;f=a.length;l=[];h=c=0;if(t===1){l.length=f/4;while(c<f){p=a[c];d=a[c+1];v=a[c+2];l[h]=p*T+d*N+v;c+=4;h+=1}}else if(t===2){l.length=f/2;while(c<f){p=a[c];d=a[c+1];v=a[c+2];m=a[c+3];l[h]=p*T+d*N+v;l[h+1]=m;c+=4;h+=2}}else if(t===3){l.length=f/4*3;while(c<f){p=a[c];d=a[c+1];v=a[c+2];l[h]=p;l[h+1]=d;l[h+2]=v;c+=4;h+=3}}else{l.length=f;while(c<f){l[c]=a[c];c+=1;l[c]=a[c];c+=1;l[c]=a[c];c+=1;l[c]=a[c];c+=1}}u.pixelSize=t;u.data=l;return u}function Tr(e){var t,n,r,i,s,o,u,a;t=e.getAttribute("data-id");n=Q.length;for(r=0;r<n;r+=1){i=Q[r];if(i.id===t){s=i.exec;o=i.format;u=i.source;Q.splice(r,1);break}}a=xr(e,o);if(a!==PS.ERROR){try{a.source=u;a.id=t;s(a)}catch(f){rn("[PS.imageLoad] .exec function failed ["+f.message+"]",f)}}}function Nr(e,t){var n,r,i,s,o,u,a,f;if(Dt(t)!=="object"){return sn(e+"image argument not an object")}n=t.width;if(Dt(n)!=="number"){return sn(e+"image.width not a number")}n=Math.floor(n);if(n<1){return sn(e+"image.width < 1")}t.width=n;r=t.height;if(Dt(r)!=="number"){return sn(e+"image.height not a number")}r=Math.floor(r);if(r<1){return sn(e+"image.height < 1")}t.height=r;i=t.pixelSize;if(Dt(i)!=="number"){return sn(e+"image.pixelSize not a number")}i=Math.floor(i);if(i<1&&i>4){return sn(e+"image.pixelSize is not 1, 2, 3 or 4")}t.pixelSize=i;o=t.data;if(Dt(o)!=="array"){return sn(e+"image.data is not an array")}u=o.length;s=n*r*i;if(u!==s){return sn(e+"image.data length invalid")}for(a=0;a<u;a+=1){f=o[a];if(Dt(f)!=="number"){return sn(e+"image.data["+a+"] not a number")}if(f<0){return sn(e+"image.data["+a+"] negative")}if(i<3){if(f>16777215){return sn(e+"image.data["+a+"] > 0xFFFFFF")}}else if(f>255){return sn(e+"image.data["+a+"] > 255")}}return true}function Cr(e,t){var n,r;n=e.toString(16).toUpperCase();if(t){r=n.length;while(r<t){n="0"+n;r+=1}}return"0x"+n}function kr(e,t,n,r,i,s,o){var u;if(e<3){u="";if(t){u+=Cr(n,6)}else{u+=n}if(e===2){if(t){u+=", "+Cr(o,2)}else{u+=", "+o}}}else{if(t){u=Cr(r,2)+", "+Cr(i,2)+", "+Cr(s,2)}else{u=r+", "+i+", "+s}if(e===4){if(t){u+=", "+Cr(o,2)}else{u+=", "+o}}}return u}function Lr(){var e;e={id:b+Z,placed:false,visible:true,x:0,y:0,ax:0,ay:0,image:null,color:null,collide:null,width:0,height:0,plane:-1};Z+=1;Y.push(e);return e}function Ar(e,t){var n,r,i;if(typeof e!=="string"||e.length<1){return sn(t+"sprite argument invalid")}n=Y.length;for(r=0;r<n;r+=1){i=Y[r];if(i.id===e){return i}}return sn(t+"sprite id '"+e+"' does not exist")}function Or(e,t,n,r,i){var s,o,u,a,f,l,c,h,p;if(t===undefined){t=e.x;n=e.y;r=e.width;i=e.height}s=X.x;t-=e.ax;if(t>=s){return}if(t<0){r+=t;if(r<1){return}t=0}if(t+r>s){r=s-t}u=t+r;o=X.y;n-=e.ay;if(n>=o){return}if(n<0){i+=n;if(i<1){return}n=0}if(n+i>o){i=o-n}a=n+i;for(l=n;l<a;l+=1){for(f=t;f<u;f+=1){h=f+l*s;c=V[h];if(c.active){p=xn(c,e.plane);p.r=255;p.g=255;p.b=255;p.a=0;p.rgb=16777215;mn(c)}}}}function Mr(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;t=e.width;n=e.height;if(t<1||n<1){return}r=X.x;f=0;s=e.x-e.ax;if(s>=r){return}if(s<0){t+=s;if(t<1){return}s=0;f=e.width-t}if(s+t>r){t=r-s}u=s+t;i=X.y;l=0;o=e.y-e.ay;if(o>=i){return}if(o<0){n+=o;if(n<1){return}o=0;l=e.height-n}if(o+n>i){n=i-o}a=o+n;c=e.color;if(c){for(p=o;p<a;p+=1){for(h=s;h<u;h+=1){v=h+p*r;d=V[v];if(d.active){m=xn(d,e.plane);m.rgb=c.rgb;m.r=c.r;m.g=c.g;m.b=c.b;m.a=c.a;mn(d)}}}}else{g=e.image.data;for(p=o;p<a;p+=1){y=(l*e.width+f)*4;for(h=s;h<u;h+=1){v=h+p*r;d=V[v];if(d.active){b=g[y];w=g[y+1];E=g[y+2];S=g[y+3];m=xn(d,e.plane);m.rgb=b*T+w*N+E;m.r=b;m.g=w;m.b=E;m.a=S;mn(d)}y+=4}l+=1}}}function _r(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;n="[_collisionCheck] ";s=e.x-e.ax;o=e.y-e.ay;u=e.width;a=e.height;f=e.collide;r=Y.length;for(i=0;i<r;i+=1){l=Y[i];c=l.id;if(c!==t&&l.visible&&l.placed){h=l.x-l.ax;p=l.y-l.ay;d=l.width;v=l.height;m=l.collide;if(h>s){g=h-s}else{g=s-h}if(p>o){y=p-o}else{y=o-p}b=null;if(s===h-u||s===h+d){if(o<=p&&y<=a||o>=p&&y<=v){b=PS.SPRITE_TOUCH}}else if(o===p-a||o===p+v){if(s<=h&&g<=u||s>=h&&g<=d){b=PS.SPRITE_TOUCH}}else if(s>=h&&s<h+d){if(o<=p&&y<a||o>=p&&y<v){b=PS.SPRITE_OVERLAP}}else if(h>=s&&h<s+u){if(p<=o&&y<v||p>=o&&y<a){b=PS.SPRITE_OVERLAP}}if(b){if(f){try{f(t,e.plane,c,l.plane,b)}catch(w){rn(n+t+" collide function failed ["+w.message+"]",w);return}}if(m){try{m(c,l.plane,t,e.plane,b)}catch(E){rn(n+c+" collide function failed ["+E.message+"]",E);return}}}}}}function Dr(e){this.content=[];this.scoreFunction=e}function Pr(e,t,n,r){var i,s,o,u,a,f,l;if(n>e){i=n-e}else{i=e-n}if(r>t){s=r-t}else{s=t-r}if(e<n){o=1}else{o=-1}if(t<r){u=1}else{u=-1}a=i-s;l=[];while(e!==n||t!==r){f=a*2;if(f>-s){a-=s;e+=o}if(e===n&&t===r){l.push([e,t]);break}if(f<i){a+=i;t+=u}l.push([e,t])}return l}function Hr(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d;if(i>n){o=i-n}else{o=n-i}if(s>r){u=s-r}else{u=r-s}if(n<i){a=1}else{a=-1}if(r<s){f=1}else{f=-1}l=o-u;h=[];while(n!==i||r!==s){c=l*2;if(c>-u){l-=u;n+=a}if(n===i&&r===s){h.push([n,r]);return h}if(c<o){l+=o;r+=f}d=r*t+n;p=e[d];if(!p.value){return null}h.push([n,r])}return h}function Br(e,t,n,r){var i,s,o;if(n>e){i=n-e}else{i=e-n}if(r>t){s=r-t}else{s=t-r}if(i>s){o=s*D+(i-s)}else{o=i*D+(s-i)}return o}function jr(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;o=[];u=r.x;a=r.y;f=t-1;l=n-1;p=a*t;c=(a-1)*t;h=(a+1)*t;g=false;y=false;b=false;w=false;if(u>0){d=u-1;v=p+d;m=e[v];if(!m.value){w=true}else if(!m.closed){m.cost=m.value;o.push(m)}}if(u<f){d=u+1;v=p+d;m=e[v];if(!m.value){b=true}else if(!m.closed){m.cost=m.value;o.push(m)}}if(a>0){v=c+u;m=e[v];if(!m.value){g=true}else if(!m.closed){m.cost=m.value;o.push(m)}}if(a<l){v=h+u;m=e[v];if(!m.value){y=true}else if(!m.closed){m.cost=m.value;o.push(m)}}if(!i){if(u>0){d=u-1;if(a>0&&(s||!w&&!g)){v=c+d;m=e[v];if(m.value&&!m.closed){m.cost=m.value*D;o.push(m)}}if(a<l&&(s||!w&&!y)){v=h+d;m=e[v];if(m.value&&!m.closed){m.cost=m.value*D;o.push(m)}}}if(u<f){d=u+1;if(a>0&&(s||!g&&!b)){v=c+d;m=e[v];if(m.value&&!m.closed){m.cost=m.value*D;o.push(m)}}if(a<l&&(s||!y&&!b)){v=h+d;m=e[v];if(m.value&&!m.closed){m.cost=m.value*D;o.push(m)}}}}return o}function Fr(e){return e.f}function Ir(e,t,n,r,i,s,o){var u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;if(t===r&&n===i){return[]}u=e.width;a=e.height;f=e.nodes;l=n*u+t;c=f[l];if(!c.value){return[]}l=i*u+r;c=f[l];if(!c.value){return[]}if(!s){h=Hr(f,u,t,n,r,i);if(h){return h}}p=f.length;for(y=0;y<p;y+=1){c=f[y];c.f=0;c.g=0;c.h=0;c.cost=0;c.closed=false;c.visited=false;c.parent=null}h=[];d=new Dr(Fr);l=n*u+t;c=f[l];d.push(c);while(d.size()>0){v=d.pop();if(v.x===r&&v.y===i){S=v;while(S.parent){h.push([S.x,S.y]);S=S.parent}h.reverse();break}v.closed=true;m=jr(f,u,a,v,s,o);g=m.length;for(y=0;y<g;y+=1){b=m[y];w=v.g+b.cost;E=b.visited;if(!E||w<b.g){b.visited=true;b.parent=v;b.h=b.h||Br(b.x,b.y,r,i);b.g=w;b.f=b.g+b.h;if(!E){d.push(b)}else{d.rescore(b)}}}}return h}function qr(e,t,n,r,i,s){var o,u,a,f,l,c,h,p;o=[];o.length=r*i;u=e.nodes;a=n+i;h=0;for(c=n;c<a;c+=1){f=c*e.width+t;for(l=0;l<r;l+=1){p=u[f];if(s!==PS.CURRENT){if(s===PS.DEFAULT){p.value=p.ovalue}else{p.value=s}}o[h]=p.value;h+=1;f+=1}}return o}function Rr(e,t,n){var r,i,s,o,u,a,f,l;i=n.length;r=[];r.length=i;s=0;for(u=0;u<t;u+=1){for(o=0;o<e;o+=1){f=n[s];a={x:o,y:u,value:f,ovalue:f,f:0,g:0,h:0,cost:0,parent:null,closed:false,visited:false};r[s]=a;s+=1}}l={id:w+Lt,width:e,height:t,nodes:r};Lt+=1;kt.push(l);return l}function Ur(e){var t,n,r;t=kt.length;for(n=0;n<t;n+=1){r=kt[n];if(r.id===e){return r}}return null}function zr(e){var t,n,r,i,s;t=kt.length;for(n=0;n<t;n+=1){r=kt[n];if(r.id===e){i=r.nodes;t=i.length;for(s=0;s<t;s+=1){i[s]=null}r.nodes=null;kt.splice(n,1);return true}}return false}function Wr(e,t,n,r,i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;s=e.nodes;o=e.width;u=e.height;a=1;while(a<o){f=[];l=r-a;h=r+a;c=i-a;p=i+a;d=l;if(d<0){d=0}v=h+1;if(v>=o){v=o}if(c>=0){m=c*o+d;for(g=d;g<v;g+=1){y=s[m];if(y.value){f.push([y.x,y.y])}m+=1}}if(p<u){m=p*o+d;for(g=d;g<v;g+=1){y=s[m];if(y.value){f.push([y.x,y.y])}m+=1}}d=c+1;if(d<0){d=0}v=p;if(v>=u){v=u}if(l>=0){m=d*o+l;for(g=d;g<v;g+=1){y=s[m];if(y.value){f.push([y.x,y.y])}m+=o}}if(h<o){m=d*o+h;for(g=d;g<v;g+=1){y=s[m];if(y.value){f.push([y.x,y.y])}m+=o}}b=f.length;if(b){if(b===1){return f[0]}w=o+u;for(g=0;g<b;g+=1){x=f[g];S=Br(t,n,x[0],x[1]);if(S<w){w=S;E=g}}return f[E]}a+=1}return[t,n]}function Xr(e){$.inputP.style.display="none";Jn();$.statusNode.nodeValue=$.text=e;$.statusP.style.display="block"}function Vr(e){var t,n,r;t=e.which;if(!t){t=e.keyCode}if(t===PS.KEY_ENTER){n=$.input.value;r=$.exec;if(typeof r==="function"){try{r(n)}catch(i){rn("PS.statusInput() function failed ["+i.message+"]",i)}}$.input.removeEventListener("keydown",Vr,false);Xr($.text);return Bt(e)}return true}function $r(e,t){var n;$.statusP.style.display="none";$.label=n=e;if(n.length<1){n=">"}$.inputNode.nodeValue=n;$.exec=t;$.input.value="";Kn();$.input.addEventListener("keydown",Vr,false);$.inputP.style.display="block";$.input.focus()}function Jr(){try{document.createEvent("TouchEvent");return true}catch(e){return false}}function Kr(){var e,t,n,r,i;e=window.navigator.userAgent.toLowerCase();t=window.navigator.platform.toLowerCase();if(/firefox/.test(e)){n="Firefox";if(/fennec/.test(e)){n+=" Mobile"}i=/firefox\/[\.\d]+/.exec(e)[0].split("/")[1]}else if(/chrome/.test(e)){n="Chrome";i=/chrome\/[\d\.]+/.exec(e)[0].split("/")[1]}else if(/safari/.test(e)){n="Safari";if(/iphone/.test(e)||/ipad/.test(e)||/ipod/.test(e)){r="iOS"}}else if(/msie/.test(e)){n="Internet Explorer";if(/iemobile/.test(e)){n+=" Mobile"}i=/msie \d+[.]\d+/.exec(e)[0].split(" ")[1]}else if(/trident/.test(e)){n="Internet Explorer";i=/rv\:\d+[.]\d+/.exec(e)[0].split(":")[1]}else if(/opera/.test(e)){n="Opera";if(/mini/.test(e)){n+=" Mini"}else if(/mobile/.test(e)){n+=" Mobile"}}else if(/android/.test(e)){n="Android";r=/android\s[\.\d]+/.exec(e)}if(!i){try{i=/version\/[\.\d]+/.exec(e);if(i){i=i[0].split("/")[1]}else{i=/opera\/[\.\d]+/.exec(e)[0].split("/")[1]}}catch(s){console.error("Problem detecting browser: "+s.message);i=""}}if(t==="win32"||t==="win64"){r="Windows"}else if(t==="macintel"||t==="macppc"){r="Mac OS X ";r+=/10[\.\_\d]+/.exec(e)[0];if(/[\_]/.test(r)){r=r.split("_").join(".")}}if(!r){if(/linux/.test(t)){r="Linux"}else if(/windows/.test(e)){r="Windows"}}I.host.app=n;if(i){I.host.version=i}I.host.os=r}var e="outer";var t="main";var n="debug";var r="stsp";var i="inp";var s="inlabel";var o="inspan";var u="inbox";var a="grid";var f="footer";var l="monitor";var c="login";var h="login_em";var p="login_pw1";var d="login_pw2";var v="login_but";var m="login_su";var g="login_re";var y="image_";var b="sprite_";var w="pathmap_";var E="timer_";var S=512;var x=1/255;var T=256*256;var N=256;var C=1024;var k={};var L=6;var A=16;var O=17;var M=-1;var _=4;var D=1.4142;var P=16;var H=["a0","bb0","b0","c1","db1","d1","eb1","e1","f1","gb1","g1","ab1","a1","bb1","b1","c2","db2","d2","eb2","e2","f2","gb2","g2","ab2","a2","bb2","b2","c3","db3","d3","eb3","e3","f3","gb3","g3","ab3","a3","bb3","b3","c4","db4","d4","eb4","e4","f4","gb4","g4","ab4","a4","bb4","b4","c5","db5","d5","eb5","e5","f5","gb5","g5","ab5","a5","bb5","b5","c6","db6","d6","eb6","e6","f6","gb6","g6","ab6","a6","bb6","b6","c7","db7","d7","eb7","e7","f7","gb7","g7","ab7","a7","bb7","b7","c8"];var B=["a2","bb2","b2","c3","db3","d3","eb3","e3","f3","gb3","g3","ab3","a3","bb3","b3","c4","db4","d4","eb4","e4","f4","gb4","g4","ab4","a4","bb4","b4","c5","db5","d5","eb5","e5","f5","gb5","g5","ab5","a5","bb5","b5","c6","db6","d6","eb6","e6","f6","gb6","g6","ab6","a6","bb6","b6","c7","db7","d7","eb7","e7","f7"];var j=["a4","bb4","b4","c5","db5","d5","eb5","e5","f5","gb5","g5","ab5","a5","bb5","b5","c6","db6","d6","eb6","e6","f6","gb6","g6","ab6","a6","bb6","b6","c7","db7","d7","eb7","e7","f7","gb7","g7","ab7","a7","bb7","b7"];var F={grid:{x:8,y:8,max:32,plane:0,color:{r:255,g:255,b:255,a:255,rgb:16777215,str:"rgba(255,255,255,1)"},shadow:{show:false,r:192,g:192,b:192,a:255,rgb:12632256,str:"rgba(192,192,192,1)",params:"0px 0px 64px 8px "},padLeft:0,padRight:0,ready:false},status:{text:"",label:"",exec:null,color:{r:0,g:0,b:0,a:255,rgb:0,str:"rgba(0,0,0,1)"}},fader:{active:false,kill:false,r:0,g:0,b:0,rgb:null,tr:0,tg:0,tb:0,trgb:0,tstr:null,step:0,rate:0,onStep:null,onEnd:null,params:null},bead:{dirty:true,active:true,visible:true,planes:null,color:{r:255,g:255,b:255,a:255,rgb:16777215,str:"rgba(255,255,255,1)"},radius:0,scale:100,data:0,exec:null,border:{width:1,equal:true,top:1,left:1,bottom:1,right:1,color:{r:128,g:128,b:128,a:255,rgb:8421504,str:"rgba(128,128,128,1)"}},glyph:{str:"",code:0,scale:100,size:0,x:0,y:0,font:null,color:{r:0,g:0,b:0,a:255,rgb:0,str:"rgba(0,0,0,1)"}}},audio:{volume:.5,max_volume:1,path:"http://alpheus.wpi.edu/~bmoriarty/ps/audio/",loop:false,error_sound:"fx_uhoh"}};var I={engine:"Perlenspiel",major:3,minor:1,revision:4,audio:null,host:{app:"",version:"",os:""},inputs:{touch:false}};var q,R,U,z;var W;var X;var V;var $;var J=false;var K;var Q;var G;var Y;var Z;var et;var tt;var nt;var rt;var it;var st;var ot;var ut;var at;var ft;var lt;var ct;var ht;var pt;var dt;var vt;var mt;var gt;var yt;var bt;var wt;var Et;var St=-1;var xt;var Tt;var Nt;var Ct;var kt;var Lt;var At=null;var Ot=50;var Mt=1;var Rt={rgb:0,r:0,g:0,b:0,str:""};var Zt=true;var en=false;var vn={rgb:0,r:0,g:0,b:0,str:""};var bn={rgb:0,r:null,g:null,b:null,str:""};Dr.prototype={push:function(e){this.content.push(e);this.bubbleUp(this.content.length-1)},pop:function(){var e,t;e=this.content[0];t=this.content.pop();if(this.content.length>0){this.content[0]=t;this.sinkDown(0)}return e},remove:function(e){var t,n,r;t=this.content.length;for(n=0;n<t;n+=1){if(this.content[n]===e){r=this.content.pop();if(n!==t-1){this.content[n]=r;this.bubbleUp(n);this.sinkDown(n)}break}}},size:function(){var e;e=this.content.length;return e},bubbleUp:function(e){var t,n,r,i;t=this.content[e];n=this.scoreFunction(t);while(e>0){r=Math.floor((e+1)/2)-1;i=this.content[r];if(n>=this.scoreFunction(i)){break}this.content[r]=t;this.content[e]=i;e=r}},sinkDown:function(e){var t,n,r,i,s,o,u,a,f,l;t=this.content.length;n=this.content[e];r=this.scoreFunction(n);while(true){s=(e+1)*2;i=s-1;o=null;if(i<t){u=this.content[i];a=this.scoreFunction(u);if(a<r){o=i}}if(s<t){f=this.content[s];l=this.scoreFunction(f);if(l<(o===null?r:a)){o=s}}if(o===null){break}this.content[e]=this.content[o];this.content[o]=n;e=o}},rescore:function(e){this.sinkDown(this.content.indexOf(e))}};PS={ALL:"PS.ALL",CURRENT:"PS.CURRENT",DONE:"PS.DONE",DEFAULT:"PS.DEFAULT",ERROR:"PS.ERROR",EMPTY:"PS.EMPTY",UNEQUAL:"PS.UNEQUAL",GRID:"PS.GRID",STATUS:"PS.STATUS",HTML5_AUDIO:"PS.HTML5_AUDIO",WEB_AUDIO:"PS.WEB_AUDIO",SPRITE_TOUCH:"PS.SPRITE_TOUCH",SPRITE_OVERLAP:"PS.SPRITE_OVERLAP",COLOR_BLACK:0,COLOR_WHITE:16777215,COLOR_GRAY_LIGHT:12632256,COLOR_GRAY:8421504,COLOR_GRAY_DARK:4210752,COLOR_RED:16711680,COLOR_ORANGE:16744448,COLOR_YELLOW:16776960,COLOR_GREEN:65280,COLOR_BLUE:255,COLOR_INDIGO:4194559,COLOR_VIOLET:8388863,COLOR_MAGENTA:16711935,COLOR_CYAN:65535,ALPHA_OPAQUE:255,ALPHA_TRANSPARENT:0,KEY_ENTER:13,KEY_TAB:9,KEY_ESCAPE:27,KEY_PAGE_UP:1001,KEY_PAGE_DOWN:1002,KEY_END:1003,KEY_HOME:1004,KEY_ARROW_LEFT:1005,KEY_ARROW_UP:1006,KEY_ARROW_RIGHT:1007,KEY_ARROW_DOWN:1008,KEY_INSERT:1009,KEY_DELETE:1010,KEY_PAD_0:96,KEY_PAD_1:97,KEY_PAD_2:98,KEY_PAD_3:99,KEY_PAD_4:100,KEY_PAD_5:101,KEY_PAD_6:102,KEY_PAD_7:103,KEY_PAD_8:104,KEY_PAD_9:105,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,WHEEL_FORWARD:"PS.WHEEL_FORWARD",WHEEL_BACKWARD:"PS.WHEEL_BACKWARD",FINDER_ASTAR:"PS.FINDER_ASTAR",FINDER_BREADTH_FIRST:"PS.FINDER_BREADTH_FIRST",FINDER_BEST_FIRST:"PS.FINDER_BEST_FIRST",FINDER_DIJKSTRA:"PS.FINDER_DIJKSTRA",FINDER_BI_ASTAR:"PS.FINDER_BI_ASTAR",FINDER_BI_BEST_FIRST:"PS.FINDER_BI_BEST_FIRST",FINDER_BI_DIJKSTRA:"PS.FINDER_BI_DIJKSTRA",FINDER_BI_BREADTH_FIRST:"PS.FINDER_BI_BREADTH_FIRST",FINDER_JUMP_POINT:"PS.FINDER_JUMP_POINT",_lastTick:0,_clock:function(){if(et){window.requestAnimationFrame(PS._clock);dn()}},_sys:function(){var c,h,p,d,v,m,g,y,b,w,E,T,N,A,O,M,_,D,P,H;c="[PS.sys] ";h=c+"Invalid element";if(!String.fromCodePoint){String.fromCodePoint=jt}q=[];q.length=256;R=[];R.length=256;U=[];U.length=256;z=[];z.length=256;for(p=0;p<256;p+=1){q[p]="rgba("+p+",";R[p]=p+",";U[p]=p+",1)";M=Math.floor(x*p*1e3)/1e3;z[p]=M+")"}Kr();yt=screen.width/document.documentElement.clientWidth;gt=Jr();I.inputs.touch=gt;document.body.id="body";document.body.style.backgroundColor=F.grid.color.str;d=document.createElement("div");if(!d){window.alert(h);return}d.id=e;document.body.appendChild(d);W=document.createElement("div");if(!W){window.alert(h);return}W.id=t;d.appendChild(W);PS._mainLeft=W.offsetLeft;PS._mainTop=W.offsetTop;m=document.createElement("p");m.id=r;m.style.whiteSpace="nowrap";m.style.display="block";g=document.createTextNode("");m.appendChild(g);W.appendChild(m);y=document.createElement("p");y.id=i;y.style.display="none";w=document.createElement("span");w.id=s;b=document.createTextNode("");w.appendChild(b);y.appendChild(w);w=document.createElement("span");w.id=o;E=document.createElement("input");E.id=u;E.type="text";E.tabindex=0;E.wrap="soft";w.appendChild(E);y.appendChild(w);W.appendChild(y);$={statusP:m,statusNode:g,inputP:y,inputNode:b,input:E,fader:fn(r,Xt,null)};Ht(F.status,$);Xr("Perlenspiel 3.1");T=document.createElement("canvas");if(!T){window.alert(c+"HTML5 canvas not supported.");return}T.id=a;T.width=S;T.style.backgroundColor=F.grid.color.str;T.style.boxShadow="none";Et=false;Dn();W.appendChild(T);N=document.createElement("p");if(!N){window.alert(h);return}N.id=f;N.style.opacity="1.0";N.innerHTML="Loading Perlenspiel";W.appendChild(N);Nt=N;v=document.createElement("div");if(!v){window.alert(h);return}v.id=n;W.appendChild(v);A=document.createElement("textarea");if(!A){window.alert(h);return}A.id=l;A.rows=8;A.wrap="soft";A.readonly="readonly";A.onfocus=function(){Tt=true};A.onblur=function(){Tt=false};v.appendChild(A);xt=false;Tt=false;st=false;ft=[];ot=[];ut=[];at=[];for(p=0;p<256;p+=1){ft[p]=0;ot[p]=p;ut[p]=p;at[p]=p}lt=[];ct=false;ht=false;pt=true;vt=L;mt=L*5;ot[33]=PS.KEY_PAGE_UP;ot[34]=PS.KEY_PAGE_DOWN;ot[35]=PS.KEY_END;ot[36]=PS.KEY_HOME;ot[37]=PS.KEY_ARROW_LEFT;ot[38]=PS.KEY_ARROW_UP;ot[39]=PS.KEY_ARROW_RIGHT;ot[40]=PS.KEY_ARROW_DOWN;ot[45]=PS.KEY_INSERT;ot[46]=PS.KEY_DELETE;ot[188]=44;ot[190]=46;ot[191]=47;ot[192]=96;ot[219]=91;ot[220]=92;ot[221]=93;ot[222]=39;ut[96]=126;ut[49]=33;ut[50]=64;ut[51]=35;ut[52]=36;ut[53]=37;ut[54]=94;ut[55]=38;ut[56]=42;ut[57]=40;ut[48]=41;ut[45]=95;ut[61]=43;ut[91]=123;ut[93]=125;ut[92]=124;ut[59]=58;ut[39]=34;ut[44]=60;ut[46]=62;ut[47]=63;for(p=65;p<91;p+=1){at[p]=p+32}at[126]=96;at[33]=49;at[64]=50;at[35]=51;at[36]=52;at[37]=53;at[94]=54;at[38]=55;at[42]=56;at[40]=57;at[41]=48;at[95]=45;at[43]=51;at[123]=91;at[125]=93;at[124]=92;at[58]=59;at[34]=39;at[60]=44;at[62]=46;at[63]=47;window.onblur=Un();O=T.getContext("2d");if(!O.constructor.prototype.fillRoundedRect){O.constructor.prototype.fillRoundedRect=function(e,t,n,r,i,s,o){if(i===undefined){i=5}this.beginPath();if(I.host.app==="Opera"){this.moveTo(e+n-i,t);this.arcTo(e+i,t,e,t+i,i);this.arcTo(e,t+r-i,e+i,t+r,i);this.arcTo(e+n-i,t+r,e+n,t+r-i,i);this.arcTo(e+n,t+i,e+n-i,t,i)}else{this.moveTo(e+i,t);this.arcTo(e+n,t,e+n,t+r,i);this.arcTo(e+n,t+r,e,t+r,i);this.arcTo(e,t+r,e,t,i);this.arcTo(e,t,e+n,t,i)}this.closePath();if(o){this.stroke()}if(s||s===undefined){this.fill()}}}X={canvas:T,context:O,fader:fn(a,Ut,zt)};Ht(F.grid,X);var B=window.getComputedStyle(X.canvas,null);X.padLeft=parseInt(B.getPropertyValue("padding-top").replace("px",""),10);X.padRight=parseInt(B.getPropertyValue("padding-left").replace("px",""),10);V=[];V.length=M=C;for(p=0;p<M;p+=1){_={index:p,fader:fn(p,Vt,null),borderFader:fn(p,$t,null),glyphFader:fn(p,Jt,null)};Sn(_);V[p]=_}Y=[];Z=0;kt=[];Lt=0;D=null;if(I.host.os!=="iOS"){D=AQ.init({defaultPath:F.audio.path,defaultFileTypes:["ogg","mp3","wav"],onAlert:PS.debug,stack:true,forceHTML5:true});if(D===PS.ERROR||D.status===AQ.ERROR){return}I.audio=D;Ct=null;P=PS.audioLoad(F.audio.error_sound,{path:F.audio.path,lock:true});if(P===PS.ERROR){Yt("Error sound '"+F.audio.error_sound+"' not loaded")}else{Ct=F.audio.error_sound}}K=document.createElement("canvas");O=K.getContext("2d");O.imageSmoothingEnabled=false;O.mozImageSmoothingEnabled=false;O.webkitImageSmoothingEnabled=false;Q=[];G=0;H="() event function undefined";if(typeof PS.init!=="function"){PS.init=null;Yt("PS.init"+H)}if(typeof PS.touch!=="function"){PS.touch=null;Yt("PS.touch"+H)}if(typeof PS.release!=="function"){PS.release=null;Yt("PS.release"+H)}if(typeof PS.enter!=="function"){PS.enter=null;Yt("PS.enter"+H)}if(typeof PS.exit!=="function"){PS.exit=null;Yt("PS.exit()"+H)}if(typeof PS.exitGrid!=="function"){PS.exitGrid=null;Yt("PS.exitGrid"+H)}if(typeof PS.keyDown!=="function"){PS.keyDown=null;Yt("PS.keyDown"+H)}if(typeof PS.keyUp!=="function"){PS.keyUp=null;Yt("PS.keyUp"+H)}if(typeof PS.input!=="function"){PS.input=null;Yt("PS.input"+H)}H="PS "+I.major+"."+I.minor+"."+I.revision+" | ";if(D){H+=D.engine+" "+D.major+"."+D.minor+"."+D.revision+" | "}H+=I.host.os+" "+I.host.app+" "+I.host.version;if(gt){H+=" | Touch "}N.innerHTML=H;Zn(F.grid.x,F.grid.y);un();pn();et=true;PS._clock();Qn();At=PS.timerStart(6,_t);if(PS.init){try{PS.init(I,k);Qt()}catch(j){rn("PS.init() failed ["+j.message+"]",j)}}},gridSize:function(e,t){var n,r,i,s;n="[PS.gridSize] ";if(arguments.length>2){return sn(n+"Too many arguments")}r=e;i=t;s=F.grid.max;if(r===PS.DEFAULT){r=F.grid.x}else if(r===PS.CURRENT){r=X.x}else if(Dt(r)==="number"){r=Math.floor(r);if(r<1){r=1}else if(r>s){r=s}}else{return sn(n+"x argument invalid")}if(i===PS.DEFAULT){i=F.grid.y}else if(i===PS.CURRENT){i=X.y}else if(Dt(i)==="number"){i=Math.floor(i);if(i<1){i=1}else if(i>s){i=s}}else{return sn(n+"y argument invalid")}Zn(r,i);return{width:X.x,height:X.y}},gridPlane:function(e){var t,n,r;t="[PS.gridPlane] ";if(arguments.length>1){return sn(t+"Too many arguments")}n=e;r=Dt(n);if(r!=="undefined"&&n!==PS.CURRENT){if(n===PS.DEFAULT){n=0}else if(r==="number"){n=Math.floor(n);if(n<1){n=0}}else{return sn(t+"plane argument invalid")}X.plane=n}return X.plane},gridColor:function(e,t,n){var r,i;r="[PS.gridColor] ";if(arguments.length>3){return sn(r+"Too many arguments")}i=wn(r,e,t,n);if(i===PS.ERROR){return PS.ERROR}return Gn(i)},gridFade:function(e,t){var n,r,i,s,o,u,a,f;n="[PS.gridFade] ";if(arguments.length>2){return sn(n+"Too many arguments")}i=X.color;r=X.fader;s=r.rate;a=Dt(e);if(a==="undefined"||e===PS.CURRENT){o=s}else if(e===PS.DEFAULT){o=F.fader.rate}else if(a==="number"){o=Math.floor(e);if(o<0){o=0}}else{return sn(n+"rate argument invalid")}u=sr(n,t);if(u===PS.ERROR){return PS.ERROR}f=u.rgb;if(f!==PS.CURRENT){if(f===PS.DEFAULT){r.rgb=F.fader.rgb}else{r.rgb=f}r.r=u.r;r.g=u.g;r.b=u.b}f=u.onStep;if(f!==PS.CURRENT){if(f===PS.DEFAULT){r.onStep=F.fader.onStep}else{r.onStep=f}}f=u.onEnd;if(f!==PS.CURRENT){if(f===PS.DEFAULT){r.onEnd=F.fader.onEnd}else{r.onEnd=f}}f=u.params;if(f!==PS.CURRENT){if(f===PS.DEFAULT){r.params=F.fader.params}else{r.params=f}}if(s!==o){r.rate=o;if(o<1){r.active=false;r.kill=true}else if(r.active){hn(r,i.r,i.g,i.b,255)}}return{rate:r.rate,rgb:r.rgb,onStep:r.onStep,onEnd:r.onEnd,params:r.params}},gridShadow:function(e,t,n,r){var i,s,o;i="[PS.gridShadow] ";if(arguments.length>4){return sn(i+"Too many arguments")}s=e;if(s!==true&&s!==false&&s!==PS.CURRENT){if(s===null||s===PS.DEFAULT){s=false}else if(Dt(s)==="number"){s=s!==0}else{return sn(i+"First argument invalid")}}o=wn(i,t,n,r);if(o===PS.ERROR){return PS.ERROR}return Yn(s,o)},color:function(e,t,n,r,i){var s,o,u;s="[PS.color] ";o=arguments.length;if(o<2){return sn(s+"Missing argument(s)")}if(o>5){return sn(s+"Too many arguments")}u=wn(s,n,r,i);if(u===PS.ERROR){return PS.ERROR}return nr(s,rr,e,t,u)},alpha:function(e,t,n){var r,i,s,o;r="[PS.alpha] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=n;if(s!==PS.CURRENT){o=Dt(s);if(o==="undefined"){s=PS.CURRENT}else if(o==="number"){s=Math.floor(s);if(s<0){s=0}else if(s>255){s=255}}else if(s===PS.DEFAULT){s=F.bead.color.a}else{return sn(r+"alpha argument invalid")}}return nr(r,ir,e,t,s)},fade:function(e,t,n,r){var i,s,o,u,a;i="[PS.fade] ";s=arguments.length;if(s<2){return sn(i+"Missing argument(s)")}if(s>4){return sn(i+"Too many arguments")}o=n;if(o!==PS.CURRENT&&o!==PS.DEFAULT){u=Dt(o);if(u==="undefined"){o=PS.CURRENT}else if(u==="number"){o=Math.floor(o);if(o<0){o=0}}else{return sn(i+"rate argument invalid")}}a=sr(i,r);if(a===PS.ERROR){return PS.ERROR}return nr(i,or,e,t,o,a)},scale:function(e,t,n){var r,i,s,o;r="[PS.scale] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=n;if(s!==PS.CURRENT){o=Dt(s);if(o==="undefined"){s=PS.CURRENT}else if(s===PS.DEFAULT){s=100}else if(o==="number"){s=Math.floor(s);if(s<50){s=50}else if(s>100){s=100}}else{return sn(r+"scale parameter invalid")}}return nr(r,ur,e,t,s)},radius:function(e,t,n){var r,i,s,o;r="[PS.radius] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=n;if(s!==PS.CURRENT){o=Dt(s);if(o==="undefined"){s=PS.CURRENT}else if(s===PS.DEFAULT){s=0}else if(o==="number"){s=Math.floor(s);if(s<0){s=0}else if(s>50){s=50}}else{return sn(r+"radius parameter invalid")}}return nr(r,ar,e,t,s)},data:function(e,t,n){var r,i,s;r="[PS.data] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=n;if(s===undefined){s=PS.CURRENT}else if(s===PS.DEFAULT){s=null}return nr(r,fr,e,t,s)},exec:function(e,t,n){var r,i,s,o;r="[PS.exec] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=n;if(s!==PS.CURRENT){o=Dt(s);if(o==="undefined"){s=PS.CURRENT}else if(s===PS.DEFAULT){s=F.bead.exec}else if(o!=="function"){return sn(r+"exec argument invalid")}}return nr(r,lr,e,t,s)},visible:function(e,t,n){var r,i,s;r="[PS.visible] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=Pt(n,PS.CURRENT,true,PS.CURRENT);if(s===PS.ERROR){return sn(r+"show argument invalid")}return nr(r,cr,e,t,s)},active:function(e,t,n){var r,i,s;r="[PS.active] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=Pt(n,PS.CURRENT,true,PS.CURRENT);if(s===PS.ERROR){return sn(r+"active argument invalid")}return nr(r,hr,e,t,s)},border:function(e,t,n){var r,i,s,o,u,a;r="[PS.border] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=F.bead.border;o=n;if(o!==PS.CURRENT){u=Dt(o);if(u==="undefined"){o=PS.CURRENT}else if(o===PS.DEFAULT){o=s.width}else if(u==="number"){o=Math.floor(o);if(o<0){o=0}}else if(u==="object"){a=o.top;if(a!==PS.CURRENT){u=Dt(a);if(u==="undefined"){o.top=PS.CURRENT}else if(u==="number"){a=Math.floor(a);if(a<0){a=0}o.top=a}else if(a===PS.DEFAULT){o.top=s.top}else{return sn(r+".top property invalid")}}a=o.left;if(a!==PS.CURRENT){u=Dt(a);if(u==="undefined"){o.left=PS.CURRENT}else if(u==="number"){a=Math.floor(a);if(a<0){a=0}o.left=a}else if(a===PS.DEFAULT){o.left=s.left}else{return sn(r+".left property invalid")}}a=o.bottom;if(a!==PS.CURRENT){u=Dt(a);if(u==="undefined"){o.bottom=PS.CURRENT}else if(u==="number"){a=Math.floor(a);if(a<0){a=0}o.bottom=a}else if(a===PS.DEFAULT){o.bottom=s.bottom}else{return sn(r+".bottom property invalid")}}a=o.right;if(a!==PS.CURRENT){u=Dt(a);if(u==="undefined"){o.right=PS.CURRENT}else if(u==="number"){a=Math.floor(a);if(a<0){a=0}o.right=a}else if(a===PS.DEFAULT){o.right=s.right}else{return sn(r+".right property invalid")}}}else{return sn(r+"width argument invalid")}}return nr(r,pr,e,t,o)},borderColor:function(e,t,n,r,i){var s,o;s="[PS.borderColor] ";if(arguments.length<2){return sn(s+"Missing argument(s)")}if(arguments.length>5){return sn(s+"Too many arguments")}o=wn(s,n,r,i);if(o===PS.ERROR){return PS.ERROR}return nr(s,dr,e,t,o)},borderAlpha:function(e,t,n){var r,i,s,o;r="[PS.borderAlpha] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=n;if(s!==PS.CURRENT){o=Dt(s);if(o==="undefined"){s=PS.CURRENT}else if(o==="number"){s=Math.floor(s);if(s<0){s=0}else if(s>255){s=255}}else if(s===PS.DEFAULT){s=F.bead.border.color.a}else{return sn(r+"alpha argument invalid")}}return nr(r,vr,e,t,s)},borderFade:function(e,t,n,r){var i,s,o,u,a;i="[PS.borderFade] ";s=arguments.length;if(s<2){return sn(i+"Missing argument(s)")}if(s>4){return sn(i+"Too many arguments")}o=n;if(o!==PS.CURRENT&&o!==PS.DEFAULT){u=Dt(o);if(u==="undefined"){o=PS.CURRENT}else if(u==="number"){o=Math.floor(o);if(o<0){o=0}}else{return sn(i+"rate argument not a number")}}a=sr(i,r);if(a===PS.ERROR){return PS.ERROR}return nr(i,mr,e,t,o,a)},glyph:function(e,t,n){var r,i,s,o;r="[PS.glyph] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=n;if(s!==PS.CURRENT){o=Dt(s);if(o==="undefined"){s=PS.CURRENT}else if(s===PS.DEFAULT){s=0}else if(o==="string"){if(s.length>0){s=s.charCodeAt(0)}else{s=0}}else if(o==="number"){s=Math.floor(s);if(s<1){s=0}}else{return sn(r+"glyph argument invalid")}}return nr(r,gr,e,t,s)},glyphColor:function(e,t,n,r,i){var s,o;s="[PS.glyphColor] ";if(arguments.length<2){return sn(s+"Missing argument(s)")}if(arguments.length>5){return sn(s+"Too many arguments")}o=wn(s,n,r,i);if(o===PS.ERROR){return PS.ERROR}return nr(s,yr,e,t,o)},glyphAlpha:function(e,t,n){var r,i,s,o;r="[PS.glyphAlpha] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=n;if(s!==PS.CURRENT){o=Dt(s);if(o==="undefined"){s=PS.CURRENT}else if(o==="number"){s=Math.floor(s);if(s<0){s=0}else if(s>255){s=255}}else if(s===PS.DEFAULT){s=F.bead.glyph.color.a}else{return sn(r+"alpha argument invalid")}}return nr(r,br,e,t,s)},glyphScale:function(e,t,n){var r,i,s,o;r="[PS.glyphScale] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many arguments")}s=n;if(s!==PS.CURRENT){o=Dt(s);if(o==="undefined"){s=PS.CURRENT}else if(o==="number"){s=Math.floor(s);if(s<50){s=50}else if(s>100){s=100}}else if(s===PS.DEFAULT){s=F.bead.glyph.scale}else{return sn(r+"scale argument invalid")}}return nr(r,wr,e,t,s)},glyphFade:function(e,t,n,r){var i,s,o,u,a;i="[PS.glyphFade] ";s=arguments.length;if(s<2){return sn(i+"Missing argument(s)")}if(s>4){return sn(i+"Too many arguments")}o=n;if(o!==PS.CURRENT&&o!==PS.DEFAULT){u=Dt(o);if(u==="undefined"){o=PS.CURRENT}else if(u==="number"){o=Math.floor(o);if(o<0){o=0}}else{return sn(i+"rate argument not a number")}}a=sr(i,r);if(a===PS.ERROR){return PS.ERROR}return nr(i,Er,e,t,o,a)},statusText:function(e){var t,n,r;t="[PS.statusText] ";if(arguments.length>1){return sn(t+"Too many arguments")}n=e;r=Dt(n);if(n!==PS.CURRENT&&r!=="undefined"){if(n===PS.DEFAULT){n=F.status.text}else if(r!=="string"){n=n.toString()}Xr(n)}return $.text},statusInput:function(e,t){var n,r,i,s;n="[PS.statusInput] ";if(arguments.length!==2){return sn(n+"Expected 2 arguments")}if(typeof t!=="function"){return sn(n+"2nd argument is not a function")}i=e;r=Dt(i);if(r!=="string"){i=i.toString()}s=i.length;if(s>P){i=i.substring(0,P)}$r(i,t);return $.label},statusColor:function(e,t,n){var r,i,s,o,u,a,f,l;r="[PS.statusColor] ";if(arguments.length>3){return sn(r+"Too many arguments")}i=wn(r,e,t,n);if(i===PS.ERROR){return PS.ERROR}s=$.color;o=$.fader;u=i.rgb;if(u!==PS.CURRENT){if(u===null){a=i.r;if(a===PS.CURRENT){i.r=a=s.r}else if(a===PS.DEFAULT){i.r=a=F.status.color.r}f=i.g;if(f===PS.CURRENT){i.g=f=s.g}else if(f===PS.DEFAULT){i.g=f=F.status.color.g}l=i.b;if(l===PS.CURRENT){i.b=l=s.b}else if(l===PS.DEFAULT){i.b=l=F.status.color.b}i.rgb=a*T+f*N+l}else if(u===PS.DEFAULT){Ht(F.status.color,i)}if(s.rgb!==i.rgb||o.rate>0&&o.rgb!==null&&o.rgb!==i.rgb){s.rgb=i.rgb;a=i.r;f=i.g;l=i.b;s.str=i.str=q[a]+R[f]+U[l];if(o.rate>0){if(o.rgb!==null){cn(o,o.r,o.g,o.b,255,a,f,l,255)}if(!o.active){cn(o,s.r,s.g,s.b,255,a,f,l,255)}else{hn(o,a,f,l,255)}}else{Xt(s)}s.r=a;s.g=f;s.b=l}}return s.rgb},statusFade:function(e,t){var n,r,i,s,o,u,a,f;n="[PS.statusFade] ";if(arguments.length>2){return sn(n+"Too many arguments")}i=$.color;r=$.fader;s=r.rate;u=Dt(e);if(u==="undefined"||e===PS.CURRENT){o=s}else if(e===PS.DEFAULT){o=F.fader.rate}else if(u==="number"){o=Math.floor(e);if(o<0){o=0}}else{return sn(n+"rate argument invalid")}f=sr(n,t);if(f===PS.ERROR){return PS.ERROR}a=f.rgb;if(a!==PS.CURRENT){if(a===PS.DEFAULT){r.rgb=F.fader.rgb}else{r.rgb=a}r.r=f.r;r.g=f.g;r.b=f.b}a=f.onStep;if(a!==PS.CURRENT){if(a===PS.DEFAULT){r.onStep=F.fader.onStep}else{r.onStep=a}}a=f.onEnd;if(a!==PS.CURRENT){if(a===PS.DEFAULT){r.onEnd=F.fader.onEnd}else{r.onEnd=a}}a=f.params;if(a!==PS.CURRENT){if(a===PS.DEFAULT){r.params=F.fader.params}else{r.params=a}}if(s!==o){r.rate=o;if(o<1){r.active=false;r.kill=true}else if(r.active){hn(r,i.r,i.g,i.b,255)}}return{rate:r.rate,rgb:r.rgb,onStep:r.onStep,onEnd:r.onEnd,params:r.params}},timerStart:function(e,t){var n,r,i,s,o,u,a,f,l,c;n="[PS.timerStart] ";r=arguments.length;if(r<2){return sn(n+"Argument(s) missing")}i=e;s=t;if(i===PS.DEFAULT){i=60}else{o=Dt(i);if(o!=="number"){return sn(n+"ticks argument invalid")}i=Math.floor(i);if(i<1){return sn(n+"ticks argument less than one (1)")}}if(typeof s!=="function"){return sn(n+"exec argument not a function")}a=[];if(r>2){l=r-2;a.length=l;for(f=0;f<l;f+=1){a[f]=arguments[f+2]}}c=E+nt;nt+=1;u={id:c,delay:i,count:i,exec:s,arglist:a};tt.push(u);return c},timerStop:function(e){var t,n,r,i,s;t="[PS.timerStop] ";n=arguments.length;if(n<1){return sn(t+"Argument missing")}if(typeof e!=="string"||e.length<1){return sn(t+"id argument invalid")}i=tt.length;for(r=0;r<i;r+=1){s=tt[r];if(s.id===e){tt.splice(r,1);return e}}return sn(t+"timer id '"+e+"' not found")},random:function(e){var t,n;t="[PS.random] ";if(arguments.length<1){return sn(t+"Argument missing")}n=e;if(Dt(n)!=="number"){return sn(t+"Argument not a number")}n=Math.floor(n);if(n<2){return 1}n=Math.random()*n;n=Math.floor(n)+1;return n},makeRGB:function(e,t,n){var r,i,s,o,u;r="[PS.makeRGB] ";i=arguments.length;if(i<3){return sn(r+"Argument(s) missing")}if(i>3){return sn(r+"Too many arguments")}s=e;o=t;u=n;if(Dt(s)!=="number"){return sn(r+"r argument not a number")}s=Math.floor(s);if(s<0){s=0}else if(s>255){s=255}if(Dt(o)!=="number"){return sn(r+"g argument not a number")}o=Math.floor(o);if(o<0){o=0}else if(o>255){o=255}if(Dt(u)!=="number"){return sn(r+"b argument not a number")}u=Math.floor(u);if(u<0){u=0}else if(u>255){u=255}return s*T+o*N+u},unmakeRGB:function(e,t){var n,r,i,s,o,u,a,f,l,c;n="[PS.unmakeRGB] ";r=arguments.length;if(r<2){return sn(n+"Missing argument(s)")}if(r>2){return sn(n+"Too many arguments")}i=e;s=t;if(Dt(i)!=="number"){return sn(n+"rgb argument not a number")}i=Math.floor(i);if(i<1){i=0;o=0;u=0;a=0}else if(i>=16777215){i=16777215;o=255;u=255;a=255}else{o=i/T;o=Math.floor(o);f=o*T;u=(i-f)/N;u=Math.floor(u);l=u*N;a=i-f-l}c=Dt(s);if(c==="object"){s.rgb=i;s.r=o;s.g=u;s.b=a}else if(c==="array"){if(s.length<3){s.length=3}s[0]=o;s[1]=u;s[2]=a}else{return sn(n+"result argument not an array or object reference")}return s},applyRect:function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;s="[PS.applyRect] ";o=arguments.length;if(o<5){return sn(s+"Argument(s) missing")}u=X.x;a=X.y;f=e;l=t;c=n;h=r;p=i;if(f===PS.DEFAULT){f=0}else if(Dt(f)==="number"){f=Math.floor(f);if(f>=u){return PS.DONE}if(f<0){f=0}}else{return sn(s+"left argument invalid")}if(l===PS.DEFAULT){l=0}else if(Dt(l)==="number"){l=Math.floor(l);if(l>=a){return PS.DONE}if(l<0){l=0}}else{return sn(s+"top argument invalid")}if(c===PS.DEFAULT){c=u-f}else if(Dt(c)==="number"){c=Math.floor(c);if(c<1){return PS.DONE}if(f+c>u){c=u-f}}else{return sn(s+"width argument invalid")}d=f+c;if(h===PS.DEFAULT){h=a-l}else if(Dt(h)==="number"){h=Math.floor(h);if(h<1){return PS.DONE}if(l+h>a){h=a-l}}else{return sn(s+"height argument invalid")}v=l+h;if(!p||typeof p!=="function"){return sn(s+"exec argument not a function")}b=[0,0];if(o>5){w=o-5;for(E=0;E<w;E+=1){b.push(arguments[E+5])}}for(g=l;g<v;g+=1){b[1]=g;for(m=f;m<d;m+=1){b[0]=m;try{y=p.apply(k,b)}catch(S){y=rn(s+"exec failed @"+m+", "+g+" ["+S.message+"]",S)}if(y===PS.ERROR){return PS.ERROR}}}return y},hex:function(e,t){var n,r,i,s,o;n="[PS.hex] ";r=e;i=Dt(r);if(i!=="number"){return sn(n+"value argument invalid")}r=Math.floor(r);r=Math.abs(r);s=t;i=Dt(s);if(i==="undefined"||s===PS.DEFAULT){s=2}else if(i==="number"){s=Math.floor(s);if(s<1){s=1}}else{return sn(n+"padding argument invalid")}o=Number(r).toString(16);while(o.length<s){o="0"+o}return"0x"+o},keyRepeat:function(e,t,n){var r,i,s,o,u;r="[PS.keyRepeat] ";s=Pt(e,pt,true,true);if(s===PS.ERROR){return sn(r+"repeat argument invalid")}u=t;i=Dt(u);if(i==="undefined"||u===PS.DEFAULT){u=L*5}else if(u===PS.CURRENT){u=mt}else if(i==="number"){u=Math.floor(u);if(u<1){u=1}}else{return sn(r+"init argument invalid")}o=n;i=Dt(o);if(i==="undefined"||o===PS.DEFAULT){o=L}else if(o===PS.CURRENT){o=vt}else if(i==="number"){o=Math.floor(o);if(o<1){o=1}}else{return sn(r+"delay argument invalid")}pt=s;mt=u;vt=o;return{repeat:pt,init:mt,delay:vt}},imageLoad:function(e,t,n){var r,i,s,o,u,a,f,l,c;r="[PS.imageLoad] ";i=arguments.length;if(i<2){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many argument(s)")}s=e;o=t;u=n;if(typeof s!=="string"||s.length<1){return sn(r+"filename argument invalid")}a=s.substr(s.lastIndexOf(".")+1);a=a.toLowerCase();if(a!=="png"&&a!=="jpg"&&a!=="jpeg"&&a!=="bmp"){return sn(r+"filename extension invalid")}if(typeof o!=="function"){return sn(r+"exec argument invalid")}c=Dt(u);if(c==="undefined"||u===PS.DEFAULT){u=4}else{if(c!=="number"){return sn(r+"format argument invalid")}u=Math.floor(u);if(u<1&&u>4){return sn(r+"format argument is not 1, 2, 3 or 4")}}l=y+G;G+=1;Q.push({source:s,id:l,exec:o,format:u});try{f=new Image;f.setAttribute("data-id",l);f.onload=function(){Tr(f)};f.onerror=function(){Sr(f)};f.src=s}catch(h){return rn(r+"Error loading "+s+" ["+h.message+"]",h)}return l},imageBlit:function(e,t,n,r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U;i="[PS.imageBlit] ";s=arguments.length;if(s<3){return sn(i+"Missing argument(s)")}if(s>4){return sn(i+"Too many arguments")}o=X.x;u=X.y;a=e;f=t;l=n;c=r;if(Nr(i,a)===PS.ERROR){return PS.ERROR}h=a.width;p=a.height;d=a.pixelSize;v=a.data;m=Dt(f);if(m==="undefined"||f===PS.DEFAULT){f=0}else if(m==="number"){f=Math.floor(f)}else{return sn(i+"xpos argument invalid")}m=Dt(l);if(m==="undefined"||l===PS.DEFAULT){l=0}else if(m==="number"){l=Math.floor(l)}else{return sn(i+"ypos argument invalid")}if(f>=o||l>=u||f+h<1||l+p<1){return false}m=Dt(c);if(m==="undefined"||c===PS.DEFAULT){g=0;y=0;b=h;w=p}else if(m==="object"){y=c.left;m=Dt(y);if(m==="undefined"||y===PS.DEFAULT){y=0}else{if(m!=="number"){return sn(i+"region.left invalid")}y=Math.floor(y);if(y<0){y=0}else if(y>=h){return sn(i+"region.left outside image")}}g=c.top;m=Dt(g);if(m==="undefined"||g===PS.DEFAULT){g=0}else{if(m!=="number"){return sn(i+"region.top invalid")}g=Math.floor(g);if(g<0){g=0}else if(g>=p){return sn(i+"region.top outside image")}}b=c.width;m=Dt(b);if(m==="undefined"||b===PS.DEFAULT){b=h-y}else{if(m!=="number"){return sn(i+"region.width invalid")}b=Math.floor(b);if(b<1){return false}if(y+b>h){b=h-y}}if(f+b<1){return false}w=c.height;m=Dt(w);if(m==="undefined"||w===PS.DEFAULT){w=p-g}else{if(m!=="number"){return sn(i+"region.height invalid")}w=Math.floor(w);if(w<1){return false}if(g+w>p){w=p-g}}if(l+w<1){return false}}else{return sn(i+"region argument invalid")}if(f<0){b+=f;if(b<1){return false}y-=f;f=0}S=f+b;if(S>o){b=o-f}if(b<1){return false}if(l<0){w+=l;if(w<1){return false}g-=l;l=0}S=l+w;if(S>u){w=u-l}if(w<1){return false}x=h*d;U=false;H=255;E=X.plane;C=g*x+y*d;A=l;for(O=0;O<w;O+=1){k=C;L=f;for(M=0;M<b;M+=1){I=L+A*o;q=V[I];if(q.active){U=true;if(d<3){B=v[k];_=B/T;_=Math.floor(_);j=_*T;D=(B-j)/N;D=Math.floor(D);F=D*N;P=B-j-F;if(d===2){H=v[k+1]}}else{_=v[k];D=v[k+1];P=v[k+2];B=_*T+D*N+P;if(d===4){H=v[k+3]}}R=xn(q,E);R.r=_;R.g=D;R.b=P;R.a=H;R.rgb=B;mn(q)}L+=1;k+=d}A+=1;C+=x}if(U){Qt()}return true},imageCapture:function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,b,w,E,S,x,T,N;n="[PS.imageCapture] ";r=arguments.length;if(r>2){return sn(n+"Too many arguments")}i=e;s=t;o=Dt(i);if(o==="undefined"||i===PS.DEFAULT){i=3}else{if(o!=="number"){return sn(n+"format argument invalid")}i=Math.floor(i);if(i<1&&i>4){return sn(n+"format argument is not 1, 2, 3 or 4")}}u=X.x;a=X.y;o=Dt(s);if(o==="undefined"||s===PS.DEFAULT){l=0;c=0;h=u;p=a}else if(o==="object"){c=s.left;o=Dt(c);if(o==="undefined"||c===PS.DEFAULT){c=0}else{if(o!=="number"){return sn(n+"region.left not a number")}c=Math.floor(c);if(c<0){c=0}else if(c>=u){return sn(n+"region.left outside grid")}}l=s.top;o=Dt(l);if(o==="undefined"||l===PS.DEFAULT){l=0}else{if(o!=="number"){return sn(n+"region.top not a number")}l=Math.floor(l);if(l<0){l=0}else if(l>=a){return sn(n+"region.top outside grid")}}h=s.width;o=Dt(h);if(o==="undefined"||h===PS.DEFAULT){h=u-c}else{if(o!=="number"){return sn(n+"region.width not a number")}h=Math.floor(h);if(h<1||c+h>u){h=u-c}}p=s.height;o=Dt(p);if(o==="undefined"||p===PS.DEFAULT){p=a-l}else{if(o!=="number"){return sn(n+"region.height not a number")}p=Math.floor(p);if(p<1||l+p>a){p=a-l}}}else{return sn(n+"region argument invalid")}b=y+G;G+=1;v={source:PS.GRID,id:b,width:h,height:p,pixelSize:i,valid:true,data:[]};d=h*p;if(d<1){return v}f=v.data;f.length=d*i;m=c+h;g=l+p;w=0;for(S=l;S<g;S+=1){for(E=c;E<m;E+=1){x=E+S*u;T=V[x];N=T.color;if(i<3){f[w]=N.rgb;if(i===2){f[w+1]=N.a}}else{f[w]=N.r;f[w+1]=N.g;f[w+2]=N.b;if(i===4){f[w+3]=N.a}}w+=i}}return v},imageDump:function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,C,k,L,A,O,M,_,D,P,H,B,j,F;s="[PS.imageDump] ";o=arguments.length;if(o<1){return sn(s+"Missing argument(s)")}if(o>5){return sn(s+"Too many arguments")}u=e;a=t;f=n;l=r;if(Nr(s,u)===PS.ERROR){return PS.ERROR}h=u.width;p=u.height;d=u.pixelSize;v=u.data;m=Dt(a);if(m==="undefined"||a===PS.DEFAULT){g=0;y=0;b=h;w=p}else if(m==="object"){y=a.left;m=Dt(y);if(m==="undefined"||y===PS.DEFAULT){y=0}else{if(m!=="number"){return sn(s+"region.left invalid")}y=Math.floor(y);if(y<0){y=0}else if(y>=h){return sn(s+"region.left outside grid")}}g=a.top;m=Dt(g);if(m==="undefined"||g===PS.DEFAULT){g=0}else{if(m!=="number"){return sn(s+"region.top invalid")}g=Math.floor(g);if(g<0){g=0}else if(g>=p){return sn(s+"region.top outside grid")}}b=a.width;m=Dt(b);if(m==="undefined"||b===PS.DEFAULT){b=h-y}else{if(m!=="number"){return sn(s+"region.width invalid")}b=Math.floor(b);if(b<1||y+b>h){b=h-y}}w=a.height;m=Dt(w);if(m==="undefined"||w===PS.DEFAULT){w=p-g}else{if(m!=="number"){return sn(s+"region.height invalid")}w=Math.floor(w);if(w<1||g+w>p){w=p-g}}}else{return sn(s+"region argument invalid")}E=b*w;m=Dt(f);if(m==="undefined"||f===PS.DEFAULT){f=d}else{if(m!=="number"){return sn(s+"format argument invalid")}f=Math.floor(f);if(f<1||f>4){return sn(s+"format argument is not 1, 2, 3 or 4")}}m=Dt(l);if(m==="undefined"||l===PS.DEFAULT){l=b}else{if(m!=="number"){return sn(s+"length argument invalid")}l=Math.floor(l);if(l<1){l=1}if(l>E){l=E}}c=Pt(i,PS.ERROR,true,true);if(c===PS.ERROR){return sn(s+"hex argument invalid")}S="\nvar myImage = {\n	width : "+b+", height : "+w+", pixelSize : "+f+",\n	data : [";if(E<1){S+="]\n};\n";PS.debug(S);return PS.DONE}S+="\n	";L=255;k=C=0;x=h*d;A=g*x+y*d;for(M=0;M<w;M+=1){O=A;for(_=0;_<b;_+=1){if(d<3){B=v[O];if(B<1){D=P=H=0}else if(B>=16777215){D=P=H=255}else{D=B/T;D=Math.floor(D);j=D*T;P=(B-j)/N;P=Math.floor(P);F=P*N;H=B-j-F}if(d===2){L=v[O+1]}}else{D=v[O];P=v[O+1];H=v[O+2];B=D*T+P*N+H;if(d===4){L=v[O+3]}}S+=kr(f,c,B,D,P,H,L);k+=1;if(k<E){S+=",";C+=1;if(C<l){S+=" "}else{C=0;S+="\n	"}}O+=d}A+=x}S+="\n	]\n};\n";PS.debug(S);return PS.DONE},spriteSolid:function(e,t){var n,r,i,s,o;n="[PS.spriteSolid] ";r=arguments.length;if(r<2){return sn(n+"Missing argument(s)")}if(r>2){return sn(n+"Too many argument(s)")}i=e;s=t;if(i===PS.DEFAULT){i=1}else if(Dt(i)==="number"){i=Math.floor(i);if(i<1){i=1}}else{return sn(n+"width argument invalid")}if(s===PS.DEFAULT){s=1}else if(Dt(s)==="number"){s=Math.floor(s);if(s<1){s=1}}else{return sn(n+"height argument invalid")}o=Lr();o.width=i;o.height=s;o.color={rgb:0,r:0,g:0,b:0,a:255};return o.id},spriteSolidColor:function(e,t,n,r){var i,s,o,u,a,f,l,c,h;i="[PS.spriteSolidColor] ";s=arguments.length;if(s<1){return sn(i+"Missing argument(s)")}if(s>4){return sn(i+"Too many argument(s)")}o=Ar(e,i);if(o===PS.ERROR){return PS.ERROR}a=o.color;if(!a){return sn(i+"Cannot set color of image sprite "+o.id)}u=wn(i,t,n,r);if(u===PS.ERROR){return PS.ERROR}f=u.rgb;if(f!==PS.CURRENT){if(f===null){l=u.r;if(l===PS.CURRENT){u.r=l=a.r}else if(l===PS.DEFAULT){u.r=l=0}c=u.g;if(c===PS.CURRENT){u.g=c=a.g}else if(c===PS.DEFAULT){u.g=c=0}h=u.b;if(h===PS.CURRENT){u.b=h=a.b}else if(h===PS.DEFAULT){u.b=h=0}u.rgb=f=l*T+c*N+h}else if(f===PS.DEFAULT){u.rgb=f=0;u.r=0;u.g=0;u.b=0}if(a.rgb!==f){a.rgb=f;a.r=u.r;a.g=u.g;a.b=u.b;if(o.visible&&o.placed){Mr(o);Qt()}}}return a.rgb},spriteSolidAlpha:function(e,t){var n,r,i,s,o,u,a;n="[PS.spriteSolidAlpha] ";r=arguments.length;if(r<1){return sn(n+"Missing argument(s)")}if(r>2){return sn(n+"Too many argument(s)")}i=e;s=t;o=Ar(i,n);if(o===PS.ERROR){return PS.ERROR}u=o.color;if(!u){return sn(n+"Cannot set alpha of image sprite "+o.id)}a=Dt(s);if(a!=="undefined"&&s!==PS.CURRENT){if(s===PS.DEFAULT){s=255}else if(a==="number"){s=Math.floor(s);if(s<0){s=0}else if(s>255){s=255}}else{return sn(n+"alpha argument invalid")}if(u.a!==s){u.a=s;if(o.visible&&o.placed){Mr(o);Qt()}}}return u.a},spriteImage:function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,b,w,E,S,x,C,k,L,A,O;n="[PS.spriteImage] ";r=arguments.length;if(r<1){return sn(n+"Missing argument(s)")}if(r>2){return sn(n+"Too many argument(s)")}if(Nr(n,e)===PS.ERROR){return PS.ERROR}l=f=0;c=i=e.width;h=s=e.height;o=e.pixelSize;u=e.data;a=Dt(t);if(a!=="undefined"&&t!==PS.DEFAULT){if(a!=="object"){return sn(n+"region argument invalid")}l=t.left;a=Dt(l);if(a==="undefined"||l===PS.DEFAULT){l=0}else{if(a!=="number"){return sn(n+"region.left invalid")}l=Math.floor(l);if(l<0){l=0}else if(l>=i){return sn(n+"region.left outside image")}}f=t.top;a=Dt(f);if(a==="undefined"||f===PS.DEFAULT){f=0}else{if(a!=="number"){return sn(n+"region.top invalid")}f=Math.floor(f);if(f<0){f=0}else if(f>=s){return sn(n+"region.top outside image")}}c=t.width;a=Dt(c);if(a==="undefined"||c===PS.DEFAULT){c=i-l}else{if(a!=="number"){return sn(n+"region.width invalid")}c=Math.floor(c);if(c<1||l+c>i){c=i-l}}h=t.height;a=Dt(h);if(a==="undefined"||h===PS.DEFAULT){h=s-f}else{if(a!=="number"){return sn(n+"region.height invalid")}h=Math.floor(h);if(h<1||f+h>s){h=s-f}}}p=[];p.length=c*h*4;k=255;d=i*o;v=f*d+l*o;w=0;for(b=0;b<h;b+=1){m=v;for(g=0;g<c;g+=1){if(o<3){E=u[m];if(E<1){E=S=x=C=0}else if(E>=16777215){E=16777215;S=x=C=255}else{S=E/T;S=Math.floor(S);L=S*T;x=(E-L)/N;x=Math.floor(x);A=x*N;C=E-L-A}if(o===2){k=u[m+1]}}else{S=u[m];x=u[m+1];C=u[m+2];if(o===4){k=u[m+3]}}p[w]=S;p[w+1]=x;p[w+2]=C;p[w+3]=k;m+=o;w+=4}v+=d}O=Lr();O.width=c;O.height=h;O.image={id:y+G,width:c,height:h,pixelSize:4,data:p};G+=1;return O.id},spriteShow:function(e,t){var n,r,i,s,o;n="[PS.spriteShow] ";r=arguments.length;if(r<1){return sn(n+"Missing argument(s)")}if(r>2){return sn(n+"Too many argument(s)")}i=e;o=Ar(i,n);if(o===PS.ERROR){return PS.ERROR}s=Pt(t,PS.CURRENT,true,PS.CURRENT);if(s===PS.ERROR){return sn(n+"show argument invalid")}if(s!==PS.CURRENT){if(o.visible!==s){o.visible=s;if(o.placed){if(s){Mr(o);_r(o,i)}else{Or(o)}Qt()}}}return o.visible},spriteAxis:function(e,t,n){var r,i,s,o,u,a,f;r="[PS.spriteAxis] ";i=arguments.length;if(i<1){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many argument(s)")}s=e;o=t;u=n;a=Ar(s,r);if(a===PS.ERROR){return PS.ERROR}f=Dt(o);if(f==="undefined"||o===PS.CURRENT){o=a.ax}else if(o===PS.DEFAULT){o=0}else if(f==="number"){o=Math.floor(o)}else{return sn(r+"x argument invalid")}f=Dt(u);if(f==="undefined"||u===PS.CURRENT){u=a.ay}else if(u===PS.DEFAULT){u=0}else if(f==="number"){u=Math.floor(u)}else{return sn(r+"y argument invalid")}if(o!==a.ax||u!==a.ay){a.ax=o;a.ay=u;if(a.visible&&a.placed){Mr(a);_r(a,s);Qt()}}return{x:a.ax,y:a.ay}},spritePlane:function(e,t){var n,r,i,s,o,u;n="[PS.spritePlane] ";r=arguments.length;if(r<1){return sn(n+"Missing argument(s)")}if(r>2){return sn(n+"Too many arguments")}i=e;s=t;o=Ar(i,n);if(o===PS.ERROR){return PS.ERROR}u=Dt(s);if(u!=="undefined"&&s!==PS.CURRENT){if(s===PS.DEFAULT){s=0}else if(u==="number"){s=Math.floor(s);if(s<1){s=0}}else{return sn(n+"plane argument invalid")}if(o.plane!==s){if(o.visible&&o.placed){Or(o)}o.plane=s;if(o.visible&&o.placed){Mr(o);Qt()}}}if(o.plane<0){return 0}return o.plane},spriteMove:function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;r="[PS.spriteMove] ";i=arguments.length;if(i<1){return sn(r+"Missing argument(s)")}if(i>3){return sn(r+"Too many argument(s)")}s=e;o=t;u=n;a=Ar(s,r);if(a===PS.ERROR){return PS.ERROR}f=Dt(o);if(f==="undefined"||o===PS.CURRENT){o=a.x}else if(o===PS.DEFAULT){o=0}else if(f==="number"){o=Math.floor(o)}else{return sn(r+"x argument invalid")}f=Dt(u);if(f==="undefined"||u===PS.CURRENT){u=a.y}else if(u===PS.DEFAULT){u=0}else if(f==="number"){u=Math.floor(u)}else{return sn(r+"y argument invalid")}if(!a.placed||o!==a.x||u!==a.y){y=false;if(a.plane<0){a.plane=X.plane}if(a.visible&&a.placed){c=a.y;p=a.height;if(o>a.x){h=o-a.x;l=a.x}else if(a.x>o){h=a.x-o;l=a.x+a.width-h}else{h=0}if(h>=a.width){y=true;Or(a)}else{d=a.x;m=a.width;if(u>a.y){g=u-a.y;v=a.y}else if(a.y>u){g=a.y-u;v=a.y+a.height-g}else{g=0}if(g>=a.height){y=true;Or(a)}else if(g<1){y=true;Or(a,l,c,h,p)}else if(m<1){y=true;Or(a,d,v,m,g)}else{y=true;m-=h;if(o>a.x){d+=h}Or(a,l,c,h,p);Or(a,d,v,m,g)}}}a.x=o;a.y=u;a.placed=true;if(a.visible){y=true;Mr(a);_r(a,s)}if(y){Qt()}}return{x:a.x,y:a.y}},spriteCollide:function(e,t){var n,r,i,s,o;n="[PS.spriteCollide] ";r=arguments.length;if(r<1){return sn(n+"Missing argument(s)")}if(r>2){return sn(n+"Too many arguments")}i=Ar(e,n);if(i===PS.ERROR){return PS.ERROR}s=t;o=Dt(s);if(o!=="undefined"&&s!==PS.CURRENT){if(s===PS.DEFAULT){s=null}else if(o!=="function"){return sn(n+"exec argument not a function")}if(i.collide!==s){i.collide=s;if(s&&i.visible&&i.placed){_r(i,e)}}}return i.collide},spriteDelete:function(e){var t,n,r,i,s;t="[PS.spriteDelete] ";n=arguments.length;if(n<1){return sn(t+"Missing argument")}if(n>1){return sn(t+"Too many arguments")}if(typeof e!=="string"||e.length<1){return sn(t+"sprite argument invalid")}r=Y.length;for(i=0;i<r;i+=1){s=Y[i];if(s.id===e){Or(s);Y.splice(i,1);Qt();return PS.DONE}}return sn(t+"sprite id '"+e+"' not found")},audioLoad:function(e,t){var n,r;n="[PS.audioLoad] ";if(arguments.length<1){return sn(n+"Missing argument(s)")}if(arguments.length>2){return sn(n+"Too many arguments")}r=AQ.load(e,t);if(r===AQ.ERROR){return PS.ERROR}return r.channel},audioPlay:function(e,t){var n,r,i,s,o,u;n="[PS.audioPlay] ";r=arguments.length;if(r<1){return sn(n+"Missing argument(s)")}if(r>2){return sn(n+"Too many arguments")}i=e;s=t;o=Dt(s);if(o==="undefined"){s={}}else if(o!=="object"){return sn(n+"params argument invalid")}s.autoplay=true;u=AQ.load(i,s);if(u===AQ.ERROR){return PS.ERROR}return u.channel},audioPause:function(e){var t,n,r;t="[PS.audioPause] ";n=arguments.length;if(n<1){return sn(t+"Missing argument(s)")}if(n>1){return sn(t+"Too many arguments")}r=AQ.pause(e);if(r===AQ.ERROR){return PS.ERROR}return r},audioStop:function(e){var t,n,r;t="[PS.audioStop] ";n=arguments.length;if(n<1){return sn(t+"Missing argument(s)")}if(n>1){return sn(t+"Too many arguments")}r=AQ.stop(e);if(r===AQ.ERROR){return PS.ERROR}if(r===AQ.DONE){return PS.DONE}return r},piano:function(e,t){var n,r,i,s,o,u;n="[PS.piano] ";r=H.length;s=e;i=Dt(s);if(i!=="number"){return sn(n+"index argument invalid")}s=Math.floor(s);if(s<1){s=1}else if(s>r){s=r}o=t;if(o!==true&&o!==false){i=Dt(o);if(i==="undefined"){o=false}else if(i!=="number"){return sn(n+"flag argument invalid")}}u="piano_"+H[s-1];if(o){u="l_"+u}return u},harpsichord:function(e,t){var n,r,i,s,o,u;n="[PS.harpsichord] ";r=B.length;s=e;i=Dt(s);if(i!=="number"){return sn(n+"index argument invalid")}s=Math.floor(s);if(s<1){s=1}else if(s>r){s=r}o=t;if(o!==true&&o!==false){i=Dt(o);if(i==="undefined"){o=false}else if(i!=="number"){return sn(n+"flag argument invalid")}}u="hchord_"+B[s-1];if(o){u="l_"+u}return u},xylophone:function(e){var t,n,r,i,s;t="[PS.xylophone] ";n=j.length;i=e;r=Dt(i);if(r!=="number"){return sn(t+"index argument invalid")}i=Math.floor(i);if(i<1){i=1}else if(i>n){i=n}s="xylo_"+j[i-1];return s},debug:function(e){var t,n,r,i;t="[PS.debug] ";if(arguments.length>1){return sn(t+"Too many arguments")}n=e;r=Dt(n);if(r==="undefined"){n=""}else if(r!=="string"){n=n.toString()}Gt();if(n.length>0){i=document.getElementById(l);i.value+=n;i.scrollTop=i.scrollHeight}on();return PS.DONE},debugClose:function(){var e,t;e="[PS.debugClose] ";if(arguments.length>0){return sn(e+"Too many arguments")}t=document.getElementById(n);t.style.display="none";xt=false;return PS.DONE},debugClear:function(){var e,t;e="[PS.debugClear] ";if(arguments.length>0){return sn(e+"Too many arguments")}t=document.getElementById(l);t.value="";return PS.DONE},line:function(e,t,n,r){var i,s,o,u,a,f,l;i="[PS.line] ";s=arguments.length;if(s<4){return sn(i+"Missing argument(s)")}if(s>4){return sn(i+"Too many arguments")}o=e;u=t;a=n;f=r;if(Dt(o)==="number"){o=Math.floor(o)}else{return sn(i+"x1 argument not a number")}if(Dt(u)==="number"){u=Math.floor(u)}else{return sn(i+"y1 argument not a number")}if(Dt(a)==="number"){a=Math.floor(a)}else{return sn(i+"x2 argument not a number")}if(Dt(f)==="number"){f=Math.floor(f)}else{return sn(i+"y2 argument not a number")}l=Pr(o,u,a,f);return l},pathMap:function(e){var t,n,r;t="[PS.pathMap] ";n=arguments.length;if(n<1){return sn(t+"Missing argument(s)")}if(n>1){return sn(t+"Too many arguments")}if(Nr(t,e)===PS.ERROR){return PS.ERROR}if(e.pixelSize!==1){return sn(t+"image is not format 1")}r=Rr(e.width,e.height,e.data);return r.id},pathFind:function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y,b;o="[PS.pathFind] ";u=arguments.length;if(u<5){return sn(o+"Missing argument(s)")}if(u>6){return sn(o+"Too many arguments")}a=e;f=t;l=n;c=r;h=i;p=s;if(typeof a!=="string"||a.length<1){return sn(o+"pathmap argument invalid")}d=Ur(a);if(!d){return sn(o+a+" not found")}if(Dt(f)==="number"){f=Math.floor(f);if(f<0||f>=d.width){return sn(o+"x1 argument is outside "+a)}}else{return sn(o+"x1 argument not a number")}if(Dt(l)==="number"){l=Math.floor(l);if(l<0||l>=d.height){return sn(o+"y1 argument is outside "+a)}}else{return sn(o+"y1 argument not a number")}if(Dt(c)==="number"){c=Math.floor(c);if(c<0||c>=d.width){return sn(o+"x2 argument is outside "+a)}}else{return sn(o+"x2 argument not a number")}if(Dt(h)==="number"){h=Math.floor(h);if(h<0||h>=d.height){return sn(o+"y2 argument is outside "+a)}}else{return sn(o+"y2 argument not a number")}y=false;b=false;v=Dt(p);if(v!=="undefined"&&p!==PS.DEFAULT){if(v!=="object"){return sn(o+"options argument invalid")}g=p.no_diagonals;if(g===true||g===false){y=g}else{v=Dt(g);if(v==="undefined"||g===PS.DEFAULT){y=false}else if(v==="number"){y=g!==0}else{return sn(o+"options.no_diagonals invalid")}}g=p.cut_corners;if(g===true||g===false){b=g}else{v=Dt(g);if(v==="undefined"||g===PS.DEFAULT){b=false}else if(v==="number"){b=g!==0}else{return sn(o+"options.cut_corners invalid")}}}m=Ir(d,f,l,c,h,y,b);return m},pathData:function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m,g;o="[PS.pathData] ";u=arguments.length;if(u<5){return sn(o+"Missing argument(s)")}if(u>6){return sn(o+"Too many arguments")}a=e;f=t;l=n;c=r;h=i;p=s;if(typeof a!=="string"||a.length<1){return sn(o+"pathmap argument invalid")}d=Ur(a);if(!d){return sn(o+a+" not found")}if(Dt(f)==="number"){f=Math.floor(f);if(f<0||f>=d.width){return sn(o+"left argument is outside "+a)}}else{return sn(o+"left argument not a number")}if(Dt(l)==="number"){l=Math.floor(l);if(l<0||l>=d.height){return sn(o+"top argument is outside "+a)}}else{return sn(o+"top argument not a number")}if(c===PS.DEFAULT){c=1}else if(Dt(c)==="number"){c=Math.floor(c);if(c<1){c=1}else{v=d.width-f;if(c>v){c=v}}}else{return sn(o+"width argument not a number")}if(h===PS.DEFAULT){h=1}else if(Dt(h)==="number"){h=Math.floor(h);if(h<1){h=1}else{v=d.height-l;if(h>v){h=v}}}else{return sn(o+"height argument not a number")}if(p!==PS.DEFAULT&&p!==PS.CURRENT){m=Dt(p);if(m==="undefined"){p=PS.CURRENT}else if(m==="number"){if(p<0){return sn(o+"data argument < 0")}}else{return sn(o+"data argument not a number")}}g=qr(d,f,l,c,h,p);return g},pathDelete:function(e){var t,n;t="[PS.pathDelete] ";n=arguments.length;if(n<1){return sn(t+"Missing argument")}if(typeof e!=="string"||e.length<1){return sn(t+"pathmap argument invalid")}if(!zr(e)){return sn(t+e+" not found")}return PS.DONE},pathNear:function(e,t,n,r,i){var s,o,u,a;s="[PS.pathNear] ";o=arguments.length;if(o<5){return sn(s+"Missing argument(s)")}if(o>5){return sn(s+"Too many arguments")}if(typeof e!=="string"||e.length<1){return sn(s+"pathmap argument invalid")}u=Ur(e);if(!u){return sn(s+e+" not found")}a=Wr(u,t,n,r,i);return a}}})();(function(){"use strict";var e,t,n,r;e=0;t=["webkit","moz","ms","o"];for(n=0;n<t.length&&!window.requestAnimationFrame;n+=1){r=t[n];window.requestAnimationFrame=window[r+"RequestAnimationFrame"];window.cancelAnimationFrame=window[r+"CancelAnimationFrame"]||window[r+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(t,n){var r,i,s;r=(new Date).getTime();i=Math.max(0,16-(r-e));s=window.setTimeout(function(){t(r+i)},i);e=r+i;return s}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(e){window.clearTimeout(e)}}})()
>>>>>>> 7490021fcb708c88b9ec2da64f0a3b23e56dc7b7
